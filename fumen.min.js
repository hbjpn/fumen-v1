var Fumen=function(){function e(e,t,r,n){return"M"+e+","+t+" L"+r+","+n}function t(e,t){for(var r="M",n=0;n<e.length;++n)r+=e[n][0]+","+e[n][1],n<e.length-1&&(r+=" L");return t===!0&&(r+="Z"),r}function r(e){var t="M ";t+=e[0][0]+" "+e[0][1],t+=" C";for(var r=1;r<e.length;++r)t+=e[r][0]+" "+e[r][1]+" ";return t}function n(e,t,r,n,a,s,o){var i=e.text(t,r,n).attr("font-size",a);o&&i.attr("font-family",o);var l=i.getBBox().width,h=i.getBBox().height;return("l"==s[0]||"r"==s[0])&&i.attr("x",i.attr("x")+l/2*("l"==s[0]?1:-1)),("t"==s[1]||"b"==s[1])&&i.attr("y",i.attr("y")+h/2*("t"==s[1]?1:-1)),i}function a(e,t,r,a,s){var o=e.set(),i=n(e,t,r,a,s,"lt"),l=i.getBBox().width,h=i.getBBox().height,u=0*h,p=.1*h,c=e.rect(t,r,l+2*p,h+2*u);return i.attr("x",i.attr("x")+p),i.attr("y",i.attr("y")+u),o.push(i,c),o}function s(e){return jQuery.extend({},e)}function i(e){return jQuery.extend(!0,{},e)}function l(){this.task_queue={}}function h(e,t,r,n){void 0===r&&(r=null),this.task_type=r,this.context=e,this.worker=t,this.promise=null,this.resolve=null,this.reject=null;var a=this;this.promise=new Promise(function(e,t){a.resolve=e,a.reject=t}),n=void 0===n?null:n,this.queue=n?n:ce,this.queue.enqueue(this)}function u(){this.reharsal_groups=new Array,this.macros={}}function p(){this.name=null,this.measures=new Array,this.macros={}}function c(){this.elements=new Array,this.boundary_info=["n","n"],this.header_width=0,this.body_width=0,this.footer_width=0,this.body_scaling=1,this.new_line=!1,this.renderprop={}}function f(e,t){var r=fe/e;this.length_s=""+e+(t?t:""),this.length=fe/e;for(var n=t?t:"",a=0;a<n.length;++a)r/=2,this.length+=r;this.renderprop={}}function d(e){for(var t=[],r=[];e.length>0;){if(m=e.match(de),null===m)return console.log("Invalid code notation : "+e),null;for(var n=0;n<Re.length;++n)if(void 0!==m[me+Re[n]]&&null!==m[me+Re[n]]){t.push({cs:Re[n],s:m[0],g:m});break}e=e.substr(m[0].length)}for(var a=!1,n=0;n<t.length;++n)switch(t[n].cs){case xe:var e=t[n].s,s="M"==e||"maj"==e.toLowerCase()||"ma"==e.toLowerCase();0==s&&(a=!0),a&&1==s?t[n+1].cs==ke&&(r.push({type:"M",param:t[n+1].s}),++n):s?r.push({type:"M"}):r.push({type:"m"});break;case ke:r.push({type:"dig",param:t[n].s});break;case ge:r.push({type:"sus",param:t[n].s.substr(3)});break;case be:r.push({type:"dim"});break;case ye:r.push({type:"b",param:t[n].s.substr(1)});break;case we:r.push({type:"#",param:t[n].s.substr(1)});break;case _e:r.push({type:"add",param:t[n].s.substr(3)});break;case ve:r.push({type:"alt"})}return[t,r]}function g(e){this.chord_str=e,this.is_valid_chord=!0,this.length=fe,this.length_s=null,this.tie=!1,this.renderprop={};var t=/^(((A|B|C|D|E|F|G)(#|b)?([^\/\:]*))?(?:\/(A|B|C|D|E|F|G)(#|b)?)?)(:(\d+)(\.*))?(\~)?/,r=e.match(t);if(r&&""!=r[0]){if(this.chord_name_str=r[1],this.note_base=r[3],this.sharp_flat=r[4],this.mid_str=r[5],this.base_note_base=r[6],this.base_sharp_flat=r[7],this.mid_elems=null,void 0!==this.mid_str){var n=d(this.mid_str);null!==n&&(this.mid_elems=n[0],this.mid_elem_objs=n[1]),this.is_valid_chord=null!==n}if(r[8]){var a=r[10]?r[10]:"";this.length_s=r[9]+(r[10]?r[10]:""),this.length=fe/parseInt(r[9]);for(var s=fe/parseInt(r[9]),o=0;o<a.length;++o)s/=2,this.length+=s}this.tie="~"==r[11]}else this.chord_name_str=this.chord_str,this.is_valid_chord=!1}function _(e){this.indicators=e,this.intindicators=[];for(var t=new RegExp(/(\d+)/),r=0;r<this.indicators.length;++r)m=this.indicators[r].match(t),m&&this.intindicators.push(parseInt(m[0]))}function v(e,t){this.numer=e,this.denom=t}function b(){}function k(e){this.nline=e}function w(){}function y(e){this.times=e}function E(e){this.times=e}function R(){}function S(){}function B(e,t){this.number=e,this.al=t}function T(e,t){this.number=e,this.opt=t}function A(e){this.number=e}function I(e){this.number=e}function M(){}function P(e){this.context={line:0,"char":0},this.error_msg_callback=e}function C(e,t){for(var r=0;r<t.length;++r)if(t[r]==e)return{r:!0,index:r};return null}function F(e,t){for(var r=0;r<t.length;++r)if(0==e.indexOf(t[r]))return{index:r,s:t[r]};return null}function O(e,t,r){this.canvas=e,this.param={row_interval:70,y_title_offset:50,y_author_offset:90,y_first_page_offset:120,y_offset:70,x_offset:70,min_measure_width:100,row_height:24,row_margin:25,rs_area_height:24,rm_area_height:30,mh_area_height:25,max_scaling:1.2,paper_width:t,paper_height:r,repeat_mark_font:{"font-family":"Times New Roman","font-style":"italic","font-weight":"bold"}},this.track=null}function L(e,t){return e.rgi<t.rgi?!0:e.rgi>t.rgi?!1:e.mi<t.mi?!0:!1}function q(e,t){return e.rgi==t.rgi&&e.mi==t.mi}function N(e,t){return L(e,t)||q(e,t)}function D(e,t,r){this.sequence=[],this.hasValidStructure=!1,this.cb_play=void 0==t?null:t,this.cb_stop=void 0==r?null:r,this.lastloopstart={rg:null,m:null},this.segnos={};for(var n={rgi:0,mi:-1},a=function(t){return e.reharsal_groups[t.rgi].measures[t.mi]},s=function(t){for(;;){if(t.rgi>=e.reharsal_groups.length)return null;if(t.mi>=e.reharsal_groups[t.rgi].measures.length?(t.mi=0,t.rgi++):t.mi++,t.rgi<e.reharsal_groups.length&&t.mi<e.reharsal_groups[t.rgi].measures.length)return e.reharsal_groups[t.rgi].measures[t.mi]}},o=new v(4,4),l=0,h=s(n),u=h,p=i(n),c=null,f={},d={},m=null,g=1e3,b=0;h;){if(b++>g)throw"Error : Analyzing error : Infinite loop detected.";for(var k=!0,x=H(h),E=!1,R=0;R<x.measure_wide.length;++R){var P=x.measure_wide[R];if(P instanceof _){if(c){if(P.intindicators.indexOf(c.cnt)>=0)break;for(;h=s(n);)if(z(h,function(e){return e instanceof _&&e.intindicators.indexOf(c.cnt)>=0})){E=!0;break}break}throw"Invalid loop indicator detected"}}if(!E){for(var R=0;R<x.header.length;++R){var P=x.header[R];P instanceof w?c&&q(c.p,n)?c.cnt++:c={p:i(n),cnt:1}:P instanceof T?P.numnber in f||(f[P.number]={p:i(n)}):P instanceof A||P instanceof v&&(o=P)}var C={t:l,duration:o.numer/o.denom};this.sequence.push([C,h]),l+=C.duration,console.log("Push : "),console.log(h),console.log(C);for(var F=!1,R=0;R<x.footer.length;++R){var P=x.footer[R];if(P instanceof y){if(c.cnt<P.times){h=a(c.p),n=i(c.p),k=!1;break}c=null}else if(P instanceof B){if(!(P.number in f))throw"Segno not found";for(var O in d)L(d[O].p,n)&&N(f[P.number].p,d[O].p)&&(d[O].valid=!0);m&&L(m.p,n)&&N(p,m.p)&&(m.valid=!0),h=a(f[P.number].p),n=i(f[P.number].p),k=!1,c=null}else{if(P instanceof S){for(var O in d)L(d[O].p,n)&&N(p,d[O].p)&&(d[O].valid=!0);m&&L(m.p,n)&&N(p,m.p)&&(m.valid=!0),h=u,n=i(p),k=!1,c=null;break}if(P instanceof I){if(P.number in d&&d[P.number].valid){for(k=!1;(h=s(n))&&!z(h,function(e){return e instanceof A&&e.number==P.number}););break}d[P.number]={valid:!1,p:i(n)}}else P instanceof M&&(m?m.valid&&(F=!0):m={valid:!1,p:i(n)})}}if(F)break;k&&(h=s(n))}}}function H(e){for(var t=e,r=new Array,n=new Array,a=new Array,s=new Array,o=0;o<t.elements.length;++o){var i=t.elements[o];0==o?r.push(i):o==t.elements.length-1?a.push(i):i instanceof g?n.push(i):i instanceof f?n.push(i):i instanceof _?s.push(i):i instanceof v?r.push(i):i instanceof S?a.push(i):i instanceof B?a.push(i):i instanceof T?r.push(i):i instanceof A?r.push(i):i instanceof I?a.push(i):i instanceof M&&a.push(i)}return{header:r,body:n,footer:a,measure_wide:s}}function z(e,t){for(var r=e,n=0;n<r.elements.length;++n){var a=r.elements[n];if(t(a))return a}return null}function W(e,t,r){for(var n=0,a=null,s=null;null!==(a=t(n++))&&a<e.length;){var o=void 0!==r?r(e[a]):e[a];s=null===s?o:Math.max(o,s)}return s}function G(e,t){console.log("Identify scaling called");for(var r=t.paper_width-2*t.x_offset,n=0;n<e.reharsal_groups.length;++n){var a=e.reharsal_groups[n],s=0,o=new Array,i=new Array,l=!0,h=!0;if(l){for(var u=0,p=0;p<a.measures.length;++p){u=p+1;var c=a.measures[p];if(s+=c.header_width+c.body_width+c.footer_width,s>r){u--;break}}for(var f=a.measures.length,d=u,m=new Array,g=0;d>0;--d){for(var _=0;d>_;++_){var v=W(a.measures,function(e){return e*d+_},function(e){return e.header_width+e.body_width+e.footer_width});g+=v,m.push(v)}if(r>=g){if(!h)break;if(d%2==0||1==d||d==f)break}g=0,m=new Array}for(var b=r/g,p=0;p<a.measures.length;++p){var c=a.measures[p],k=Math.floor(p/d),w=p-k*d,y=m[w]*b-(c.header_width+c.footer_width);c.new_line=0==w&&k>0,c.body_scaling=y/c.body_width}}else{for(var p=0;p<a.measures.length;++p){var c=a.measures[p];i.push(c),s+=c.header_width+c.body_width+c.footer_width,s>r&&(o.push(i),i=new Array,s=0)}i.length>0&&o.push(i);for(var x=0;x<o.length;++x){for(var E=0,R=0,p=0;p<o[x].length;++p){var c=o[x][p];x>0&&0==p&&(c.new_line=!0),E+=c.header_width+c.body_width+c.footer_width,R+=c.header_width+c.footer_width}var S=r-R;if(0>=S)throw"ERROR";for(var B=S/(E-R),p=0;p<o[x].length;++p){var c=o[x][p];c.body_scaling=Math.min(t.max_scaling,B)}}}}}function j(e,t){var r=ue.length;$(e).append("<div id='page"+r+"'></div>");var a=$(e).children("#page"+r)[0];return paper=Raphael(a,t.paper_width,t.paper_height),ue.push(paper),paper.canvas.style.backgroundColor="#FFFFFF",n(paper,t.paper_width/2,t.paper_height-40,"Generated by fumen ver 0.1",12,"ct"),Qe={},paper}function U(e){if(null===e)return"n";if(e instanceof k){if(1==e.nline)return"s";if(2==e.nline)return"d"}else{if(e instanceof w)return"b";if(e instanceof y)return"e";if(e instanceof E)return"B";if(e instanceof R)return"f"}throw"Invalid boundary object"}function X(e,t){var r={ss:"s",sd:"d",sb:"b",sn:"s",ds:"d",dd:"d",db:"b",dn:"d",es:"e",ed:"e",ee:"e",eb:"B",en:"e",bb:"b",BB:"B",fn:"f",ns:"s",nd:"d",nb:"b"},n=U(e)+U(t);if(n in r)return r[n];throw"Invalid boundary pair : "+n}function Y(e,t,r){var n={ss:"ss",sd:"sd",sb:"sb",ds:"ds",dd:"dd",db:"db",es:"es",ed:"ed",ee:"es",eb:"eb",bb:"sb",BB:"eb"},a=U(e)+U(t);if(a in n)return n[a]["begin"==r?1:0];throw"Invalid boundary pair : "+a}function Q(t,r,a,s,o,i,l,h,u){var p=h.row_height,c=null,f=i;if("end"==t){var d=null===a||s;if(!d)return{x:i,bx:f}}switch(c=null===s||0==s?X(r,a):Y(r,a,t)){case"s":case"d":for(var m="s"==c?1:2,g=0;m>g;++g)u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),m>=2&&m-1>g&&(i+=3);f=i;break;case"b":u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=4,u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"});break;case"e":u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"}),i+=4,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),null!==r.times&&2!=r.times&&u&&(text=n(o,i,l+p+8,"(x"+r.times+")",13,"rc")),f=i;break;case"B":u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"}),i+=4,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),f=i,i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),null!==r.times&&2!=r.times&&u&&(text=n(o,i,l+p+8,"(x"+r.times+")",13,"rc")),i+=4,u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"});break;case"f":u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"});break;default:throw"Internal error"}return{x:i,bx:f}}function V(e,t,r,a,s,o,i,l,h,u,p){var c=i.row_height,f=e.getChordStr(t,r),d=n(a,s,o+c/2,f[1],16,"lc",f[0]?"icomoon":null);return s+=d.getBBox().width*u*p,s+=h*p,l||d.remove(),{x:s}}function J(e,t,a,s,o,i,l,h,u,p,c){var f="icomoon",d=l.row_height;if(e.renderprop.x=o,!e.is_valid_chord)return V(e,t,a,s,o,i,l,h,u,p,c);var m=[o,i];if(h&&e.chord_name_str in Qe){var g=Qe[e.chord_name_str],_=g[0].clone();_.attr({opacity:1});var v=g[1];return _.transform("T "+(m[0]-v[0])+" "+(m[1]-v[1])),o+=_.getBBox().width*p*c,o+=u*c,isFinite(o)||console.error("Illegal calculation of x detected"),{group:_,x:o}}var b=e.getChordStrBase(t,a),k=e.mid_elem_objs,_=s.set(),w=[],y=[],x=[],E=[];if(k){for(var R=!1,S=!1,B=0;B<k.length;++B){var T=k[B];switch(T.type){case"M":void 0!==T.param?x.push(T):w.push(T);break;case"m":w.push(T);break;case"add":x.push(T);break;case"sus":x.push(T);break;case"dig":x.push(T),R|="6"==T.param,S|="9"==T.param;break;case"b":case"#":"5"==T.param?y.push(T):E.push(T);break;case"dim":x.push(T);break;case"alt":E.push(T)}}if(R&&S)for(var B=0;B<x.length;++B)if("dig"==x[B].type&&"6"==x[B].param){y.push(x[B]),x.splice(B,1);break}}var A=null,I=o;b[0]&&(A=n(s,I,i+d/2,b[0],18,"lc",f),_.push(A),I+=A.getBBox().width);var M=0;if(w.length>0){for(var P=Je[w[0].type](w[0].param),C=0,B=0;B<P.length;++B)A=n(s,I+C,i+d/2+P[B][1]+Ve,P[B][2],P[B][0],"lt",f),_.push(A),C+=A.getBBox().width;M=C}var F=0;if(y.length>0){for(var P=tt[y[0].type](y[0].param),C=0,B=0;B<P.length;++B)A=n(s,I+C,i+d/2+P[B][1]+et,P[B][2],P[B][0],"lb",f),_.push(A),C+=A.getBBox().width;F=C}var O=M;if(x.length>0){for(var C=0,L=0;L<x.length;++L)for(var P=Ze[x[L].type](x[L].param),B=0;B<P.length;++B)""!=P[B][2]&&(A=n(s,I+M+C,i+d/2+P[B][1]+Ke,P[B][2],P[B][0],"lt",f),C+=A.getBBox().width,_.push(A));O+=C}I+=Math.max(F,O);for(var q=0,N=0,D=1e4,H=5,B=0;B<E.length;++B){for(var T=E[B],P=nt[T.type](T.param),z=0,W=0,$=0;$<P.length;++$)D=Math.min(D,i+N+P[$][1]+rt),A=n(s,I+H+z,i+N+P[$][1]+rt,P[$][2],P[$][0],"lt",f),_.push(A),z+=A.getBBox().width,W=Math.max(W,A.getBBox().height);N+=W+1,q=Math.max(q,z)}if(E.length>0){var G=[[I+H,D],[I,D],[I,D+N],[I+H,D+N]],j=s.path(r(G)).attr("stroke-width","1px"),U=[[I+H+q,D],[I+H+q+5,D],[I+H+q+5,D+N],[I+H+q,D+N]],X=s.path(r(U)).attr("stroke-width","1px");_.push(j),_.push(X),q+=2*H}if(I+=q,b[1]&&(A=n(s,I,i+d/2,"/",26,"lc"),_.push(A),I+=A.getBBox().width,A=n(s,I,i+d/2,b[1],18,"lc",f),_.push(A),I+=A.getBBox().width),o+=_.getBBox().width*p*c,o+=u*c,h||A.remove(),h){var Y=_.clone();Y.attr({opacity:0}),Qe[e.chord_name_str]=[Y,m]}return isFinite(o)||console.error("Illegal calculation of x detected"),{group:_,x:o}}function K(e,r,n,a,s,o){var i=10,l=10,h=4,u=t([[n,a],[n+i,a-l],[n+i,a-l+h],[n,a+h]],!0),p=null;p="1"==s||"2"==s?e.path(u).attr({"stroke-width":"1px"}):e.path(u).attr({fill:"#000000"}),r.push(p);for(var c=0;o>c;++c)r.push(e.circle(n+i+5+5*c,a-6,1).attr({fill:"black"}));return r}function Z(e,t){for(var r=[],n=[],a=null,s=0;s<e.length;++s)null!=a&&a!=t(e[s])&&(r.push(n),n=[]),a=t(e[s]),n.push(e[s]);return r.push(n),r}function ee(e,t,r,n,a,s,o){for(var i=r+s.row_height+10,l=e.set(),h=0;a>h;++h){var u=t+n/4*h;K(e,l,u,i,"0",0)}}function te(e){var t={1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7};return t[e]}function re(t,r,n,a,s,i,l){if(n.groups.length>=2){var h=n.groups[0].coord,u=n.groups[n.groups.length-1].coord,p=t.path(e(h[0],h[1],u[0],u[1])).attr({"stroke-width":l});r.push(p);for(var c=Z(n.groups,function(e){return e.onka}),f=0;f<c.length;++f){var d=c[f],m=d[0].onka,g=te(parseInt(m))-2;if(1==d.length){var _=d[0].coord,v=1;f==c.length-1&&(v=-1);for(var b=c[f+v][c[f+v].length-1].coord[0],k=.3*Math.abs(b-_[0]),w=0;g>w;++w)o=t.path(e(_[0],a+s-w*i,_[0]+v*k,a+s-w*i)).attr({"stroke-width":l}),r.push(o)}else if(d.length>=2)for(var _=d[0].coord,y=d[d.length-1].coord,w=0;g>w;++w)o=t.path(e(_[0],_[1]-w*i,y[0],y[1]-w*i)).attr({"stroke-width":l}),r.push(o)}}else if(1==n.groups.length)for(var h=n.groups[0].coord,m=n.groups[0].onka,g=te(parseInt(m))-2,w=0;g>w;++w)o=t.path("M"+(h[0]+10)+","+(a+s-10-w*i)+"L"+h[0]+","+(a+s-w*i)).attr({"stroke-width":"1px"}),r.push(o)}function ne(e,t,n,a,s,o,i,l,h,u){var p=n+o.row_height+10,c="4px";balken={groups:[],sum_len:0};for(var f=!1,d=t.set(),m=0;m<e.length;++m){var _=e[m],v=_.renderprop.x,b=20,k=5;if(null!==_.length_s&&void 0!==_.length_s){var w=_.length_s.match(/[0-9]+/)[0],y=_.length_s.substr(w.length);if(_ instanceof g)if(f=!0,"0"==w||"1"==w)K(t,d,v,p,w,y.length);else{K(t,d,v,p,w,y.length);var x=t.path("M"+v+","+p+"L"+v+","+(p+b)).attr({"stroke-width":"1px"});d.push(x)}if(u){var E=_.length>=fe/4||balken.sum_len%(fe/4)==0;E&&(re(t,d,balken,p,b,k,c),balken.groups=[]),balken.sum_len+=_.length,_.length<fe/4&&_ instanceof g&&balken.groups.push({coord:[_.renderprop.x,p+b],onka:w}),m==e.length-1&&re(t,d,balken,p,b,k,c)}if(_ instanceof g){if(st){var R=-10,S=12,B=8,T=at,A=[v,p,a,s];if(T[1]!=A[1]){var I=[[T[0]+S,T[1]+R],[T[0]+S,T[1]-B+R],[T[3]+20,T[1]-B+R],[T[3]+20,T[1]+R]];clip=T[0]+S+","+(T[1]-50)+","+(T[3]-(T[0]+S)+5)+",100",console.log("clip:"+clip);var M=ot.path(r(I)).attr("stroke-width","2px").attr({"clip-rect":clip});ot.set().push(M),I=[[A[2]-20,A[1]+R],[A[2]-20,A[1]-B+R],[A[0],A[1]-B+R],[A[0],A[1]+R]],clip=A[2]-5+","+(A[1]-50)+","+(A[0]-(A[2]-5))+",100",console.log("clip:"+clip),M=t.path(r(I)).attr("stroke-width","2px").attr({"clip-rect":clip}),d.push(M)}else{var I=[[T[0]+S,T[1]+R],[T[0]+S,T[1]-B+R],[A[0],A[1]-B+R],[A[0],A[1]+R]],M=t.path(r(I)).attr("stroke-width","2px");d.push(M)}}st=_.tie,at=[v,p,a,s],ot=t}}}return f?d:null}function ae(t,r,a,s,o,i,l,h,u,p,c){var d=n(t,0,0,"C7",16,"lc","icomoon"),m=d.getBBox().width;d.remove();var k=!1,w=!1;"ON"==c&&(k=!0);for(var y=0;y<o.length;++y)for(var E=o[y],R=0;R<E.elements.length;++R){var P=E.elements[R];P instanceof A||P instanceof T?w=!0:P instanceof g&&(k|=null!==P.length_s)}"OFF"==c&&(k=!1);for(var C=k?u.row_height+5:0,F=w?u.mh_area_height:0,O=h+F,L=[],q=x,N=x,y=0;y<o.length;++y){for(var E=o[y],D=x,z=x,W=x,$=H(E),G=0,j=!1,R=0;R<$.header.length;++R){var P=$.header[R];P instanceof A?(j=!0,p&&he(t,D,h,"lt",P)):P instanceof T&&(j=!0,p&&le(t,D,h+3,P))}j&&(G+=u.mh_area_height);for(var R=0;R<$.header.length;++R){var P=$.header[R];if(P instanceof b){var U=0==y?i:o[y-1],X=U?U.elements[U.elements.length-1]:null,Y=Q("begin",X,P,E.new_line,t,x,O+C,u,p);E.renderprop.y=O+C,E.renderprop.sx=x,E.renderprop.paper=t,x=Y.x,z=Y.bx}else if(P instanceof v){x+=4;var V=0,K=x,Z=n(t,K,O+C,P.numer,12,"lt","icomoon");V=Z.getBBox().width;var re=n(t,K,O+u.row_height/2+C,P.denom,12,"lt","icomoon");V=Math.max(V,re.getBBox().width),Z.attr({x:Z.attr("x")+(V-Z.getBBox().width)/2}),re.attr({x:re.attr("x")+(V-re.getBBox().width)/2});var ae=O+u.row_height/2;p&&!k&&t.path(e(K,ae,K+V,ae)).attr({"stroke-width":"1"}),x+=V}}x+=10,E.header_width=x-D;for(var se=x,oe=0,ie=!0,ue=0,pe=[],R=0;R<$.body.length;++R){var P=$.body[R];(P instanceof g||P instanceof f)&&(++oe,ie&=null!==P.length,ie&&(ue+=P.length),pe.push(P))}for(var ce=null,R=0;R<$.body.length;++R){var P=$.body[R],fe=0;if(fe=ie?Math.floor(40*r/ue*P.length):Math.floor(40*r/oe),P instanceof g){var d,de=J(P,a,s,t,x,O,u,p,fe,r,E.body_scaling);x=de.x,isFinite(x)||console.log("Illegal calculation of x is detected"),(it||ce==P.chord_name_str)&&de.group.remove(),it=P.tie,ce=P.chord_name_str}else{if(!(P instanceof f))throw"ERROR";var me={1:"",2:"",4:"",8:"",16:"",32:""},ge={1:0,2:0,4:0,8:0,16:7,32:7,64:14,128:14},_e=parseInt(P.length_s),ve=t.set(),be=ge[_e],ke=14;if(4>=_e){var d=n(t,x,O+u.row_height/2+C,me[_e],ke,"lc","icomoon");ve.push(d)}else for(var we=te(_e)-2,ye=2,xe=-7,Ee=0;we>Ee;++Ee){var d=n(t,x+Ee*ye,O+u.row_height/2+C+Ee*xe+be,"",ke,"lc","icomoon");ve.push(d)}x+=m*r*E.body_scaling,x+=fe*E.body_scaling,P.renderprop.x=x,p||ve.remove()}}0==$.body.length&&(x+=m*r*E.body_scaling,x+=40*r*E.body_scaling),E.body_width=x-se;for(var Re=x,R=0;R<$.footer.length;++R){var Se=k?"l":"r",P=$.footer[R];if(P instanceof b){var Be=y==o.length-1?l:o[y+1],X=Be?Be.elements[0]:null,Y=Q("end",P,X,Be?Be.new_line:!1,t,x,O+C,u,p);E.renderprop.ex=x,x=Y.x}else if(P instanceof S)d=n(t,x,O-8+C,P.toString(),15,Se+"c").attr(u.repeat_mark_font),k&&(x+=d.getBBox().width);else if(P instanceof B)d=n(t,x,O-8+C,P.toString(),15,Se+"c").attr(u.repeat_mark_font),k&&(x+=d.getBBox().width);else if(P instanceof I)if(k){var d=n(t,x,O+C,"To",15,"lb").attr(u.repeat_mark_font);x+=d.getBBox().width+5;var Te=he(t,x,O+C,"lb",P);x+=Te.getBBox().width}else{var Te=he(t,x,O+C,"rb",P);d=n(t,x-1.5*Te.getBBox().width,O+C,"To",15,"rb").attr(u.repeat_mark_font)}else{if(!(P instanceof M))throw"ERROR";d=n(t,x,O-8+C,P.toString(),15,Se+"c").attr(u.repeat_mark_font),k&&(x+=d.getBBox().width)}}E.footer_width=x-Re,W=x,N=W;for(var R=0;R<$.measure_wide.length;++R){var P=$.measure_wide[R];if(!(P instanceof _))throw"ERROR";var be=10,ae=O-2-be,Ae=z,Ie=W;p&&t.path(e(Ae,ae,Ae,ae+be)).attr({"stroke-width":"1"}),p&&t.path(e(Ae,ae,Ie,ae)).attr({"stroke-width":"1"});var Me=P.indicators.join(",");p&&n(t,Ae+2,ae,Me,10,"lt")}if(G+=u.row_height,k){var xe=10,Pe=ne(pe,t,O+xe,z,W,u,p,0,E.body_scaling,ie);G+=u.rs_area_height,Pe||ee(t,se,O+xe,E.body_width,4,u,E.body_scaling)}G+=u.row_margin,E.renderprop.meas_height=G,L.push(G)}if(k)for(var Ce=0;5>Ce;++Ce){var Fe=6,Oe=5;p&&t.path(e([[q,O+u.row_height+Ce*Fe+Oe],[N,O+u.row_height+Ce*Fe+Oe]])).attr({"stroke-width":"1px"})}return h+=Math.max.apply(null,L),{y_base:h}}function se(e){var t={};if(t.x_global_scale=1,"XSCALE"in e.macros&&(t.x_global_scale=parseFloat(e.macros.XSCALE)),t.transpose=0,"TRANSPOSE"in e.macros){var r=parseInt(e.macros.TRANSPOSE);isNaN(r)||(t.transpose=r)}return t.half_type="GUESS","HALF_TYPE"in e.macros&&(t.half_type=e.macros.HALF_TYPE),t.staff="AUTO","STAFF"in e.macros&&(t.staff=e.macros.STAFF),t}function oe(e,t){var r=$.extend(!0,{},e);if("XSCALE"in t.macros&&(r.x_global_scale=parseFloat(t.macros.XSCALE)),"TRANSPOSE"in t.macros){var n=parseInt(t.macros.TRANSPOSE);isNaN(n)||(r.transpose=n)}return"HALF_TYPE"in t.macros&&(r.half_type=t.macros.HALF_TYPE),"STAFF"in t.macros&&(r.staff=t.macros.STAFF),r}function ie(e,t,r,s,o,i){var l=!r;console.log("render_impl called with "+l);var u=s.y_title_offset,p=s.x_offset,c=s.paper_width-2*p,f=null;f=l?j(e,s):Raphael($("#invisible_view")[0],s.paper_width,s.paper_height);var d=s.y_first_page_offset,m="No Name";"TITLE"in t.macros&&(l&&n(f,p+c/2,u,t.macros.TITLE,24,"ct"),m=t.macros.TITLE),"ARTIST"in t.macros&&(l&&n(f,p+c,s.y_author_offset,t.macros.ARTIST,14,"rt"),m+="/"+t.macros.ARTIST);var g=se(t);console.log("render_impl called with "+l+" : Making pagination");var _=[];if(l){for(var v=[{type:"titles",height:s.y_first_page_offset}],b=0;b<t.reharsal_groups.length;++b){var k=oe(g,t.reharsal_groups[b]);console.group("Macro for "+t.reharsal_groups[b].name),console.log(k),console.groupEnd(),v.push({type:"reharsal",height:s.rm_area_height,cont:t.reharsal_groups[b]});for(var w=t.reharsal_groups[b],y=0,E=[],R=null,S=0;S<w.measures.length;++S){var B=w.measures[S];B.new_line&&(v.push({type:"meas",height:y,cont:E,nm:B,pm:R,rg:t.reharsal_groups[b],macros:k}),y=0,E=[],R=S>0?w.measures[S-1]:null),E.push(B),y=Math.max(y,B.renderprop.meas_height)}y>0&&v.push({type:"meas",height:y,cont:E,nm:null,pm:R,rg:t.reharsal_groups[b],macros:k})}for(var T=0,A=[],b=0;b<v.length;++b)T+v[b].height<=s.paper_height-s.y_offset?(T+=v[b].height,A.push(v[b])):(_.push(A),A=[v[b]],T=v[b].height);A.length>0&&_.push(A),console.log("////////"),console.log(_)}else{for(var v=[{type:"titles",height:p}],b=0;b<t.reharsal_groups.length;++b){var k=oe(g,t.reharsal_groups[b]);v.push({type:"reharsal",height:s.rm_area_height,cont:t.reharsal_groups[b]});var w=t.reharsal_groups[b];v.push({type:"meas",height:0,cont:w.measures,nm:null,pm:null,rg:t.reharsal_groups[b],macros:k})}_.push(v)}if(console.log("render_impl called with "+l+" : Invoke async loop execution"),o){h.Foreach(_,function(t,r,n,s){h.Foreach(n,function(e,r,n,s){if(i&&i((s.draw?"":"Pre-")+"Rendering block "+e+" in page "+(t+1)+" of "+m),"titles"==n.type);else if("reharsal"==n.type){x=p;var o=n.cont;if(s.draw){a(s.paper,x,s.y_base,o.name,18)}s.y_base+=s.param.rm_area_height}else if("meas"==n.type){x=p;var l=n.cont,h=ae(s.paper,n.macros.x_global_scale,n.macros.transpose,n.macros.half_type,l,n.pm,n.nm,s.y_base,s.param,s.draw,n.macros.staff);s.y_base=h.y_base}},s,"renderpageelemloop");var o=h.enqueueFunctionCall(function(){s.draw&&t!=_.length-1&&(s.paper=j(e,s.param),s.y_base=s.param.y_offset)},[],"renderpageelemloop");return o},{param:s,draw:l,paper:f,y_base:d},"renderpageloop");var I=h.enqueueFunctionCall(function(){l||$("#invisible_view").children().remove()},[],"renderpageloop");return I}for(var M=0;M<_.length;++M){for(var P=_[M],C=0;C<P.length;++C)if("titles"==P[C].type);else if("reharsal"==P[C].type){x=p;var w=P[C].cont;if(l){a(f,x,d,w.name,18)}d+=s.rm_area_height}else if("meas"==P[C].type){x=p;var F=P[C].cont,O=ae(f,P[C].macros.x_global_scale,P[C].macros.transpose,P[C].macros.half_type,F,P[C].pm,P[C].nm,d,s,l,P[C].macros.staff);d=O.y_base}l&&M!=_.length-1&&(f=j(e,s),d=s.y_offset)}l||$("#invisible_view").children().remove()}function le(e,t,r,a){var s=e,o=s.path("m 7.45119,0.00462507 c -2.62006,-0.12965 -4.89531,2.48917003 -4.5203,5.06077003 0.30852,2.3265 2.16735,4.12974 4.20376,5.1011599 1.65879,0.86938 3.71404,0.71264 5.22694,1.90481 1.39044,1.02552 1.92776,3.15917 0.89399,4.61515 -0.59006,0.8633 -1.60565,1.57525 -2.69669,1.40546 -0.51026,-0.79781 -0.0548,-1.84761 -0.5841,-2.65244 -0.50017,-0.97685 -1.7314,-1.52668 -2.77051,-1.09339 -1.09273,0.36861 -1.55201,1.78786 -0.96315,2.76184 0.95747,1.95409 3.44952,2.65453 5.45383,2.15374 2.52866,-0.60348 4.08162,-3.66205 3.0424,-6.05383 -0.87324,-2.27646 -3.05164,-3.8349199 -5.33435,-4.4943599 -1.63211,-0.39445 -3.53265,-0.67749 -4.56541,-2.16526 -0.96216,-1.25884 -0.91035,-3.20529 0.26205,-4.31632 0.58015,-0.61405 1.43392,-1.05559 2.29618,-0.91468 0.51027,0.79781 0.0548,1.84762 0.5841,2.65244 0.50017,0.97686 1.7314,1.52668 2.77051,1.09339 1.0378,-0.35178 1.53161,-1.67674 1.0195,-2.63799 C 11.07123,0.77410507 9.16303,-0.05833493 7.45119,0.00462507 z");o.attr({id:"path3001","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"50",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3001");var i=s.path("m 15.97079,8.1489251 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");i.attr({id:"path3807",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3807");var l=s.path("m 3.38842,11.049785 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");l.attr({id:"path3822",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3822");var h=s.path("M 15.69138,2.8164551 C 10.46092,7.2657851 5.23046,11.715125 0,16.164455 c 0.68845,-0.002 1.37691,-0.003 2.06536,-0.005 5.21598,-4.44988 10.43195,-8.8997599 15.64793,-13.3496399 -0.67397,0.002 -1.34794,0.004 -2.02191,0.007 z");h.attr({id:"path3803","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"49.9",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3803");var u=s.set();u.push(o,i,l,h);var p=u.getBBox().height;return null!==a.number&&u.push(n(e,u.getBBox().width,p+4,a.number,20,"lb")),null!==a.opt&&u.push(n(e,u.getBBox().width,p+3,"("+a.opt+")",16,"lb")),u.transform("t"+t+","+r),u}function he(e,t,r,a,s){var o=e,i=o.path("m 7.36,1.9518304 c -3.1472,0 -5.51238,3.23098 -5.51238,6.97709 0,3.7461196 2.36518,6.9770896 5.51238,6.9770896 3.1472,0 5.51238,-3.23097 5.51238,-6.9770896 0,-3.74611 -2.36518,-6.97709 -5.51238,-6.97709 z m 0,0.84817 c 1.97338,0 3.75892,3.18901 3.75892,6.12892 0,2.9399196 -1.78554,6.1289296 -3.75892,6.1289296 -1.97338,0 -3.75892,-3.18901 -3.75892,-6.1289296 0,-2.93991 1.78554,-6.12892 3.75892,-6.12892 z");i.attr({id:"path3878","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"72.4",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3878");var l=o.path("m 7.2,3.814697e-7 -3.6,0 0,0.7999999985303 3.2,0.40000002 0,7.6 1.2,0 0,-7.6 3.2,-0.40000002 0,-0.7999999985303 z");l.attr({id:"path4413",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4413");var h=o.path("m 7.6,17.6 3.6,0 0,-0.8 -3.2,-0.4 0,-7.5999996 -1.2,0 0,7.5999996 -3.2,0.4 0,0.8 z");h.attr({id:"path4415",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4415");var u=o.path("m 14.8,8.8000004 0,-3.6 -0.8,0 -0.4,3.2 -7.6,0 0,1.2 7.6,0 L 14,12.8 l 0.8,0 z");u.attr({id:"path4417",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4417");var p=o.path("M 0,9.2000004 0,12.8 l 0.8,0 0.4,-3.1999996 7.6,0 0,-1.2 -7.6,0 -0.4,-3.2 -0.8,0 z");p.attr({id:"path4419",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4419");var c=o.set();if(c.push(i,l,h,u,p),null!==s.number&&c.push(n(e,c.getBBox().width,c.getBBox().height+4,s.number,20,"lb")),void 0!==a&&null!==a){var f="l"==a[0]?0:"c"==a[0]?.5:1;t-=f*c.getBBox().width;var d="t"==a[1]?0:"m"==a[1]?.5:1;r-=d*c.getBBox().height}return c.transform("t"+t+","+(r-2)),c}var ue=new Array,pe=(new Array,function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}),ce=new l;l.prototype.enqueue=function(e){null!==e.task_type?(e.task_type in this.task_queue||(this.task_queue[e.task_type]=[]),this.task_queue[e.task_type].push(e),console.log("Enqueue task for queue '"+e.task_type+"'. Size = "+this.task_queue[e.task_type].length),1==this.task_queue[e.task_type].length&&setTimeout(e.run.bind(e),0)):setTimeout(e.run.bind(e),0)},l.prototype.finish=function(e){if(null!==e.task_type)if(e.task_type in this.task_queue&&0!=this.task_queue[e.task_type].length&&this.task_queue[e.task_type][0]==e){var t=this.task_queue[e.task_type];t.shift(),console.log("Dequeue task for queue '"+e.task_type+"'. Size = "+t.length),t.length>0&&t[0].run()}else alert("Invalid task execution state detected")},h.prototype.then=function(e){return this.promise.then(e)},h.prototype.run=function(){var e=this.worker(this.context);if(e instanceof h||e instanceof Promise){var t=this;e.then(function(e){null===t.resolve&&alert("Invalid state detected"),t.resolve(e),setTimeout(t.queue.finish.bind(t.queue,t),1)})}else null===this.resolve&&alert("Invalid state detected"),this.resolve(e),setTimeout(this.queue.finish.bind(this.queue,this),1)},h.enqueueFunctionCall=function(e,t,r){return new h({func:e,arguments:t,i:0,func_ret:void 0},function(e){return e.i>0?!0:(ret=e.func.apply(null,e.arguments),e.func_ret=ret,void 0===ret&&(ret=!0),++e.i,ret)},r)},h._ForeachWorker=function(e){var t=new l;new h(e,function(e){
return e.worker(e.loopindex,e.looptarget.length,e.looptarget[e.loopindex],e.context)},0,t);var r=new h(e,function(e){if(e.loopindex==e.looptarget.length-1)return e.context;var t=s(e);return t.loopindex++,new h(t,h._ForeachWorker,null)},0,t);return r},h.Foreach=function(e,t,r,n){var a={};a.worker=t,a.context=r,a.looptarget=e,a.loopindex=0;var s=new h(a,h._ForeachWorker,n);return s};var fe=17297280,de=new RegExp;de.compile(/^((sus4?)|(add(9|13))|(alt)|(dim)|(7|9|6|11|13)|((\+|\#)(5|9|13|11))|((\-|b)(5|9|13))|([Mm]([Aa][Jj]?|[Ii][Nn]?)?)|([\,\(\)]))/);var me=2,ge=0,_e=1,ve=3,be=4,ke=5,we=6,ye=9,xe=12,Ee=14,Re=[xe,ke,ge,be,Ee,we,ye,_e,ve];g.getTranpsoedNote=function(e,t,r,n){var a=[["A"],["A#","Bb"],["B","Cb"],["C"],["C#","Db"],["D"],["D#","Eb"],["E","Fb"],["F"],["F#","Gb"],["G"],["G#","Ab"]],s=r;if(void 0!==n&&(s+=n),0==e)return s;var o=0;for(o=0;o<a.length&&!(a[o].indexOf(s)>=0);++o);for(var i=o+e;0>i;)i+=12;var l=a[i%12];if(1==l.length)return l[0];switch(t){case"GUESS":return n&&"#"==n?l[0]:l[1];case"SHARP":return l[0];case"FLAT":return l[1]}return null},g.prototype.getChordStrBase=function(e,t){if(!this.is_valid_chord)return[!1,this.chord_str];var r=null;void 0!==this.note_base&&(r=g.getTranpsoedNote(e,t,this.note_base,this.sharp_flat));var n=null;return void 0!==this.base_note_base&&(n=g.getTranpsoedNote(e,t,this.base_note_base,this.base_sharp_flat)),[r,n]},g.prototype.getChordStr=function(e,t){if(!this.is_valid_chord)return[!1,this.chord_str];var r=null;void 0!==this.note_base&&(r=g.getTranpsoedNote(e,t,this.note_base,this.sharp_flat));var n=null;void 0!==this.base_note_base&&(n=g.getTranpsoedNote(e,t,this.base_note_base,this.base_sharp_flat));var a="";if(null!==this.mid_elems)for(var s=0;s<this.mid_elems.length;++s)switch(this.mid_elems[s].cs){case xe:var o=this.mid_elems[s].s,i="M"==o||"maj"==o.toLowerCase()||"ma"==o.toLowerCase();a+=i?"M":"m";break;case ke:var l={11:"%",13:"&"};a+=this.mid_elems[s].s in l?l[this.mid_elems[s].s]:this.mid_elems[s].s;break;case ge:a+="s"+this.mid_elems[s].s.substr(3);break;case be:a+="d";break;case ye:a+="b"+this.mid_elems[s].s.substr(1);break;case we:a+="#"+this.mid_elems[s].s.substr(1);break;case _e:a+="a"+this.mid_elems[s].s.substr(3);break;case ve:a+=this.mid_elems[s].s;break;case Ee:a+=this.mid_elems[s].s}var h=(r?r+a:"")+(n?"/"+n:"");return[!0,h]};var pe=function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e};pe(k,b),pe(w,b),pe(y,b),pe(E,b),pe(R,b),S.prototype.toString=function(){return"D.C."},B.prototype.toString=function(){var e="D.S."+(null===this.number?"":this.number),t=null===this.al?"":" al "+this.al.toString();return e+t},A.prototype.toString=function(){return"Coda"+(null===this.number?"":this.number)},M.prototype.toString=function(){return"Fine"};var Se=0,Be=1,Te=3,Ae=4,Ie=5,Me=6,Pe=7,Ce=8,Fe=14,Oe=15,Le=16,qe=17,Ne=18,De=19,He=20,ze=21,We=22,$e=23,Ge=24,je=25,Ue=/^(\w[\w\.\,\-\+\#\:]*)/,Xe=/^[^\[\]]*/,Ye=/^[\w\.\,\-\+\#\/\(\)\:\~]*/;P.prototype.onParseError=function(e){var t="Parse error on Line "+this.context.line+" : "+e;throw console.log(t),console.trace(),this.error_msg_callback?this.error_msg_callback(t):alert(t),"Parse error"},P.prototype.nextToken=function(e,t){word_def=Ue;var r=0;if(t!==!0)for(;e.length>0&&C(e[0]," 	");)e=e.substr(1),++r;if(0==e.length)return{token:null,s:e,type:Se,ss:r};if('"'==e[0]||"'"==e[0]){var n=e[0],a="";for(e=e.substr(1);e.length>0&&e[0]!=n;)a+=e[0],e=e.substr(1);var s=e.length>0&&e[0]==n;return s||this.onParseError("ERROR_WHILE_PARSING_PLAIN_STRING"),e=e.substr(1),{token:a,s:e,type:je,ss:r}}var o=C(e[0],"[]<>(),\n/%=");if(null!=o)return{token:e[0],s:e.substr(1),ss:r,type:[Ie,Me,Pe,Ce,Te,Ae,He,We,ze,$e,Ge][o.index]};var o=F(e,["||:","||.","||","|"]);if(null!=o)return{token:o.s,s:e.substr(o.s.length),ss:r,type:[Le,De,Oe,Fe][o.index]};var i=null;if(i=e.match(/^(\:\|\|\:?)(x(\d+))?/),null!=i){var l=2;return null!=i[2]&&(l=Number(i[3])),{token:i[0],s:e.substr(i[0].length),ss:r,type:":||:"==i[1]?Ne:qe,param:l}}if(i=e.match(word_def),null!=i){var h=i[0];return{token:h,s:e.substr(h.length),type:Be,ss:r}}throw"INVALID_TOKEN_DETECTED"},P.prototype.parseGroup=function(e,t,r){for(var n=new Array,a=0;a<e.length;++a){for(var s=e[a][1],o=e[a][0],i=new Array,l=!0;l;){var h=this.nextToken(t);switch(s){case"":h.type!=o&&this.onParseError(r),i.push(h.token),t=h.s,l=!1;break;case"*":if(h.type!=o){l=!1;break}i.push(h.token),t=h.s;break;case"+":if(h.type!=o){if(0!=i.length){loop_flag=!1;break}this.onParseError(r)}i.push(h.token),t=h.s;break;case"?":if(h.type!=o)break;i.push(h.token),t=h.s;break;default:throw"ASSERTION ERROR"}}n.push(i)}return{tokens:n,s:t}},P.prototype.parseReharsalMark=function(e,t){if(m=t.match(Xe),null!=m){reharsalMarkName=m[0];var r=this.nextToken(t.substr(m[0].length));if(r.type==Me)return{reharsalMarkName:reharsalMarkName,s:r.s}}throw"Invalid reharsal mark"},P.prototype.parseLoopIndicator=function(e,t){for(var r=!0,n=new Array;r;){var a=this.nextToken(t);if(a.type!=Be&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR"),n.push(a.token),t=a.s,a=this.nextToken(t),t=a.s,a.type==Me)break;a.type!=He&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR")}return{loopIndicator:new _(n),s:t}},P.prototype.parseTime=function(e,t){var r=0,n=0,a=this.nextToken(t);return t=a.s,a.type!=Be&&this.onParseError("ERROR_WHILE_PARSE_TIME"),r=a.token,a=this.nextToken(t),t=a.s,a.type!=ze&&this.onParseError("ERROR_WHILE_PARSE_TIME"),a=this.nextToken(t),t=a.s,a.type!=Be&&this.onParseError("ERROR_WHILE_PARSE_TIME"),n=a.token,a=this.nextToken(t),t=a.s,a.type!=Ae&&this.onParseError("ERROR_WHILE_PARSE_TIME"),{time:new v(r,n),s:t}},P.prototype.parseSign=function(e,t){var r=t.indexOf(">");if(0>r)throw"Parse error on Sign";var n=t.slice(0,r);t=t.slice(r+1);var a=this.nextToken(n,Ue);if(a.type!=Be)throw"Error";regDS=/D\.S\.([0-9]+)?/,regCoda=/Coda([0-9]+)?/,regSegno=/S(egno)?([0-9]+)?$/;var s=null;if("Fine"==a.token)sign=new M;else if("D.C."==a.token)sign=new S;else if(null!==(s=a.token.match(regCoda)))sign=new A(void 0===s[1]?null:s[1]);else if(null!==(s=a.token.match(regSegno))){var o=a.s.match(/^\s*(straight|((with\s+)repeat))/);console.log(a.s+"/"+n+o),sign=new T(void 0===s[2]?null:s[2],o?o[1]:null)}else if("to"==a.token){if(a=this.nextToken(a.s,Ue),a.type!=Be)throw"Error";if(s=a.token.match(regCoda),null===s)throw"Error";sign=new I(void 0===s[1]?null:s[1])}else{if(null===(s=a.token.match(regDS)))throw"Error";var i=void 0===s[1]?null:s[1],l=null;if(a=this.nextToken(a.s,Ue),a.type==Se);else{if(a.type!=Be)throw"Error";if("al"!=a.token)throw"Error";if(a=this.nextToken(a.s,Ue),a.type!=Be)throw"Error";if("Fine"==a.token)l=new M;else{if(null===(s=a.token.match(regCoda)))throw"Error";l=new A(void 0===s[1]?null:s[1])}}sign=new B(i,l)}return{sign:sign,s:t}},P.prototype.parseChordSymbol=function(e,t,r){chord_symbol=e;var n=r.match(Ye);n&&(chord_symbol+=n[0],r=r.substr(n[0].length));var a=new g(chord_symbol);return{s:r,chord:a}},P.prototype.parseRest=function(e,t,r){var n=/^r\:(1|2|4|8|16|32|64)(\.*)$/,a=e.match(n),s=null;return a&&(s=new f(parseInt(a[1]),a[2])),{s:r,rest:s}},P.prototype.parseMeasure=function(e,t){var r=new c;e.type==Fe?r.elements.push(new k(1)):e.type==Oe?r.elements.push(new k(2)):e.type==qe?r.elements.push(new y(e.param)):e.type==Le?r.elements.push(new w):e.type==Ne?r.elements.push(new E(e.param)):e.type==De&&r.elements.push(new R);for(var n=!0;n;){var a=this.nextToken(t);switch(a.type){case je:r.elements.push(new g(a.token)),t=a.s;break;case Be:var s=this.parseRest(a.token,a.type,a.s);if(null!==s.rest){r.elements.push(s.rest),t=s.s;break}case ze:var a=this.parseChordSymbol(a.token,a.type,a.s);r.elements.push(a.chord),t=a.s;break;case Pe:var a=this.parseSign(a.type,a.s);r.elements.push(a.sign),t=a.s;break;case Te:var a=this.parseTime(a.type,a.s);r.elements.push(a.time),t=a.s;break;case Ie:var a=this.parseLoopIndicator(a.type,a.s);r.elements.push(a.loopIndicator),t=a.s;break;case Fe:r.elements.push(new k(1)),n=!1;break;case Oe:r.elements.push(new k(2)),n=!1;break;case qe:r.elements.push(new y(a.param)),n=!1;break;case Le:r.elements.push(new w),n=!1;break;case Ne:r.elements.push(new E(a.param)),n=!1;break;case De:r.elements.push(new R),n=!1;break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURE")}}return{measure:r,s:t}},P.prototype.parseMeasures=function(e,t){for(var r=new Array,n=!0;n;){var a=this.parseMeasure(e,t);switch(t=a.s,r.push(a.measure),a=this.nextToken(t),t=a.s,a.type){case Fe:case Oe:case Le:case qe:case Ne:case De:var s=this.nextToken(t);switch(s.type){case We:n=!1;break;case Se:n=!1;break;default:e=a}break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURES")}}return{measures:r,s:t}},P.prototype.parseMacro=function(e){var t=null,r=null,n=this.nextToken(e);n.type!=Be&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),t=n.token,e=n.s;var n=this.nextToken(e);n.type!=Ge&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=n.s;var n=this.nextToken(e);return n.type!=je&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=n.s,r=n.token,{key:t,value:r,s:e}},P.prototype.glanceHeader=function(e){for(var t=["TITLE","ARTIST"],r={},n=e.split("\n"),a=0;a<n.length;++a)if(n[a].length>0&&"%"==n[a][0]){var s=this.parseMacro(n[a].substr(1));if(t.indexOf(s.key)>=0&&(r[s.key]=s.value),r.length==t.length)break}return r},P.prototype.parse=function(e){e.replace(/\r\n/g,"\n"),e.replace(/\r/g,"\n");for(var t=null,r=0,n=new u,a=null;;){if(t=this.nextToken(e),t.type==Se)break;if(t.type==Ie?(t=this.parseReharsalMark(t.token,t.s),null!=a&&n.reharsal_groups.push(a),a=new p,a.name=t.reharsalMarkName):[Fe,Oe,Le,Ne,De].indexOf(t.type)>=0?(t=this.parseMeasures(t,t.s),a.measures=a.measures.concat(t.measures)):t.type==$e?(t=this.parseMacro(t.s),a?a.macros[t.key]=t.value:n.macros[t.key]=t.value):t.type==We?this.context.line+=1:(console.log(t.token),this.onParseError("ERROR_WHILE_PARSE_MOST_OUTSIDER")),e=t.s,r++,r>=1e3)break}null!=a&&(n.reharsal_groups.push(a),a=null);for(var s={},o=0;o<n.reharsal_groups.length;++o){var i=n.reharsal_groups[o];i.name in s?n.reharsal_groups[o]=$.extend(!0,{},s[i.name]):s[i.name]=i}return n},D.prototype.play=function(e){if(!this.timerid){this.timerStart=Date.now(),this.tempo_bpm=e,this.cmi=0;var t=this;this.timerid=setInterval(function(){t.onClock()},100),this.onClock(),this.cb_play&&this.cb_play()}},D.prototype.stop=function(){this.timerid&&(clearInterval(this.timerid),this.timerid=null,this.lastindicator&&(this.lastindicator.remove(),this.lastindicator=null),this.cb_stop&&this.cb_stop())},D.prototype.onClock=function(){for(var e=Date.now(),t=e-this.timerStart,r=this.sequence,n=1/this.tempo_bpm*60*1e3*4;this.cmi<r.length&&!(t>=r[this.cmi][0].t*n&&t<(r[this.cmi][0].t+r[this.cmi][0].duration)*n);++this.cmi);if(this.cmi>=r.length)return void this.stop();var a=r[this.cmi][1],s=a.renderprop.sx,o=a.renderprop.ex,i=a.renderprop.y;this.lastindicator&&(this.lastindicator.remove(),this.lastindicator=null),this.lastindicator=a.renderprop.paper.rect(s,i,o-s,30).attr({fill:"red","fill-opacity":.3,stroke:0});var l=(a.renderprop.paper.canvas.offsetLeft,a.renderprop.paper.canvas.offsetTop);window.scroll(0,l+i-$(window).height()/2)},O.prototype.render=function(e,t,r){if(this.track=e,t){h.enqueueFunctionCall(ie,[this.canvas,e,!0,this.param,t,r],"render"),h.enqueueFunctionCall(G,[e,this.param],"render");var n=h.enqueueFunctionCall(ie,[this.canvas,e,!1,this.param,t,r],"render");return n}ie(this.canvas,e,!0,this.param,t,r),G(e,this.param),ie(this.canvas,e,!1,this.param,t,r)},O.prototype.clear=function(){for(var e=0;e<ue.length;++e)ue[e].clear();$(this.canvas).children().remove(),ue=new Array};var Qe={},Ve=0,Je={M:function(e){return[[16,-7,"M"]]},m:function(e){return[[16,-7,"m"]]}},Ke=0,Ze={dim:function(e){return[[16,-7,"d"]]},sus:function(e){return[[18,-9,"s"],[13,-2,e?e:""]]},M:function(e){return[[16,-7,"M"],[13,-2,e?e:""]]},m:function(e){return[[16,-7,"m"]]},add:function(e){return[[20,-10,"a"],[13,-2,e?e:""]]},dig:function(e){return[[13,-2,e?e:""]]}},et=0,tt={"#":function(e){return[[13,-2,"+"],[13,-2,e]]},b:function(e){return[[13,-2,"-"],[13,-2,e]]},dig:function(e){return[[13,-2,e]]}},rt=0,nt={"#":function(e){return[[13,-2,"#"],[13,-2,e]]},b:function(e){return[[13,-2,"b"],[13,-2,e]]},alt:function(e){return[[13,-2,"alt"]]}},at=null,st=!1,ot=null,it=!1;return $(document).ready(function(){paper=Raphael($("#invisible_view")[0],500,500);n(paper,100,100,"ABCDEFG#b123456789dsMm",16,"lt","icomoon")}),{Parser:P,Renderer:O,Sequencer:D}}();