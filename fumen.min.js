var Fumen=function(){function e(e,t,r,a){return"M"+e+","+t+" L"+r+","+a}function t(e,t){for(var r="M",a=0;a<e.length;++a)r+=e[a][0]+","+e[a][1],a<e.length-1&&(r+=" L");return t===!0&&(r+="Z"),r}function r(e){var t="M ";t+=e[0][0]+" "+e[0][1],t+=" C";for(var r=1;r<e.length;++r)t+=e[r][0]+" "+e[r][1]+" ";return t}function a(e,t,r,a,n,s,o){var i=e.text(t,r,a).attr("font-size",n);o&&i.attr("font-family",o);var l=i.getBBox().width,h=i.getBBox().height;return("l"==s[0]||"r"==s[0])&&i.attr("x",i.attr("x")+l/2*("l"==s[0]?1:-1)),("t"==s[1]||"b"==s[1])&&i.attr("y",i.attr("y")+h/2*("t"==s[1]?1:-1)),i}function n(e,t,r,n,s){var o=e.set(),i=a(e,t,r,n,s,"lt"),l=i.getBBox().width,h=i.getBBox().height,u=0*h,p=.1*h,c=e.rect(t,r,l+2*p,h+2*u);return i.attr("x",i.attr("x")+p),i.attr("y",i.attr("y")+u),o.push(i,c),o}function s(e){return jQuery.extend({},e)}function i(){this.task_queue={}}function l(e,t,r,a){void 0===r&&(r=null),this.task_type=r,this.context=e,this.worker=t,this.promise=null,this.resolve=null,this.reject=null;var n=this;this.promise=new Promise(function(e,t){n.resolve=e,n.reject=t}),a=void 0===a?null:a,this.queue=a?a:oe,this.queue.enqueue(this)}function h(){this.reharsal_groups=new Array,this.macros={}}function u(){this.name=null,this.measures=new Array,this.macros={}}function p(){this.elements=new Array,this.boundary_info=["n","n"],this.header_width=0,this.body_width=0,this.footer_width=0,this.body_scaling=1,this.new_line=!1,this.renderprop={}}function c(e,t){var r=ie/e;this.length_s=""+e+(t?t:""),this.length=ie/e;for(var a=t?t:"",n=0;n<a.length;++n)r/=2,this.length+=r;this.renderprop={}}function f(e){for(var t=[],r=[];e.length>0;){if(m=e.match(le),null===m)return console.log("Invalid code notation : "+e),null;for(var a=0;a<be.length;++a)if(void 0!==m[he+be[a]]&&null!==m[he+be[a]]){t.push({cs:be[a],s:m[0],g:m});break}e=e.substr(m[0].length)}for(var n=!1,a=0;a<t.length;++a)switch(t[a].cs){case _e:var e=t[a].s,s="M"==e||"maj"==e.toLowerCase()||"ma"==e.toLowerCase();0==s&&(n=!0),n&&1==s?t[a+1].cs==de&&(r.push({type:"M",param:t[a+1].s}),++a):s?r.push({type:"M"}):r.push({type:"m"});break;case de:r.push({type:"dig",param:t[a].s});break;case ue:r.push({type:"sus",param:t[a].s.substr(3)});break;case fe:r.push({type:"dim"});break;case ge:r.push({type:"b",param:t[a].s.substr(1)});break;case me:r.push({type:"#",param:t[a].s.substr(1)});break;case pe:r.push({type:"add",param:t[a].s.substr(3)});break;case ce:r.push({type:"alt"})}return[t,r]}function d(e){this.chord_str=e,this.is_valid_chord=!0,this.length=ie,this.length_s=null,this.tie=!1,this.renderprop={};var t=/^(((A|B|C|D|E|F|G)(#|b)?([^\/\:]*))?(?:\/(A|B|C|D|E|F|G)(#|b)?)?)(:(\d+)(\.*))?(\~)?/,r=e.match(t);if(r&&""!=r[0]){if(this.chord_name_str=r[1],this.note_base=r[3],this.sharp_flat=r[4],this.mid_str=r[5],this.base_note_base=r[6],this.base_sharp_flat=r[7],this.mid_elems=null,void 0!==this.mid_str){var a=f(this.mid_str);null!==a&&(this.mid_elems=a[0],this.mid_elem_objs=a[1]),this.is_valid_chord=null!==a}if(r[8]){var n=r[10]?r[10]:"";this.length_s=r[9]+(r[10]?r[10]:""),this.length=ie/parseInt(r[9]);for(var s=ie/parseInt(r[9]),o=0;o<n.length;++o)s/=2,this.length+=s}this.tie="~"==r[11]}else this.chord_name_str=this.chord_str,this.is_valid_chord=!1}function g(e){this.indicators=e}function _(e,t){this.numer=e,this.denom=t}function v(){}function b(e){this.nline=e}function k(){}function w(e){this.times=e}function y(e){this.times=e}function E(){}function R(){}function B(e,t){this.number=e,this.al=t}function S(e,t){this.number=e,this.opt=t}function T(e){this.number=e}function A(e){this.number=e}function I(){}function M(e){this.context={line:0,"char":0},this.error_msg_callback=e}function F(e,t){for(var r=0;r<t.length;++r)if(t[r]==e)return{r:!0,index:r};return null}function P(e,t){for(var r=0;r<t.length;++r)if(0==e.indexOf(t[r]))return{index:r,s:t[r]};return null}function C(e,t,r){this.canvas=e,this.param={row_interval:70,y_title_offset:50,y_author_offset:90,y_first_page_offset:120,y_offset:70,x_offset:70,min_measure_width:100,row_height:24,row_margin:25,rs_area_height:24,rm_area_height:30,mh_area_height:25,max_scaling:1.2,paper_width:t,paper_height:r,repeat_mark_font:{"font-family":"Times New Roman","font-style":"italic","font-weight":"bold"}}}function O(e){for(var t=e,r=new Array,a=new Array,n=new Array,s=new Array,o=0;o<t.elements.length;++o){var i=t.elements[o];0==o?r.push(i):o==t.elements.length-1?n.push(i):i instanceof d?a.push(i):i instanceof c?a.push(i):i instanceof g?s.push(i):i instanceof _?r.push(i):i instanceof R?n.push(i):i instanceof B?n.push(i):i instanceof S?r.push(i):i instanceof T?r.push(i):i instanceof A?n.push(i):i instanceof I&&n.push(i)}return{header:r,body:a,footer:n,measure_wide:s}}function L(e,t,r){for(var a=0,n=null,s=null;null!==(n=t(a++))&&n<e.length;){var o=void 0!==r?r(e[n]):e[n];s=null===s?o:Math.max(o,s)}return s}function N(e,t){console.log("Identify scaling called");for(var r=t.paper_width-2*t.x_offset,a=0;a<e.reharsal_groups.length;++a){var n=e.reharsal_groups[a],s=0,o=new Array,i=new Array,l=!0,h=!0;if(l){for(var u=0,p=0;p<n.measures.length;++p){u=p+1;var c=n.measures[p];if(s+=c.header_width+c.body_width+c.footer_width,s>r){u--;break}}for(var f=n.measures.length,d=u,m=new Array,g=0;d>0;--d){for(var _=0;d>_;++_){var v=L(n.measures,function(e){return e*d+_},function(e){return e.header_width+e.body_width+e.footer_width});g+=v,m.push(v)}if(r>=g){if(!h)break;if(d%2==0||1==d||d==f)break}g=0,m=new Array}for(var b=r/g,p=0;p<n.measures.length;++p){var c=n.measures[p],k=Math.floor(p/d),w=p-k*d,y=m[w]*b-(c.header_width+c.footer_width);c.new_line=0==w&&k>0,c.body_scaling=y/c.body_width}}else{for(var p=0;p<n.measures.length;++p){var c=n.measures[p];i.push(c),s+=c.header_width+c.body_width+c.footer_width,s>r&&(o.push(i),i=new Array,s=0)}i.length>0&&o.push(i);for(var x=0;x<o.length;++x){for(var E=0,R=0,p=0;p<o[x].length;++p){var c=o[x][p];x>0&&0==p&&(c.new_line=!0),E+=c.header_width+c.body_width+c.footer_width,R+=c.header_width+c.footer_width}var B=r-R;if(0>=B)throw"ERROR";for(var S=B/(E-R),p=0;p<o[x].length;++p){var c=o[x][p];c.body_scaling=Math.min(t.max_scaling,S)}}}}}function q(e,t){var r=ne.length;$(e).append("<div id='page"+r+"'></div>");var n=$(e).children("#page"+r)[0];return paper=Raphael(n,t.paper_width,t.paper_height),ne.push(paper),paper.canvas.style.backgroundColor="#FFFFFF",a(paper,t.paper_width/2,t.paper_height-40,"Generated by fumen ver 0.1",12,"ct"),Ge={},paper}function D(e){if(null===e)return"n";if(e instanceof b){if(1==e.nline)return"s";if(2==e.nline)return"d"}else{if(e instanceof k)return"b";if(e instanceof w)return"e";if(e instanceof y)return"B";if(e instanceof E)return"f"}throw"Invalid boundary object"}function H(e,t){var r={ss:"s",sd:"d",sb:"b",sn:"s",ds:"d",dd:"d",db:"b",dn:"d",es:"e",ed:"e",ee:"e",eb:"B",en:"e",bb:"b",BB:"B",fn:"f",ns:"s",nd:"d",nb:"b"},a=D(e)+D(t);if(a in r)return r[a];throw"Invalid boundary pair : "+a}function z(e,t,r){var a={ss:"ss",sd:"sd",sb:"sb",ds:"ds",dd:"dd",db:"db",es:"es",ed:"ed",ee:"es",eb:"eb",bb:"sb",BB:"eb"},n=D(e)+D(t);if(n in a)return a[n]["begin"==r?1:0];throw"Invalid boundary pair : "+n}function W(t,r,n,s,o,i,l,h,u){var p=h.row_height,c=null,f=i;if("end"==t){var d=null===n||s;if(!d)return{x:i,bx:f}}switch(c=null===s||0==s?H(r,n):z(r,n,t)){case"s":case"d":for(var m="s"==c?1:2,g=0;m>g;++g)u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),m>=2&&m-1>g&&(i+=3);f=i;break;case"b":u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=4,u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"});break;case"e":u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"}),i+=4,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),null!==r.times&&2!=r.times&&u&&(text=a(o,i,l+p+8,"(x"+r.times+")",13,"rc")),f=i;break;case"B":u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"}),i+=4,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),f=i,i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),null!==r.times&&2!=r.times&&u&&(text=a(o,i,l+p+8,"(x"+r.times+")",13,"rc")),i+=4,u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"});break;case"f":u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"});break;default:throw"Internal error"}return{x:i,bx:f}}function G(e,t,r,n,s,o,i,l,h,u,p){var c=i.row_height,f=e.getChordStr(t,r),d=a(n,s,o+c/2,f[1],16,"lc",f[0]?"icomoon":null);return s+=d.getBBox().width*u*p,s+=h*p,l||d.remove(),{x:s}}function j(e,t,n,s,o,i,l,h,u,p,c){var f="icomoon",d=l.row_height;if(e.renderprop.x=o,!e.is_valid_chord)return G(e,t,n,s,o,i,l,h,u,p,c);var m=[o,i];if(h&&e.chord_name_str in Ge){var g=Ge[e.chord_name_str],_=g[0].clone();_.attr({opacity:1});var v=g[1];return _.transform("T "+(m[0]-v[0])+" "+(m[1]-v[1])),o+=_.getBBox().width*p*c,o+=u*c,isFinite(o)||console.error("Illegal calculation of x detected"),{group:_,x:o}}var b=e.getChordStrBase(t,n),k=e.mid_elem_objs,_=s.set(),w=[],y=[],x=[],E=[];if(k){for(var R=!1,B=!1,S=0;S<k.length;++S){var T=k[S];switch(T.type){case"M":void 0!==T.param?x.push(T):w.push(T);break;case"m":w.push(T);break;case"add":x.push(T);break;case"sus":x.push(T);break;case"dig":x.push(T),R|="6"==T.param,B|="9"==T.param;break;case"b":case"#":"5"==T.param?y.push(T):E.push(T);break;case"dim":x.push(T);break;case"alt":E.push(T)}}if(R&&B)for(var S=0;S<x.length;++S)if("dig"==x[S].type&&"6"==x[S].param){y.push(x[S]),x.splice(S,1);break}}var A=null,I=o;b[0]&&(A=a(s,I,i+d/2,b[0],18,"lc",f),_.push(A),I+=A.getBBox().width);var M=0;if(w.length>0){for(var F=je[w[0].type](w[0].param),P=0,S=0;S<F.length;++S)A=a(s,I+P,i+d/2+F[S][1]+$e,F[S][2],F[S][0],"lt",f),_.push(A),P+=A.getBBox().width;M=P}var C=0;if(y.length>0){for(var F=Je[y[0].type](y[0].param),P=0,S=0;S<F.length;++S)A=a(s,I+P,i+d/2+F[S][1]+Ye,F[S][2],F[S][0],"lb",f),_.push(A),P+=A.getBBox().width;C=P}var O=M;if(x.length>0){for(var P=0,L=0;L<x.length;++L)for(var F=Xe[x[L].type](x[L].param),S=0;S<F.length;++S)""!=F[S][2]&&(A=a(s,I+M+P,i+d/2+F[S][1]+Ue,F[S][2],F[S][0],"lt",f),P+=A.getBBox().width,_.push(A));O+=P}I+=Math.max(C,O);for(var N=0,q=0,D=1e4,H=5,S=0;S<E.length;++S){for(var T=E[S],F=Qe[T.type](T.param),z=0,W=0,$=0;$<F.length;++$)D=Math.min(D,i+q+F[$][1]+Ke),A=a(s,I+H+z,i+q+F[$][1]+Ke,F[$][2],F[$][0],"lt",f),_.push(A),z+=A.getBBox().width,W=Math.max(W,A.getBBox().height);q+=W+1,N=Math.max(N,z)}if(E.length>0){var j=[[I+H,D],[I,D],[I,D+q],[I+H,D+q]],U=s.path(r(j)).attr("stroke-width","1px"),X=[[I+H+N,D],[I+H+N+5,D],[I+H+N+5,D+q],[I+H+N,D+q]],Y=s.path(r(X)).attr("stroke-width","1px");_.push(U),_.push(Y),N+=2*H}if(I+=N,b[1]&&(A=a(s,I,i+d/2,"/",26,"lc"),_.push(A),I+=A.getBBox().width,A=a(s,I,i+d/2,b[1],18,"lc",f),_.push(A),I+=A.getBBox().width),o+=_.getBBox().width*p*c,o+=u*c,h||A.remove(),h){var J=_.clone();J.attr({opacity:0}),Ge[e.chord_name_str]=[J,m]}return isFinite(o)||console.error("Illegal calculation of x detected"),{group:_,x:o}}function U(e,r,a,n,s,o){var i=10,l=10,h=4,u=t([[a,n],[a+i,n-l],[a+i,n-l+h],[a,n+h]],!0),p=null;p="1"==s||"2"==s?e.path(u).attr({"stroke-width":"1px"}):e.path(u).attr({fill:"#000000"}),r.push(p);for(var c=0;o>c;++c)r.push(e.circle(a+i+5+5*c,n-6,1).attr({fill:"black"}));return r}function X(e,t){for(var r=[],a=[],n=null,s=0;s<e.length;++s)null!=n&&n!=t(e[s])&&(r.push(a),a=[]),n=t(e[s]),a.push(e[s]);return r.push(a),r}function Y(e,t,r,a,n,s,o){for(var i=r+s.row_height+10,l=e.set(),h=0;n>h;++h){var u=t+a/4*h;U(e,l,u,i,"0",0)}}function J(e){var t={1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7};return t[e]}function K(t,r,a,n,s,i,l){if(a.groups.length>=2){var h=a.groups[0].coord,u=a.groups[a.groups.length-1].coord,p=t.path(e(h[0],h[1],u[0],u[1])).attr({"stroke-width":l});r.push(p);for(var c=X(a.groups,function(e){return e.onka}),f=0;f<c.length;++f){var d=c[f],m=d[0].onka,g=J(parseInt(m))-2;if(1==d.length){var _=d[0].coord,v=1;f==c.length-1&&(v=-1);for(var b=c[f+v][c[f+v].length-1].coord[0],k=.3*Math.abs(b-_[0]),w=0;g>w;++w)o=t.path(e(_[0],n+s-w*i,_[0]+v*k,n+s-w*i)).attr({"stroke-width":l}),r.push(o)}else if(d.length>=2)for(var _=d[0].coord,y=d[d.length-1].coord,w=0;g>w;++w)o=t.path(e(_[0],_[1]-w*i,y[0],y[1]-w*i)).attr({"stroke-width":l}),r.push(o)}}else if(1==a.groups.length)for(var h=a.groups[0].coord,m=a.groups[0].onka,g=J(parseInt(m))-2,w=0;g>w;++w)o=t.path("M"+(h[0]+10)+","+(n+s-10-w*i)+"L"+h[0]+","+(n+s-w*i)).attr({"stroke-width":"1px"}),r.push(o)}function Q(e,t,a,n,s,o,i,l,h,u){var p=a+o.row_height+10,c="4px";balken={groups:[],sum_len:0};for(var f=!1,m=t.set(),g=0;g<e.length;++g){var _=e[g],v=_.renderprop.x,b=20,k=5;if(null!==_.length_s&&void 0!==_.length_s){var w=_.length_s.match(/[0-9]+/)[0],y=_.length_s.substr(w.length);if(_ instanceof d)if(f=!0,"0"==w||"1"==w)U(t,m,v,p,w,y.length);else{U(t,m,v,p,w,y.length);var x=t.path("M"+v+","+p+"L"+v+","+(p+b)).attr({"stroke-width":"1px"});m.push(x)}if(u){var E=_.length>=ie/4||balken.sum_len%(ie/4)==0;E&&(K(t,m,balken,p,b,k,c),balken.groups=[]),balken.sum_len+=_.length,_.length<ie/4&&_ instanceof d&&balken.groups.push({coord:[_.renderprop.x,p+b],onka:w}),g==e.length-1&&K(t,m,balken,p,b,k,c)}if(_ instanceof d){if(Ze){var R=-10,B=12,S=8,T=Ve,A=[v,p,n,s];if(T[1]!=A[1]){var I=[[T[0]+B,T[1]+R],[T[0]+B,T[1]-S+R],[T[3]+20,T[1]-S+R],[T[3]+20,T[1]+R]];clip=T[0]+B+","+(T[1]-50)+","+(T[3]-(T[0]+B)+5)+",100",console.log("clip:"+clip);var M=et.path(r(I)).attr("stroke-width","2px").attr({"clip-rect":clip});et.set().push(M),I=[[A[2]-20,A[1]+R],[A[2]-20,A[1]-S+R],[A[0],A[1]-S+R],[A[0],A[1]+R]],clip=A[2]-5+","+(A[1]-50)+","+(A[0]-(A[2]-5))+",100",console.log("clip:"+clip),M=t.path(r(I)).attr("stroke-width","2px").attr({"clip-rect":clip}),m.push(M)}else{var I=[[T[0]+B,T[1]+R],[T[0]+B,T[1]-S+R],[A[0],A[1]-S+R],[A[0],A[1]+R]],M=t.path(r(I)).attr("stroke-width","2px");m.push(M)}}Ze=_.tie,Ve=[v,p,n,s],et=t}}}return f?m:null}function V(t,r,n,s,o,i,l,h,u,p,f){var m=a(t,0,0,"C7",16,"lc","icomoon"),b=m.getBBox().width;m.remove();var k=!1,w=!1;"ON"==f&&(k=!0);for(var y=0;y<o.length;++y)for(var E=o[y],M=0;M<E.elements.length;++M){var F=E.elements[M];F instanceof T||F instanceof S?w=!0:F instanceof d&&(k|=null!==F.length_s)}"OFF"==f&&(k=!1);for(var P=k?u.row_height+5:0,C=w?u.mh_area_height:0,L=h+C,N=[],q=x,D=x,y=0;y<o.length;++y){for(var E=o[y],H=x,z=x,G=x,$=O(E),U=0,X=!1,M=0;M<$.header.length;++M){var F=$.header[M];F instanceof T?(X=!0,p&&ae(t,H,h,"lt",F)):F instanceof S&&(X=!0,p&&re(t,H,h+3,F))}X&&(U+=u.mh_area_height);for(var M=0;M<$.header.length;++M){var F=$.header[M];if(F instanceof v){var K=0==y?i:o[y-1],V=K?K.elements[K.elements.length-1]:null,Z=W("begin",V,F,E.new_line,t,x,L+P,u,p);x=Z.x,z=Z.bx}else if(F instanceof _){x+=4;var ee=0,te=x,ne=a(t,te,L+P,F.numer,12,"lt","icomoon");ee=ne.getBBox().width;var se=a(t,te,L+u.row_height/2+P,F.denom,12,"lt","icomoon");ee=Math.max(ee,se.getBBox().width),ne.attr({x:ne.attr("x")+(ee-ne.getBBox().width)/2}),se.attr({x:se.attr("x")+(ee-se.getBBox().width)/2});var oe=L+u.row_height/2;p&&!k&&t.path(e(te,oe,te+ee,oe)).attr({"stroke-width":"1"}),x+=ee}}x+=10,E.header_width=x-H;for(var ie=x,le=0,he=!0,ue=0,pe=[],M=0;M<$.body.length;++M){var F=$.body[M];(F instanceof d||F instanceof c)&&(++le,he&=null!==F.length,he&&(ue+=F.length),pe.push(F))}for(var ce=null,M=0;M<$.body.length;++M){var F=$.body[M],fe=0;if(fe=he?Math.floor(40*r/ue*F.length):Math.floor(40*r/le),F instanceof d){var m,de=j(F,n,s,t,x,L,u,p,fe,r,E.body_scaling);x=de.x,isFinite(x)||console.log("Illegal calculation of x is detected"),(tt||ce==F.chord_name_str)&&de.group.remove(),tt=F.tie,ce=F.chord_name_str}else{if(!(F instanceof c))throw"ERROR";var me={1:"",2:"",4:"",8:"",16:"",32:""},ge={1:0,2:0,4:0,8:0,16:7,32:7,64:14,128:14},_e=parseInt(F.length_s),ve=t.set(),be=ge[_e],ke=14;if(4>=_e){var m=a(t,x,L+u.row_height/2+P,me[_e],ke,"lc","icomoon");ve.push(m)}else for(var we=J(_e)-2,ye=2,xe=-7,Ee=0;we>Ee;++Ee){var m=a(t,x+Ee*ye,L+u.row_height/2+P+Ee*xe+be,"",ke,"lc","icomoon");ve.push(m)}x+=b*r*E.body_scaling,x+=fe*E.body_scaling,F.renderprop.x=x,p||ve.remove()}}0==$.body.length&&(x+=b*r*E.body_scaling,x+=40*r*E.body_scaling),E.body_width=x-ie;for(var Re=x,M=0;M<$.footer.length;++M){var Be=k?"l":"r",F=$.footer[M];if(F instanceof v){var Se=y==o.length-1?l:o[y+1],V=Se?Se.elements[0]:null,Z=W("end",F,V,Se?Se.new_line:!1,t,x,L+P,u,p);x=Z.x}else if(F instanceof R)m=a(t,x,L-8+P,F.toString(),15,Be+"c").attr(u.repeat_mark_font),k&&(x+=m.getBBox().width);else if(F instanceof B)m=a(t,x,L-8+P,F.toString(),15,Be+"c").attr(u.repeat_mark_font),k&&(x+=m.getBBox().width);else if(F instanceof A)if(k){var m=a(t,x,L+P,"To",15,"lb").attr(u.repeat_mark_font);x+=m.getBBox().width+5;var Te=ae(t,x,L+P,"lb",F);x+=Te.getBBox().width}else{var Te=ae(t,x,L+P,"rb",F);m=a(t,x-1.5*Te.getBBox().width,L+P,"To",15,"rb").attr(u.repeat_mark_font)}else{if(!(F instanceof I))throw"ERROR";m=a(t,x,L-8+P,F.toString(),15,Be+"c").attr(u.repeat_mark_font),k&&(x+=m.getBBox().width)}}E.footer_width=x-Re,G=x,D=G;for(var M=0;M<$.measure_wide.length;++M){var F=$.measure_wide[M];if(!(F instanceof g))throw"ERROR";var be=10,oe=L-2-be,Ae=z,Ie=G;p&&t.path(e(Ae,oe,Ae,oe+be)).attr({"stroke-width":"1"}),p&&t.path(e(Ae,oe,Ie,oe)).attr({"stroke-width":"1"});var Me=F.indicators.join(",");p&&a(t,Ae+2,oe,Me,10,"lt")}if(U+=u.row_height,k){var xe=10,Fe=Q(pe,t,L+xe,z,G,u,p,0,E.body_scaling,he);U+=u.rs_area_height,Fe||Y(t,ie,L+xe,E.body_width,4,u,E.body_scaling)}U+=u.row_margin,E.renderprop.meas_height=U,N.push(U)}if(k)for(var Pe=0;5>Pe;++Pe){var Ce=6,Oe=5;p&&t.path(e([[q,L+u.row_height+Pe*Ce+Oe],[D,L+u.row_height+Pe*Ce+Oe]])).attr({"stroke-width":"1px"})}return h+=Math.max.apply(null,N),{y_base:h}}function Z(e){var t={};if(t.x_global_scale=1,"XSCALE"in e.macros&&(t.x_global_scale=parseFloat(e.macros.XSCALE)),t.transpose=0,"TRANSPOSE"in e.macros){var r=parseInt(e.macros.TRANSPOSE);isNaN(r)||(t.transpose=r)}return t.half_type="GUESS","HALF_TYPE"in e.macros&&(t.half_type=e.macros.HALF_TYPE),t.staff="AUTO","STAFF"in e.macros&&(t.staff=e.macros.STAFF),t}function ee(e,t){var r=$.extend(!0,{},e);if("XSCALE"in t.macros&&(r.x_global_scale=parseFloat(t.macros.XSCALE)),"TRANSPOSE"in t.macros){var a=parseInt(t.macros.TRANSPOSE);isNaN(a)||(r.transpose=a)}return"HALF_TYPE"in t.macros&&(r.half_type=t.macros.HALF_TYPE),"STAFF"in t.macros&&(r.staff=t.macros.STAFF),r}function te(e,t,r,s,o,i){var h=!r;console.log("render_impl called with "+h);var u=s.y_title_offset,p=s.x_offset,c=s.paper_width-2*p,f=null;f=h?q(e,s):Raphael($("#invisible_view")[0],s.paper_width,s.paper_height);var d=s.y_first_page_offset,m="No Name";"TITLE"in t.macros&&(h&&a(f,p+c/2,u,t.macros.TITLE,24,"ct"),m=t.macros.TITLE),"ARTIST"in t.macros&&(h&&a(f,p+c,s.y_author_offset,t.macros.ARTIST,14,"rt"),m+="/"+t.macros.ARTIST);var g=Z(t);console.log("render_impl called with "+h+" : Making pagination");var _=[];if(h){for(var v=[{type:"titles",height:s.y_first_page_offset}],b=0;b<t.reharsal_groups.length;++b){var k=ee(g,t.reharsal_groups[b]);console.group("Macro for "+t.reharsal_groups[b].name),console.log(k),console.groupEnd(),v.push({type:"reharsal",height:s.rm_area_height,cont:t.reharsal_groups[b]});for(var w=t.reharsal_groups[b],y=0,E=[],R=null,B=0;B<w.measures.length;++B){var S=w.measures[B];S.new_line&&(v.push({type:"meas",height:y,cont:E,nm:S,pm:R,rg:t.reharsal_groups[b],macros:k}),y=0,E=[],R=B>0?w.measures[B-1]:null),E.push(S),y=Math.max(y,S.renderprop.meas_height)}y>0&&v.push({type:"meas",height:y,cont:E,nm:null,pm:R,rg:t.reharsal_groups[b],macros:k})}for(var T=0,A=[],b=0;b<v.length;++b)T+v[b].height<=s.paper_height-s.y_offset?(T+=v[b].height,A.push(v[b])):(_.push(A),A=[v[b]],T=v[b].height);A.length>0&&_.push(A),console.log("////////"),console.log(_)}else{for(var v=[{type:"titles",height:p}],b=0;b<t.reharsal_groups.length;++b){var k=ee(g,t.reharsal_groups[b]);v.push({type:"reharsal",height:s.rm_area_height,cont:t.reharsal_groups[b]});var w=t.reharsal_groups[b];v.push({type:"meas",height:0,cont:w.measures,nm:null,pm:null,rg:t.reharsal_groups[b],macros:k})}_.push(v)}if(console.log("render_impl called with "+h+" : Invoke async loop execution"),o){l.Foreach(_,function(t,r,a,s){l.Foreach(a,function(e,r,a,s){if(i&&i((s.draw?"":"Pre-")+"Rendering block "+e+" in page "+(t+1)+" of "+m),"titles"==a.type);else if("reharsal"==a.type){x=p;var o=a.cont;if(s.draw){n(s.paper,x,s.y_base,o.name,18)}s.y_base+=s.param.rm_area_height}else if("meas"==a.type){x=p;var l=a.cont,h=V(s.paper,a.macros.x_global_scale,a.macros.transpose,a.macros.half_type,l,a.pm,a.nm,s.y_base,s.param,s.draw,a.macros.staff);s.y_base=h.y_base}},s,"renderpageelemloop");var o=l.enqueueFunctionCall(function(){s.draw&&t!=_.length-1&&(s.paper=q(e,s.param),s.y_base=s.param.y_offset)},[],"renderpageelemloop");return o},{param:s,draw:h,paper:f,y_base:d},"renderpageloop");var I=l.enqueueFunctionCall(function(){h||$("#invisible_view").children().remove()},[],"renderpageloop");return I}for(var M=0;M<_.length;++M){for(var F=_[M],P=0;P<F.length;++P)if("titles"==F[P].type);else if("reharsal"==F[P].type){x=p;var w=F[P].cont;if(h){n(f,x,d,w.name,18)}d+=s.rm_area_height}else if("meas"==F[P].type){x=p;var C=F[P].cont,O=V(f,F[P].macros.x_global_scale,F[P].macros.transpose,F[P].macros.half_type,C,F[P].pm,F[P].nm,d,s,h,F[P].macros.staff);d=O.y_base}h&&M!=_.length-1&&(f=q(e,s),d=s.y_offset)}h||$("#invisible_view").children().remove()}function re(e,t,r,n){var s=e,o=s.path("m 7.45119,0.00462507 c -2.62006,-0.12965 -4.89531,2.48917003 -4.5203,5.06077003 0.30852,2.3265 2.16735,4.12974 4.20376,5.1011599 1.65879,0.86938 3.71404,0.71264 5.22694,1.90481 1.39044,1.02552 1.92776,3.15917 0.89399,4.61515 -0.59006,0.8633 -1.60565,1.57525 -2.69669,1.40546 -0.51026,-0.79781 -0.0548,-1.84761 -0.5841,-2.65244 -0.50017,-0.97685 -1.7314,-1.52668 -2.77051,-1.09339 -1.09273,0.36861 -1.55201,1.78786 -0.96315,2.76184 0.95747,1.95409 3.44952,2.65453 5.45383,2.15374 2.52866,-0.60348 4.08162,-3.66205 3.0424,-6.05383 -0.87324,-2.27646 -3.05164,-3.8349199 -5.33435,-4.4943599 -1.63211,-0.39445 -3.53265,-0.67749 -4.56541,-2.16526 -0.96216,-1.25884 -0.91035,-3.20529 0.26205,-4.31632 0.58015,-0.61405 1.43392,-1.05559 2.29618,-0.91468 0.51027,0.79781 0.0548,1.84762 0.5841,2.65244 0.50017,0.97686 1.7314,1.52668 2.77051,1.09339 1.0378,-0.35178 1.53161,-1.67674 1.0195,-2.63799 C 11.07123,0.77410507 9.16303,-0.05833493 7.45119,0.00462507 z");o.attr({id:"path3001","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"50",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3001");var i=s.path("m 15.97079,8.1489251 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");i.attr({id:"path3807",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3807");var l=s.path("m 3.38842,11.049785 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");l.attr({id:"path3822",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3822");var h=s.path("M 15.69138,2.8164551 C 10.46092,7.2657851 5.23046,11.715125 0,16.164455 c 0.68845,-0.002 1.37691,-0.003 2.06536,-0.005 5.21598,-4.44988 10.43195,-8.8997599 15.64793,-13.3496399 -0.67397,0.002 -1.34794,0.004 -2.02191,0.007 z");h.attr({id:"path3803","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"49.9",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3803");var u=s.set();u.push(o,i,l,h);var p=u.getBBox().height;return null!==n.number&&u.push(a(e,u.getBBox().width,p+4,n.number,20,"lb")),null!==n.opt&&u.push(a(e,u.getBBox().width,p+3,"("+n.opt+")",16,"lb")),u.transform("t"+t+","+r),u}function ae(e,t,r,n,s){var o=e,i=o.path("m 7.36,1.9518304 c -3.1472,0 -5.51238,3.23098 -5.51238,6.97709 0,3.7461196 2.36518,6.9770896 5.51238,6.9770896 3.1472,0 5.51238,-3.23097 5.51238,-6.9770896 0,-3.74611 -2.36518,-6.97709 -5.51238,-6.97709 z m 0,0.84817 c 1.97338,0 3.75892,3.18901 3.75892,6.12892 0,2.9399196 -1.78554,6.1289296 -3.75892,6.1289296 -1.97338,0 -3.75892,-3.18901 -3.75892,-6.1289296 0,-2.93991 1.78554,-6.12892 3.75892,-6.12892 z");i.attr({id:"path3878","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"72.4",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3878");var l=o.path("m 7.2,3.814697e-7 -3.6,0 0,0.7999999985303 3.2,0.40000002 0,7.6 1.2,0 0,-7.6 3.2,-0.40000002 0,-0.7999999985303 z");l.attr({id:"path4413",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4413");var h=o.path("m 7.6,17.6 3.6,0 0,-0.8 -3.2,-0.4 0,-7.5999996 -1.2,0 0,7.5999996 -3.2,0.4 0,0.8 z");h.attr({id:"path4415",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4415");var u=o.path("m 14.8,8.8000004 0,-3.6 -0.8,0 -0.4,3.2 -7.6,0 0,1.2 7.6,0 L 14,12.8 l 0.8,0 z");u.attr({id:"path4417",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4417");var p=o.path("M 0,9.2000004 0,12.8 l 0.8,0 0.4,-3.1999996 7.6,0 0,-1.2 -7.6,0 -0.4,-3.2 -0.8,0 z");p.attr({id:"path4419",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4419");var c=o.set();if(c.push(i,l,h,u,p),null!==s.number&&c.push(a(e,c.getBBox().width,c.getBBox().height+4,s.number,20,"lb")),void 0!==n&&null!==n){var f="l"==n[0]?0:"c"==n[0]?.5:1;t-=f*c.getBBox().width;var d="t"==n[1]?0:"m"==n[1]?.5:1;r-=d*c.getBBox().height}return c.transform("t"+t+","+(r-2)),c}var ne=new Array,se=(new Array,function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}),oe=new i;i.prototype.enqueue=function(e){null!==e.task_type?(e.task_type in this.task_queue||(this.task_queue[e.task_type]=[]),this.task_queue[e.task_type].push(e),console.log("Enqueue task for queue '"+e.task_type+"'. Size = "+this.task_queue[e.task_type].length),1==this.task_queue[e.task_type].length&&setTimeout(e.run.bind(e),0)):setTimeout(e.run.bind(e),0)},i.prototype.finish=function(e){if(null!==e.task_type)if(e.task_type in this.task_queue&&0!=this.task_queue[e.task_type].length&&this.task_queue[e.task_type][0]==e){var t=this.task_queue[e.task_type];t.shift(),console.log("Dequeue task for queue '"+e.task_type+"'. Size = "+t.length),t.length>0&&t[0].run()}else alert("Invalid task execution state detected")},l.prototype.then=function(e){return this.promise.then(e)},l.prototype.run=function(){var e=this.worker(this.context);if(e instanceof l||e instanceof Promise){var t=this;e.then(function(e){null===t.resolve&&alert("Invalid state detected"),t.resolve(e),setTimeout(t.queue.finish.bind(t.queue,t),1)})}else null===this.resolve&&alert("Invalid state detected"),this.resolve(e),setTimeout(this.queue.finish.bind(this.queue,this),1)},l.enqueueFunctionCall=function(e,t,r){return new l({func:e,arguments:t,i:0,func_ret:void 0},function(e){return e.i>0?!0:(ret=e.func.apply(null,e.arguments),e.func_ret=ret,void 0===ret&&(ret=!0),++e.i,ret)},r)},l._ForeachWorker=function(e){var t=new i;new l(e,function(e){return e.worker(e.loopindex,e.looptarget.length,e.looptarget[e.loopindex],e.context)},0,t);var r=new l(e,function(e){if(e.loopindex==e.looptarget.length-1)return e.context;var t=s(e);return t.loopindex++,new l(t,l._ForeachWorker,null)},0,t);return r},l.Foreach=function(e,t,r,a){var n={};n.worker=t,n.context=r,n.looptarget=e,n.loopindex=0;var s=new l(n,l._ForeachWorker,a);return s};var ie=17297280,le=new RegExp;le.compile(/^((sus4?)|(add(9|13))|(alt)|(dim)|(7|9|6|11|13)|((\+|\#)(5|9|13|11))|((\-|b)(5|9|13))|([Mm]([Aa][Jj]?|[Ii][Nn]?)?)|([\,\(\)]))/);var he=2,ue=0,pe=1,ce=3,fe=4,de=5,me=6,ge=9,_e=12,ve=14,be=[_e,de,ue,fe,ve,me,ge,pe,ce];d.getTranpsoedNote=function(e,t,r,a){var n=[["A"],["A#","Bb"],["B","Cb"],["C"],["C#","Db"],["D"],["D#","Eb"],["E","Fb"],["F"],["F#","Gb"],["G"],["G#","Ab"]],s=r;if(void 0!==a&&(s+=a),0==e)return s;var o=0;for(o=0;o<n.length&&!(n[o].indexOf(s)>=0);++o);for(var i=o+e;0>i;)i+=12;var l=n[i%12];if(1==l.length)return l[0];switch(t){case"GUESS":return a&&"#"==a?l[0]:l[1];case"SHARP":return l[0];case"FLAT":return l[1]}return null},d.prototype.getChordStrBase=function(e,t){if(!this.is_valid_chord)return[!1,this.chord_str];var r=null;void 0!==this.note_base&&(r=d.getTranpsoedNote(e,t,this.note_base,this.sharp_flat));var a=null;return void 0!==this.base_note_base&&(a=d.getTranpsoedNote(e,t,this.base_note_base,this.base_sharp_flat)),[r,a]},d.prototype.getChordStr=function(e,t){if(!this.is_valid_chord)return[!1,this.chord_str];var r=null;void 0!==this.note_base&&(r=d.getTranpsoedNote(e,t,this.note_base,this.sharp_flat));var a=null;void 0!==this.base_note_base&&(a=d.getTranpsoedNote(e,t,this.base_note_base,this.base_sharp_flat));var n="";if(null!==this.mid_elems)for(var s=0;s<this.mid_elems.length;++s)switch(this.mid_elems[s].cs){case _e:var o=this.mid_elems[s].s,i="M"==o||"maj"==o.toLowerCase()||"ma"==o.toLowerCase();n+=i?"M":"m";break;case de:var l={11:"%",13:"&"};n+=this.mid_elems[s].s in l?l[this.mid_elems[s].s]:this.mid_elems[s].s;break;case ue:n+="s"+this.mid_elems[s].s.substr(3);break;case fe:n+="d";break;case ge:n+="b"+this.mid_elems[s].s.substr(1);break;case me:n+="#"+this.mid_elems[s].s.substr(1);break;case pe:n+="a"+this.mid_elems[s].s.substr(3);break;case ce:n+=this.mid_elems[s].s;break;case ve:n+=this.mid_elems[s].s}var h=(r?r+n:"")+(a?"/"+a:"");return[!0,h]};var se=function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e};se(b,v),se(k,v),se(w,v),se(y,v),se(E,v),R.prototype.toString=function(){return"D.C."},B.prototype.toString=function(){var e="D.S."+(null===this.number?"":this.number),t=null===this.al?"":" al "+this.al.toString();
return e+t},T.prototype.toString=function(){return"Coda"+(null===this.number?"":this.number)},I.prototype.toString=function(){return"Fine"};var ke=0,we=1,ye=3,xe=4,Ee=5,Re=6,Be=7,Se=8,Te=14,Ae=15,Ie=16,Me=17,Fe=18,Pe=19,Ce=20,Oe=21,Le=22,Ne=23,qe=24,De=25,He=/^(\w[\w\.\,\-\+\#\:]*)/,ze=/^[^\[\]]*/,We=/^[\w\.\,\-\+\#\/\(\)\:\~]*/;M.prototype.onParseError=function(e){var t="Parse error on Line "+this.context.line+" : "+e;throw console.log(t),console.trace(),this.error_msg_callback?this.error_msg_callback(t):alert(t),"Parse error"},M.prototype.nextToken=function(e,t){word_def=He;var r=0;if(t!==!0)for(;e.length>0&&F(e[0]," 	");)e=e.substr(1),++r;if(0==e.length)return{token:null,s:e,type:ke,ss:r};if('"'==e[0]||"'"==e[0]){var a=e[0],n="";for(e=e.substr(1);e.length>0&&e[0]!=a;)n+=e[0],e=e.substr(1);var s=e.length>0&&e[0]==a;return s||this.onParseError("ERROR_WHILE_PARSING_PLAIN_STRING"),e=e.substr(1),{token:n,s:e,type:De,ss:r}}var o=F(e[0],"[]<>(),\n/%=");if(null!=o)return{token:e[0],s:e.substr(1),ss:r,type:[Ee,Re,Be,Se,ye,xe,Ce,Le,Oe,Ne,qe][o.index]};var o=P(e,["||:","||.","||","|"]);if(null!=o)return{token:o.s,s:e.substr(o.s.length),ss:r,type:[Ie,Pe,Ae,Te][o.index]};var i=null;if(i=e.match(/^(\:\|\|\:?)(x(\d+))?/),null!=i){var l=2;return null!=i[2]&&(l=Number(i[3])),{token:i[0],s:e.substr(i[0].length),ss:r,type:":||:"==i[1]?Fe:Me,param:l}}if(i=e.match(word_def),null!=i){var h=i[0];return{token:h,s:e.substr(h.length),type:we,ss:r}}throw"INVALID_TOKEN_DETECTED"},M.prototype.parseGroup=function(e,t,r){for(var a=new Array,n=0;n<e.length;++n){for(var s=e[n][1],o=e[n][0],i=new Array,l=!0;l;){var h=this.nextToken(t);switch(s){case"":h.type!=o&&this.onParseError(r),i.push(h.token),t=h.s,l=!1;break;case"*":if(h.type!=o){l=!1;break}i.push(h.token),t=h.s;break;case"+":if(h.type!=o){if(0!=i.length){loop_flag=!1;break}this.onParseError(r)}i.push(h.token),t=h.s;break;case"?":if(h.type!=o)break;i.push(h.token),t=h.s;break;default:throw"ASSERTION ERROR"}}a.push(i)}return{tokens:a,s:t}},M.prototype.parseReharsalMark=function(e,t){if(m=t.match(ze),null!=m){reharsalMarkName=m[0];var r=this.nextToken(t.substr(m[0].length));if(r.type==Re)return{reharsalMarkName:reharsalMarkName,s:r.s}}throw"Invalid reharsal mark"},M.prototype.parseLoopIndicator=function(e,t){for(var r=!0,a=new Array;r;){var n=this.nextToken(t);if(n.type!=we&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR"),a.push(n.token),t=n.s,n=this.nextToken(t),t=n.s,n.type==Re)break;n.type!=Ce&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR")}return{loopIndicator:new g(a),s:t}},M.prototype.parseTime=function(e,t){var r=0,a=0,n=this.nextToken(t);return t=n.s,n.type!=we&&this.onParseError("ERROR_WHILE_PARSE_TIME"),r=n.token,n=this.nextToken(t),t=n.s,n.type!=Oe&&this.onParseError("ERROR_WHILE_PARSE_TIME"),n=this.nextToken(t),t=n.s,n.type!=we&&this.onParseError("ERROR_WHILE_PARSE_TIME"),a=n.token,n=this.nextToken(t),t=n.s,n.type!=xe&&this.onParseError("ERROR_WHILE_PARSE_TIME"),{time:new _(r,a),s:t}},M.prototype.parseSign=function(e,t){var r=t.indexOf(">");if(0>r)throw"Parse error on Sign";var a=t.slice(0,r);t=t.slice(r+1);var n=this.nextToken(a,He);if(n.type!=we)throw"Error";regDS=/D\.S\.([0-9]+)?/,regCoda=/Coda([0-9]+)?/,regSegno=/S(egno)?([0-9]+)?$/;var s=null;if("Fine"==n.token)sign=new I;else if("D.C."==n.token)sign=new R;else if(null!==(s=n.token.match(regCoda)))sign=new T(void 0===s[1]?null:s[1]);else if(null!==(s=n.token.match(regSegno))){var o=n.s.match(/^\s*(straight|((with\s+)repeat))/);console.log(n.s+"/"+a+o),sign=new S(void 0===s[2]?null:s[2],o?o[1]:null)}else if("to"==n.token){if(n=this.nextToken(n.s,He),n.type!=we)throw"Error";if(s=n.token.match(regCoda),null===s)throw"Error";sign=new A(void 0===s[1]?null:s[1])}else{if(null===(s=n.token.match(regDS)))throw"Error";var i=void 0===s[1]?null:s[1],l=null;if(n=this.nextToken(n.s,He),n.type==ke);else{if(n.type!=we)throw"Error";if("al"!=n.token)throw"Error";if(n=this.nextToken(n.s,He),n.type!=we)throw"Error";if("Fine"==n.token)l=new I;else{if(null===(s=n.token.match(regCoda)))throw"Error";l=new T(void 0===s[1]?null:s[1])}}sign=new B(i,l)}return{sign:sign,s:t}},M.prototype.parseChordSymbol=function(e,t,r){chord_symbol=e;var a=r.match(We);a&&(chord_symbol+=a[0],r=r.substr(a[0].length));var n=new d(chord_symbol);return{s:r,chord:n}},M.prototype.parseRest=function(e,t,r){var a=/^r\:(1|2|4|8|16|32|64)(\.*)$/,n=e.match(a),s=null;return n&&(s=new c(parseInt(n[1]),n[2])),{s:r,rest:s}},M.prototype.parseMeasure=function(e,t){var r=new p;e.type==Te?r.elements.push(new b(1)):e.type==Ae?r.elements.push(new b(2)):e.type==Me?r.elements.push(new w(e.param)):e.type==Ie?r.elements.push(new k):e.type==Fe?r.elements.push(new y(e.param)):e.type==Pe&&r.elements.push(new E);for(var a=!0;a;){var n=this.nextToken(t);switch(n.type){case De:r.elements.push(new d(n.token)),t=n.s;break;case we:var s=this.parseRest(n.token,n.type,n.s);if(null!==s.rest){r.elements.push(s.rest),t=s.s;break}case Oe:var n=this.parseChordSymbol(n.token,n.type,n.s);r.elements.push(n.chord),t=n.s;break;case Be:var n=this.parseSign(n.type,n.s);r.elements.push(n.sign),t=n.s;break;case ye:var n=this.parseTime(n.type,n.s);r.elements.push(n.time),t=n.s;break;case Ee:var n=this.parseLoopIndicator(n.type,n.s);r.elements.push(n.loopIndicator),t=n.s;break;case Te:r.elements.push(new b(1)),a=!1;break;case Ae:r.elements.push(new b(2)),a=!1;break;case Me:r.elements.push(new w(n.param)),a=!1;break;case Ie:r.elements.push(new k),a=!1;break;case Fe:r.elements.push(new y(n.param)),a=!1;break;case Pe:r.elements.push(new E),a=!1;break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURE")}}return{measure:r,s:t}},M.prototype.parseMeasures=function(e,t){for(var r=new Array,a=!0;a;){var n=this.parseMeasure(e,t);switch(t=n.s,r.push(n.measure),n=this.nextToken(t),t=n.s,n.type){case Te:case Ae:case Ie:case Me:case Fe:case Pe:var s=this.nextToken(t);switch(s.type){case Le:a=!1;break;case ke:a=!1;break;default:e=n}break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURES")}}return{measures:r,s:t}},M.prototype.parseMacro=function(e){var t=null,r=null,a=this.nextToken(e);a.type!=we&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),t=a.token,e=a.s;var a=this.nextToken(e);a.type!=qe&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=a.s;var a=this.nextToken(e);return a.type!=De&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=a.s,r=a.token,{key:t,value:r,s:e}},M.prototype.glanceHeader=function(e){for(var t=["TITLE","ARTIST"],r={},a=e.split("\n"),n=0;n<a.length;++n)if(a[n].length>0&&"%"==a[n][0]){var s=this.parseMacro(a[n].substr(1));if(t.indexOf(s.key)>=0&&(r[s.key]=s.value),r.length==t.length)break}return r},M.prototype.parse=function(e){e.replace(/\r\n/g,"\n"),e.replace(/\r/g,"\n");for(var t=null,r=0,a=new h,n=null;;){if(t=this.nextToken(e),t.type==ke)break;if(t.type==Ee?(t=this.parseReharsalMark(t.token,t.s),null!=n&&a.reharsal_groups.push(n),n=new u,n.name=t.reharsalMarkName):[Te,Ae,Ie,Fe,Pe].indexOf(t.type)>=0?(t=this.parseMeasures(t,t.s),n.measures=n.measures.concat(t.measures)):t.type==Ne?(t=this.parseMacro(t.s),n?n.macros[t.key]=t.value:a.macros[t.key]=t.value):t.type==Le?this.context.line+=1:(console.log(t.token),this.onParseError("ERROR_WHILE_PARSE_MOST_OUTSIDER")),e=t.s,r++,r>=1e3)break}null!=n&&(a.reharsal_groups.push(n),n=null);for(var s={},o=0;o<a.reharsal_groups.length;++o){var i=a.reharsal_groups[o];i.name in s?a.reharsal_groups[o]=$.extend(!0,{},s[i.name]):s[i.name]=i}return a},C.prototype.render=function(e,t,r){if(t){l.enqueueFunctionCall(te,[this.canvas,e,!0,this.param,t,r],"render"),l.enqueueFunctionCall(N,[e,this.param],"render");var a=l.enqueueFunctionCall(te,[this.canvas,e,!1,this.param,t,r],"render");return a}te(this.canvas,e,!0,this.param,t,r),N(e,this.param),te(this.canvas,e,!1,this.param,t,r)},C.prototype.clear=function(){for(var e=0;e<ne.length;++e)ne[e].clear();$(this.canvas).children().remove(),ne=new Array};var Ge={},$e=0,je={M:function(e){return[[16,-7,"M"]]},m:function(e){return[[16,-7,"m"]]}},Ue=0,Xe={dim:function(e){return[[16,-7,"d"]]},sus:function(e){return[[18,-9,"s"],[13,-2,e?e:""]]},M:function(e){return[[16,-7,"M"],[13,-2,e?e:""]]},m:function(e){return[[16,-7,"m"]]},add:function(e){return[[20,-10,"a"],[13,-2,e?e:""]]},dig:function(e){return[[13,-2,e?e:""]]}},Ye=0,Je={"#":function(e){return[[13,-2,"+"],[13,-2,e]]},b:function(e){return[[13,-2,"-"],[13,-2,e]]},dig:function(e){return[[13,-2,e]]}},Ke=0,Qe={"#":function(e){return[[13,-2,"#"],[13,-2,e]]},b:function(e){return[[13,-2,"b"],[13,-2,e]]},alt:function(e){return[[13,-2,"alt"]]}},Ve=null,Ze=!1,et=null,tt=!1;return $(document).ready(function(){paper=Raphael($("#invisible_view")[0],500,500);a(paper,100,100,"ABCDEFG#b123456789dsMm",16,"lt","icomoon")}),{Parser:M,Renderer:C}}();