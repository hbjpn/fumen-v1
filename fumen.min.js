var Fumen=function(){function e(e,t,r,n){return"M"+e+","+t+" L"+r+","+n}function t(e,t){for(var r="M",n=0;n<e.length;++n)r+=e[n][0]+","+e[n][1],n<e.length-1&&(r+=" L");return!0===t&&(r+="Z"),r}function r(e){var t="M ";t+=e[0][0]+" "+e[0][1],t+=" C";for(var r=1;r<e.length;++r)t+=e[r][0]+" "+e[r][1]+" ";return t}function n(e,t,r,n,a,s,o){var i=e.text(t,r,n).attr("font-size",a);o&&i.attr("font-family",o);var l=i.getBBox().width,h=i.getBBox().height;return"l"!=s[0]&&"r"!=s[0]||i.attr("x",i.attr("x")+l/2*("l"==s[0]?1:-1)),"t"!=s[1]&&"b"!=s[1]||i.attr("y",i.attr("y")+h/2*("t"==s[1]?1:-1)),i}function a(e,t,r,a,s){var o=e.set(),i=n(e,t,r,a,s,"lt"),l=i.getBBox().width,h=i.getBBox().height,u=0*h,p=.1*h,c=e.rect(t,r,l+2*p,h+2*u);return i.attr("x",i.attr("x")+p),i.attr("y",i.attr("y")+u),o.push(i,c),o}function s(e){return jQuery.extend({},e)}function i(e){return jQuery.extend(!0,{},e)}function l(){this.task_queue={}}function h(e,t,r,n){void 0===r&&(r=null),this.task_type=r,this.context=e,this.worker=t,this.promise=null,this.resolve=null,this.reject=null;var a=this;this.promise=new Promise(function(e,t){a.resolve=e,a.reject=t}),n=void 0===n?null:n,this.queue=n||me,this.queue.enqueue(this)}function u(){this.reharsal_groups=new Array,this.macros={}}function p(){this.name=null,this.measures=new Array,this.macros={}}function c(){this.elements=new Array,this.boundary_info=["n","n"],this.header_width=0,this.body_width=0,this.footer_width=0,this.body_scaling=1,this.new_line=!1,this.renderprop={}}function f(e,t){var r=ge/e;this.length_s=""+e+(t||""),this.length=ge/e;for(var n=t||"",a=0;a<n.length;++a)r/=2,this.length+=r;this.renderprop={}}function d(e){for(var t=[],r=[];e.length>0;){if(m=e.match(_e),null===m)return console.log("Invalid code notation : "+e),null;for(a=0;a<Te.length;++a)if(void 0!==m[ve+Te[a]]&&null!==m[ve+Te[a]]){t.push({cs:Te[a],s:m[0],g:m});break}e=e.substr(m[0].length)}for(var n=!1,a=0;a<t.length;++a)switch(t[a].cs){case Se:var s="M"==(e=t[a].s)||"maj"==e.toLowerCase()||"ma"==e.toLowerCase();0==s&&(n=!0),n&&1==s?t[a+1].cs==xe&&(r.push({type:"M",param:t[a+1].s}),++a):s?r.push({type:"M"}):r.push({type:"m"});break;case xe:r.push({type:"dig",param:t[a].s});break;case be:r.push({type:"sus",param:t[a].s.substr(3)});break;case ye:r.push({type:"dim"});break;case Re:r.push({type:"b",param:t[a].s.substr(1)});break;case Ee:r.push({type:"#",param:t[a].s.substr(1)});break;case ke:r.push({type:"add",param:t[a].s.substr(3)});break;case we:r.push({type:"alt"})}return[t,r]}function g(e){this.chord_str=e,this.is_valid_chord=!0,this.length=ge,this.length_s=null,this.tie=!1,this.renderprop={};var t=/^(((A|B|C|D|E|F|G)(#|b)?([^\/\:]*))?(?:\/(A|B|C|D|E|F|G)(#|b)?)?)(:(\d+)(\.*))?(\~)?/,r=e.match(t);if(r&&""!=r[0]){if(this.chord_name_str=r[1],this.note_base=r[3],this.sharp_flat=r[4],this.mid_str=r[5],this.base_note_base=r[6],this.base_sharp_flat=r[7],this.mid_elems=null,void 0!==this.mid_str){var n=d(this.mid_str);null!==n&&(this.mid_elems=n[0],this.mid_elem_objs=n[1]),this.is_valid_chord=null!==n}if(r[8]){var a=r[10]?r[10]:"";this.length_s=r[9]+(r[10]?r[10]:""),this.length=ge/parseInt(r[9]);for(var s=ge/parseInt(r[9]),o=0;o<a.length;++o)s/=2,this.length+=s}this.tie="~"==r[11]}else this.chord_name_str=this.chord_str,this.is_valid_chord=!1}function _(e){this.indicators=e,this.intindicators=[];for(var t=new RegExp(/(\d+)/),r=0;r<this.indicators.length;++r)m=this.indicators[r].match(t),m&&this.intindicators.push(parseInt(m[0]))}function v(e){this.longrestlen=e}function b(e,t){this.numer=e,this.denom=t}function k(){}function w(e){this.nline=e}function y(){}function E(e){this.times=e}function R(e){this.times=e}function S(){}function T(){}function I(e,t){this.number=e,this.al=t}function B(e,t){this.number=e,this.opt=t}function A(e){this.number=e}function M(e){this.number=e}function P(){}function C(e){this.context={line:0,char:0},this.error_msg_callback=e}function O(e,t){for(var r=0;r<t.length;++r)if(t[r]==e)return{r:!0,index:r};return null}function F(e,t){for(var r=0;r<t.length;++r)if(0==e.indexOf(t[r]))return{index:r,s:t[r]};return null}function L(e,t,r){this.canvas=e,this.param={row_interval:70,y_title_offset:50,y_author_offset:90,y_first_page_offset:120,y_offset:70,x_offset:70,min_measure_width:100,row_height:24,row_margin:25,rs_area_height:24,rm_area_height:30,mh_area_height:25,header_body_margin:10,max_scaling:1.2,paper_width:t,paper_height:r,repeat_mark_font:{"font-family":"Times New Roman","font-style":"italic","font-weight":"bold"}},this.track=null}function q(e,t){return e.rgi<t.rgi||!(e.rgi>t.rgi)&&e.mi<t.mi}function N(e,t){return e.rgi==t.rgi&&e.mi==t.mi}function D(e,t){return q(e,t)||N(e,t)}function H(e,t,r,n){void 0===n&&(n={}),void 0===n.auto_scroll&&(n.auto_scroll=!1),this.param=n,this.sequence=[],this.hasValidStructure=!1,this.cb_play=void 0==t?null:t,this.cb_stop=void 0==r?null:r,this.lastloopstart={rg:null,m:null},this.segnos={};for(var a={rgi:0,mi:-1},s=function(t){return e.reharsal_groups[t.rgi].measures[t.mi]},o=function(t){for(;;){if(t.rgi>=e.reharsal_groups.length)return null;if(t.mi>=e.reharsal_groups[t.rgi].measures.length?(t.mi=0,t.rgi++):t.mi++,t.rgi<e.reharsal_groups.length&&t.mi<e.reharsal_groups[t.rgi].measures.length)return e.reharsal_groups[t.rgi].measures[t.mi]}},l=new b(4,4),h=0,u=o(a),p=u,c=i(a),f=null,d={},m={},g=null,k=0;u;){if(k++>1e3)throw"Error : Analyzing error : Infinite loop detected.";for(var w=!0,x=z(u),S=!1,C=0;C<x.measure_wide.length;++C)if((G=x.measure_wide[C])instanceof _){if(f){if(G.intindicators.indexOf(f.cnt)>=0)break;for(;u=o(a);)if(W(u,function(e){return e instanceof _&&e.intindicators.indexOf(f.cnt)>=0})){S=!0;break}break}throw"Invalid loop indicator detected"}if(!S){for(var O=null,C=0;C<x.measure_wide.length;++C)(G=x.measure_wide[C])instanceof v&&(O=parseInt(G.longrestlen));for(C=0;C<x.header.length;++C)(G=x.header[C])instanceof y||G instanceof R?f&&N(f.p,a)?f.cnt++:f={p:i(a),cnt:1}:G instanceof B?G.numnber in d||(d[G.number]={p:i(a)}):G instanceof A||G instanceof b&&(l=G);if(null!==O)for(var F=0;F<O;++F){L={t:h,duration:l.numer/l.denom};this.sequence.push([L,u]),h+=L.duration}else{var L={t:h,duration:l.numer/l.denom};this.sequence.push([L,u]),h+=L.duration}console.log("Push : "),console.log(u),console.log(L);for(var H=!1,C=0;C<x.footer.length;++C){var G=x.footer[C];if(G instanceof E||G instanceof R){if(f.cnt<G.times){u=s(f.p),a=i(f.p),w=!1;break}f=null}else if(G instanceof I){if(!(G.number in d))throw"Segno not found";for(var $ in m)q(m[$].p,a)&&D(d[G.number].p,m[$].p)&&(m[$].valid=!0);g&&q(g.p,a)&&D(c,g.p)&&(g.valid=!0),u=s(d[G.number].p),a=i(d[G.number].p),w=!1,f=null}else{if(G instanceof T){for(var $ in m)q(m[$].p,a)&&D(c,m[$].p)&&(m[$].valid=!0);g&&q(g.p,a)&&D(c,g.p)&&(g.valid=!0),u=p,a=i(c),w=!1,f=null;break}if(G instanceof M){if(G.number in m&&m[G.number].valid){for(w=!1;(u=o(a))&&!W(u,function(e){return e instanceof A&&e.number==G.number}););break}m[G.number]={valid:!1,p:i(a)}}else G instanceof P&&(g?g.valid&&(H=!0):g={valid:!1,p:i(a)})}}if(H)break;w&&(u=o(a))}}}function z(e){for(var t=e,r=new Array,n=new Array,a=new Array,s=new Array,o=0;o<t.elements.length;++o){var i=t.elements[o];0==o?r.push(i):o==t.elements.length-1?a.push(i):i instanceof g?n.push(i):i instanceof f?n.push(i):i instanceof _?s.push(i):i instanceof v?s.push(i):i instanceof b?r.push(i):i instanceof T?a.push(i):i instanceof I?a.push(i):i instanceof B?r.push(i):i instanceof A?r.push(i):i instanceof M?a.push(i):i instanceof P&&a.push(i)}return{header:r,body:n,footer:a,measure_wide:s}}function W(e,t){for(var r=e,n=0;n<r.elements.length;++n){var a=r.elements[n];if(t(a))return a}return null}function G(e,t,r){for(var n=0,a=null,s=null;null!==(a=t(n++))&&a<e.length;){var o=void 0!==r?r(e[a]):e[a];s=null===s?o:Math.max(o,s)}return s}function j(e,t){console.log("Identify scaling called");for(var r=t.paper_width-2*t.x_offset,n=0;n<e.reharsal_groups.length;++n){for(var a=e.reharsal_groups[n],s=0,o=(new Array,new Array,0),i=0;i<a.measures.length;++i)if(o=i+1,(s+=(g=a.measures[i]).header_width+g.body_width+g.footer_width)>r){o--;break}for(var l=a.measures.length,h=o,u=new Array,p=0;h>0;--h){for(d=0;d<h;++d){var c=G(a.measures,function(e){return e*h+d},function(e){return e.header_width+e.body_width+e.footer_width});p+=c,u.push(c)}if(p<=r&&(h%2==0||1==h||h==l))break;p=0,u=new Array}for(var f=0,d=0;d<h;++d)f+=u[d];f/=h,p=0;for(d=0;d<h;++d)u[d]=u[d]-.25*(u[d]-f),p+=u[d];for(var m=r/p,i=0;i<a.measures.length;++i){var g=a.measures[i],_=Math.floor(i/h),v=i-_*h,b=u[v]*m-(g.header_width+g.footer_width);g.new_line=0==v&&_>0,g.body_scaling=b/g.body_width}}}function U(e,t){var r=fe.length;$(e).append("<div id='page"+r+"'></div>");var a=$(e).children("#page"+r)[0];return paper=Raphael(a,t.paper_width,t.paper_height),fe.push(paper),paper.canvas.style.backgroundColor="#FFFFFF",n(paper,t.paper_width/2,t.paper_height-40,"Generated by fumen ver 0.1",12,"ct"),Me={},paper}function X(e){if(null===e)return"n";if(e instanceof w){if(1==e.nline)return"s";if(2==e.nline)return"d"}else{if(e instanceof y)return"b";if(e instanceof E)return"e";if(e instanceof R)return"B";if(e instanceof S)return"f"}throw"Invalid boundary object"}function Y(e,t){var r={ss:"s",sd:"d",sb:"b",sn:"s",ds:"d",dd:"d",db:"b",dn:"d",es:"e",ed:"e",ee:"e",eb:"B",en:"e",bb:"b",BB:"B",fn:"f",ns:"s",nd:"d",nb:"b"},n=X(e)+X(t);if(n in r)return r[n];throw"Invalid boundary pair : "+n}function Q(e,t,r){var n={ss:"ss",sd:"sd",sb:"sb",ds:"ds",dd:"dd",db:"db",es:"es",ed:"ed",ee:"es",eb:"eb",bb:"sb",BB:"eb"},a=X(e)+X(t);if(a in n)return n[a]["begin"==r?1:0];throw"Invalid boundary pair : "+a}function V(t,r,a,s,o,i,l,h,u){var p=h.row_height,c=null,f=i;if("end"==t&&!(null===a||s))return{x:i,bx:f};switch(c=null===s||0==s?Y(r,a):Q(r,a,t)){case"s":case"d":for(var d="s"==c?1:2,m=0;m<d;++m)u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),d>=2&&m<d-1&&(i+=3);f=i;break;case"b":u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=4,u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"});break;case"e":u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"}),i+=4,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),null!==r.times&&2!=r.times&&u&&(text=n(o,i,l+p+8,"(x"+r.times+")",13,"rc")),f=i;break;case"B":u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"}),i+=4,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"}),f=i,i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),null!==r.times&&2!=r.times&&u&&(text=n(o,i,l+p+8,"(x"+r.times+")",13,"rc")),i+=4,u&&o.circle(i,l+p/4*1.5,1).attr({fill:"black"}),u&&o.circle(i,l+p/4*2.5,1).attr({fill:"black"});break;case"f":u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"1"}),i+=3,u&&o.path(e(i,l,i,l+p)).attr({"stroke-width":"2"});break;default:throw"Internal error"}return{x:i,bx:f}}function J(e,t,r,a,s,o,i,l,h,u,p){var c=i.row_height,f=e.getChordStr(t,r),d=a.set(),m=n(a,s,o+c/2,f[1],16,"lc",f[0]?"icomoon":null);return s+=m.getBBox().width*u*p,s+=h*p,l||m.remove(),d.push(m),{group:d,x:s}}function K(e,t,a,s,o,i,l,h,u,p,c){var f=l.row_height;if(e.renderprop.x=o,!e.is_valid_chord)return J(e,t,a,s,o,i,l,h,u,p,c);var d=[o,i];if(h&&e.chord_name_str in Me){var m=Me[e.chord_name_str];(b=m[0].clone()).attr({opacity:1});var g=m[1];return b.transform("T "+(d[0]-g[0])+" "+(d[1]-g[1])),o+=b.getBBox().width*p*c,o+=u*c,isFinite(o)||console.error("Illegal calculation of x detected"),{group:b,x:o}}var _=e.getChordStrBase(t,a),v=e.mid_elem_objs,b=s.set(),k=[],w=[],y=[],x=[];if(v){for(var E=!1,R=!1,S=0;S<v.length;++S)switch((N=v[S]).type){case"M":void 0!==N.param?y.push(N):k.push(N);break;case"m":k.push(N);break;case"add":case"sus":y.push(N);break;case"dig":y.push(N),E|="6"==N.param,R|="9"==N.param;break;case"b":case"#":"5"==N.param?w.push(N):x.push(N);break;case"dim":y.push(N);break;case"alt":x.push(N)}if(E&&R)for(S=0;S<y.length;++S)if("dig"==y[S].type&&"6"==y[S].param){w.push(y[S]),y.splice(S,1);break}}var T=null,I=o;_[0]&&(T=n(s,I,i+f/2,_[0],18,"lc","icomoon"),b.push(T),I+=T.getBBox().width);var B=0;if(k.length>0){for(var A=Ce[k[0].type](k[0].param),M=0,S=0;S<A.length;++S)T=n(s,I+M,i+f/2+A[S][1]+Pe,A[S][2],A[S][0],"lt","icomoon"),b.push(T),M+=T.getBBox().width;B=M}var P=0;if(w.length>0){for(var A=qe[w[0].type](w[0].param),M=0,S=0;S<A.length;++S)T=n(s,I+M,i+f/2+A[S][1]+Le,A[S][2],A[S][0],"lb","icomoon"),b.push(T),M+=T.getBBox().width;P=M}var C=B;if(y.length>0){for(var M=0,O=0;O<y.length;++O)for(var A=Fe[y[O].type](y[O].param),S=0;S<A.length;++S)""!=A[S][2]&&(M+=(T=n(s,I+B+M,i+f/2+A[S][1]+Oe,A[S][2],A[S][0],"lt","icomoon")).getBBox().width,b.push(T));C+=M}I+=Math.max(P,C);for(var F=0,L=0,q=1e4,S=0;S<x.length;++S){for(var N=x[S],A=De[N.type](N.param),D=0,H=0,z=0;z<A.length;++z)q=Math.min(q,i+L+A[z][1]+Ne),T=n(s,I+5+D,i+L+A[z][1]+Ne,A[z][2],A[z][0],"lt","icomoon"),b.push(T),D+=T.getBBox().width,H=Math.max(H,T.getBBox().height);L+=H+1,F=Math.max(F,D)}if(x.length>0){var W=[[I+5,q],[I,q],[I,q+L],[I+5,q+L]],G=s.path(r(W)).attr("stroke-width","1px"),$=[[I+5+F,q],[I+5+F+5,q],[I+5+F+5,q+L],[I+5+F,q+L]],j=s.path(r($)).attr("stroke-width","1px");b.push(G),b.push(j),F+=10}if(I+=F,_[1]&&(T=n(s,I,i+f/2,"/",26,"lc"),b.push(T),T=n(s,I+=T.getBBox().width,i+f/2,_[1],18,"lc","icomoon"),b.push(T),I+=T.getBBox().width),o+=b.getBBox().width*p*c,o+=u*c,h||T.remove(),h){var U=b.clone();U.attr({opacity:0}),Me[e.chord_name_str]=[U,d]}return isFinite(o)||console.error("Illegal calculation of x detected"),{group:b,x:o}}function Z(e,r,n,a,s,o){var i=t([[n,a],[n+10,a-10],[n+10,a-10+4],[n,a+4]],!0),l=null;l="1"==s||"2"==s?e.path(i).attr({"stroke-width":"1px"}):e.path(i).attr({fill:"#000000"}),r.push(l);for(var h=0;h<o;++h)r.push(e.circle(n+10+5+5*h,a-6,1).attr({fill:"black"}));return r}function ee(e,t){for(var r=[],n=[],a=null,s=0;s<e.length;++s)null!=a&&a!=t(e[s])&&(r.push(n),n=[]),a=t(e[s]),n.push(e[s]);return r.push(n),r}function te(e,t,r,n,a,s,o){for(var i=r+s.row_height+10,l=e.set(),h=0;h<a;++h)Z(e,l,t+n/4*h,i,"0",0)}function re(e){return{1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7}[e]}function ne(t,r,n,a,s,i,l){if(n.groups.length>=2){var h=n.groups[0].coord,u=n.groups[n.groups.length-1].coord,p=t.path(e(h[0],h[1],u[0],u[1])).attr({"stroke-width":l});r.push(p);for(var c=ee(n.groups,function(e){return e.onka}),f=0;f<c.length;++f){var d=c[f],m=d[0].onka,g=re(parseInt(m))-2;if(1==d.length){var _=d[0].coord,v=1;f==c.length-1&&(v=-1);for(var b=c[f+v][c[f+v].length-1].coord[0],k=.3*Math.abs(b-_[0]),w=0;w<g;++w)o=t.path(e(_[0],a+s-w*i,_[0]+v*k,a+s-w*i)).attr({"stroke-width":l}),r.push(o)}else if(d.length>=2)for(var _=d[0].coord,y=d[d.length-1].coord,w=0;w<g;++w)o=t.path(e(_[0],_[1]-w*i,y[0],y[1]-w*i)).attr({"stroke-width":l}),r.push(o)}}else if(1==n.groups.length)for(var h=n.groups[0].coord,m=n.groups[0].onka,g=re(parseInt(m))-2,w=0;w<g;++w)o=t.path("M"+(h[0]+10)+","+(a+s-10-w*i)+"L"+h[0]+","+(a+s-w*i)).attr({"stroke-width":"1px"}),r.push(o)}function ae(e,t,n,a,s,o,i,l,h,u){var p=n+o.row_height+10;balken={groups:[],sum_len:0};for(var c=!1,f=t.set(),d=0;d<e.length;++d){var m=e[d],_=m.renderprop.x;if(null!==m.length_s&&void 0!==m.length_s){var v=m.length_s.match(/[0-9]+/)[0],b=m.length_s.substr(v.length);if(m instanceof g)if(c=!0,"0"==v||"1"==v)Z(t,f,_,p,v,b.length);else{Z(t,f,_,p,v,b.length);var k=t.path("M"+_+","+p+"L"+_+","+(p+20)).attr({"stroke-width":"1px"});f.push(k)}if(u&&((m.length>=ge/4||balken.sum_len%(ge/4)==0)&&(ne(t,f,balken,p,20,5,"4px"),balken.groups=[]),balken.sum_len+=m.length,m.length<ge/4&&m instanceof g&&balken.groups.push({coord:[m.renderprop.x,p+20],onka:v}),d==e.length-1&&ne(t,f,balken,p,20,5,"4px")),m instanceof g){if(ze){var w=-10,y=He,x=[_,p,a,s];if(y[1]!=x[1]){E=[[y[0]+12,y[1]+w],[y[0]+12,y[1]-8+w],[y[3]+20,y[1]-8+w],[y[3]+20,y[1]+w]];clip=y[0]+12+","+(y[1]-50)+","+(y[3]-(y[0]+12)+5)+",100",console.log("clip:"+clip);R=We.path(r(E)).attr("stroke-width","2px").attr({"clip-rect":clip});We.set().push(R),E=[[x[2]-20,x[1]+w],[x[2]-20,x[1]-8+w],[x[0],x[1]-8+w],[x[0],x[1]+w]],clip=x[2]-5+","+(x[1]-50)+","+(x[0]-(x[2]-5))+",100",console.log("clip:"+clip),R=t.path(r(E)).attr("stroke-width","2px").attr({"clip-rect":clip}),f.push(R)}else{var E=[[y[0]+12,y[1]+w],[y[0]+12,y[1]-8+w],[x[0],x[1]-8+w],[x[0],x[1]+w]],R=t.path(r(E)).attr("stroke-width","2px");f.push(R)}}ze=m.tie,He=[_,p,a,s],We=t}}}return c?f:null}function se(t,r,a,s,o,i,l,h,u,p,c){var d=(xe=n(t,0,0,"C7",16,"lc","icomoon")).getBBox().width;xe.remove();var m=!1,w=!1;"ON"==c&&(m=!0);for(L=0;L<o.length;++L)for(var y=o[L],E=0;E<y.elements.length;++E)(oe=y.elements[E])instanceof A||oe instanceof B?w=!0:oe instanceof g&&(m|=null!==oe.length_s);"OFF"==c&&(m=!1);for(var R=m?u.row_height+5:0,S=h+(w?u.mh_area_height:0),C=[],O=x,F=x,L=0;L<o.length;++L){for(var y=o[L],q=x,N=x,D=x,H=z(y),W=0,G=!1,E=0;E<H.header.length;++E)(oe=H.header[E])instanceof A?(G=!0,p&&ce(t,q,h,"lt",oe)):oe instanceof B&&(G=!0,p&&pe(t,q,h+3,oe));G&&(W+=u.mh_area_height);for(E=0;E<H.header.length;++E)if((oe=H.header[E])instanceof k){var $=0==L?i:o[L-1],j=V("begin",ye=$?$.elements[$.elements.length-1]:null,oe,y.new_line,t,x,S+R,u,p);y.renderprop.y=S+R,y.renderprop.sx=x,y.renderprop.paper=t,x=j.x,N=j.bx}else if(oe instanceof b){x+=4;var U=0,X=n(t,Ae=x,S+R,oe.numer,12,"lt","icomoon");U=X.getBBox().width;var Y=n(t,Ae,S+u.row_height/2+R,oe.denom,12,"lt","icomoon");U=Math.max(U,Y.getBBox().width),X.attr({x:X.attr("x")+(U-X.getBBox().width)/2}),Y.attr({x:Y.attr("x")+(U-Y.getBBox().width)/2});Re=S+u.row_height/2;p&&!m&&t.path(e(Ae,Re,Ae+U,Re)).attr({"stroke-width":"1"}),x+=U}x+=u.header_body_margin,y.header_width=x-q;for(var Q=x,J=0,Z=!0,ee=0,ne=[],E=0;E<H.body.length;++E)((oe=H.body[E])instanceof g||oe instanceof f)&&(++J,(Z&=null!==oe.length)&&(ee+=oe.length),ne.push(oe));for(var se=null,E=0;E<H.body.length;++E){var oe=H.body[E],ie=0;if(ie=Z?Math.floor(40*r/ee*oe.length):Math.floor(40*r/J),oe instanceof g){var le=K(oe,a,s,t,x,S,u,p,ie,r,y.body_scaling);x=le.x,isFinite(x)||console.log("Illegal calculation of x is detected"),(Ge||oe.is_valid_chord&&se==oe.chord_name_str)&&le.group.remove(),Ge=oe.tie,se=oe.chord_name_str}else{if(!(oe instanceof f))throw"ERROR";var he={1:"",2:"",4:"",8:"",16:"",32:""},ue={1:0,2:0,4:0,8:0,16:7,32:7,64:14,128:14},fe=parseInt(oe.length_s),de=t.set(),me=ue[fe];if(fe<=4){xe=n(t,x,S+u.row_height/2+R,he[fe],14,"lc","icomoon");de.push(xe)}else for(var ge=re(fe)-2,_e=-7,ve=0;ve<ge;++ve){xe=n(t,x+2*ve,S+u.row_height/2+R+ve*_e+me,"",14,"lc","icomoon");de.push(xe)}x+=d*r*y.body_scaling,x+=ie*y.body_scaling,oe.renderprop.x=x,p||de.remove()}}0==H.body.length&&(x+=d*r*y.body_scaling,x+=40*r*y.body_scaling),y.body_width=x-Q;for(var be=x,E=0;E<H.footer.length;++E){var ke=m?"l":"r";if((oe=H.footer[E])instanceof k){var we=L==o.length-1?l:o[L+1],ye=we?we.elements[0]:null,j=V("end",oe,ye,!!we&&we.new_line,t,x,S+R,u,p);y.renderprop.ex=x,x=j.x}else if(oe instanceof T)xe=n(t,x,S-8+R,oe.toString(),15,ke+"c").attr(u.repeat_mark_font),m&&(x+=xe.getBBox().width);else if(oe instanceof I)xe=n(t,x,S-8+R,oe.toString(),15,ke+"c").attr(u.repeat_mark_font),m&&(x+=xe.getBBox().width);else if(oe instanceof M)if(m){var xe=n(t,x,S+R,"To",15,"lb").attr(u.repeat_mark_font);x+=xe.getBBox().width+5;Ee=ce(t,x,S+R,"lb",oe);x+=Ee.getBBox().width}else{var Ee=ce(t,x,S+R,"rb",oe);xe=n(t,x-1.5*Ee.getBBox().width,S+R,"To",15,"rb").attr(u.repeat_mark_font)}else{if(!(oe instanceof P))throw"ERROR";xe=n(t,x,S-8+R,oe.toString(),15,ke+"c").attr(u.repeat_mark_font),m&&(x+=xe.getBBox().width)}}y.footer_width=x-be,F=D=x;for(E=0;E<H.measure_wide.length;++E)if((oe=H.measure_wide[E])instanceof _){var Re=S-2-(me=10),Se=N,Te=D;p&&t.path(e(Se,Re,Se,Re+me)).attr({"stroke-width":"1"}),p&&t.path(e(Se,Re,Te,Re)).attr({"stroke-width":"1"});var Ie=oe.indicators.join(",");p&&n(t,Se+2,Re,Ie,10,"lt")}else{if(!(oe instanceof v))throw"Unkown measure wide instance detected";var Se=N+y.header_width-u.header_body_margin,Te=D-y.footer_width,Be=u.row_height;lrmargin=Math.max(5,Math.min(20,.05*(Se+Te)));var Ae=Se+lrmargin,Me=Te-lrmargin;p&&t.path(e(Ae,S+u.row_height/2,Me,S+u.row_height/2)).attr({"stroke-width":"7"}),p&&t.path(e(Ae,S+.2*Be,Ae,S+Be-.2*Be)).attr({"stroke-width":"1"}),p&&t.path(e(Me,S+.2*Be,Me,S+Be-.2*Be)).attr({"stroke-width":"1"}),p&&n(t,(Se+Te)/2,S,oe.longrestlen,14,"cm","icomoon")}if(W+=u.row_height,m){var Pe=ae(ne,t,S+(_e=10),N,D,u,p,0,y.body_scaling,Z);W+=u.rs_area_height,Pe||te(t,Q,S+_e,y.body_width,4,u,y.body_scaling)}W+=u.row_margin,y.renderprop.meas_height=W,C.push(W)}if(m)for(var Ce=0;Ce<5;++Ce){p&&t.path(e([[O,S+u.row_height+6*Ce+5],[F,S+u.row_height+6*Ce+5]])).attr({"stroke-width":"1px"})}return h+=Math.max.apply(null,C),{y_base:h}}function oe(e){var t={};if(t.x_global_scale=1,"XSCALE"in e.macros&&(t.x_global_scale=parseFloat(e.macros.XSCALE)),t.transpose=0,"TRANSPOSE"in e.macros){var r=parseInt(e.macros.TRANSPOSE);isNaN(r)||(t.transpose=r)}return t.half_type="GUESS","HALF_TYPE"in e.macros&&(t.half_type=e.macros.HALF_TYPE),t.staff="AUTO","STAFF"in e.macros&&(t.staff=e.macros.STAFF),t}function ie(e,t){var r=$.extend(!0,{},e);if("XSCALE"in t.macros&&(r.x_global_scale=parseFloat(t.macros.XSCALE)),"TRANSPOSE"in t.macros){var n=parseInt(t.macros.TRANSPOSE);isNaN(n)||(r.transpose=n)}return"HALF_TYPE"in t.macros&&(r.half_type=t.macros.HALF_TYPE),"STAFF"in t.macros&&(r.staff=t.macros.STAFF),r}function le(){return $("body").append("<div id='invisible_view2'></div>"),$("#invisible_view2").css({opacity:.2,position:"absolute",top:0,left:0}),paper=Raphael($("#invisible_view2")[0],1,1),paper}function he(){$("#invisible_view2").remove()}function ue(e,t,r,s,o,i){var l=!r;console.log("render_impl called with "+l);var u=s.y_title_offset,p=s.x_offset,c=s.paper_width-2*p,f=null;f=l?U(e,s):le();var d=s.y_first_page_offset,m="No Name";"TITLE"in t.macros&&(l&&n(f,p+c/2,u,t.macros.TITLE,24,"ct"),m=t.macros.TITLE),"ARTIST"in t.macros&&(l&&n(f,p+c,s.y_author_offset,t.macros.ARTIST,14,"rt"),m+="/"+t.macros.ARTIST);var g=oe(t);console.log("render_impl called with "+l+" : Making pagination");var _=[];if(l){for(var v=[{type:"titles",height:s.y_first_page_offset}],b=0;b<t.reharsal_groups.length;++b){B=ie(g,t.reharsal_groups[b]);console.group("Macro for "+t.reharsal_groups[b].name),console.log(B),console.groupEnd(),v.push({type:"reharsal",height:s.rm_area_height,cont:t.reharsal_groups[b]});for(var k=t.reharsal_groups[b],w=0,y=[],E=null,R=0;R<k.measures.length;++R){var S=k.measures[R];S.new_line&&(v.push({type:"meas",height:w,cont:y,nm:S,pm:E,rg:t.reharsal_groups[b],macros:B}),w=0,y=[],E=R>0?k.measures[R-1]:null),y.push(S),w=Math.max(w,S.renderprop.meas_height)}w>0&&v.push({type:"meas",height:w,cont:y,nm:null,pm:E,rg:t.reharsal_groups[b],macros:B})}for(var T=0,I=[],b=0;b<v.length;++b)T+v[b].height<=s.paper_height-s.y_offset?(T+=v[b].height,I.push(v[b])):(_.push(I),I=[v[b]],T=v[b].height);I.length>0&&_.push(I),console.log("////////"),console.log(_)}else{for(var v=[{type:"titles",height:p}],b=0;b<t.reharsal_groups.length;++b){var B=ie(g,t.reharsal_groups[b]);v.push({type:"reharsal",height:s.rm_area_height,cont:t.reharsal_groups[b]});k=t.reharsal_groups[b];v.push({type:"meas",height:0,cont:k.measures,nm:null,pm:null,rg:t.reharsal_groups[b],macros:B})}_.push(v)}if(console.log("render_impl called with "+l+" : Invoke async loop execution"),o)return h.Foreach(_,function(t,r,o,l){return h.Foreach(o,function(e,r,n,s){if(i&&i((s.draw?"":"Pre-")+"Rendering block "+e+" in page "+(t+1)+" of "+m),"titles"==n.type);else if("reharsal"==n.type){x=p;var o=n.cont;if(s.draw)a(s.paper,x,s.y_base,o.name,18);s.y_base+=s.param.rm_area_height}else if("meas"==n.type){x=p;var l=n.cont,h=se(s.paper,n.macros.x_global_scale,n.macros.transpose,n.macros.half_type,l,n.pm,n.nm,s.y_base,s.param,s.draw,n.macros.staff);s.y_base=h.y_base}},l,"renderpageelemloop"),h.enqueueFunctionCall(function(){footerstr=m+" - "+(t+1)+" of "+_.length,n(l.paper,s.paper_width/2,s.paper_height-60,footerstr,12,"ct"),l.draw&&t!=_.length-1&&(l.paper=U(e,l.param),l.y_base=l.param.y_offset)},[],"renderpageelemloop")},{param:s,draw:l,paper:f,y_base:d},"renderpageloop"),h.enqueueFunctionCall(function(){l||he()},[],"renderpageloop");for(var A=0;A<_.length;++A){for(var M=_[A],P=0;P<M.length;++P)if("titles"==M[P].type);else if("reharsal"==M[P].type){x=p;k=M[P].cont;if(l)a(f,x,d,k.name,18);d+=s.rm_area_height}else if("meas"==M[P].type){x=p;var C=M[P].cont;d=se(f,M[P].macros.x_global_scale,M[P].macros.transpose,M[P].macros.half_type,C,M[P].pm,M[P].nm,d,s,l,M[P].macros.staff).y_base}footerstr=m+" - "+(A+1)+" of "+_.length,n(f,s.paper_width/2,s.paper_height-60,footerstr,12,"ct"),l&&A!=_.length-1&&(f=U(e,s),d=s.y_offset)}l||he()}function pe(e,t,r,a){var s=e,o=s.path("m 7.45119,0.00462507 c -2.62006,-0.12965 -4.89531,2.48917003 -4.5203,5.06077003 0.30852,2.3265 2.16735,4.12974 4.20376,5.1011599 1.65879,0.86938 3.71404,0.71264 5.22694,1.90481 1.39044,1.02552 1.92776,3.15917 0.89399,4.61515 -0.59006,0.8633 -1.60565,1.57525 -2.69669,1.40546 -0.51026,-0.79781 -0.0548,-1.84761 -0.5841,-2.65244 -0.50017,-0.97685 -1.7314,-1.52668 -2.77051,-1.09339 -1.09273,0.36861 -1.55201,1.78786 -0.96315,2.76184 0.95747,1.95409 3.44952,2.65453 5.45383,2.15374 2.52866,-0.60348 4.08162,-3.66205 3.0424,-6.05383 -0.87324,-2.27646 -3.05164,-3.8349199 -5.33435,-4.4943599 -1.63211,-0.39445 -3.53265,-0.67749 -4.56541,-2.16526 -0.96216,-1.25884 -0.91035,-3.20529 0.26205,-4.31632 0.58015,-0.61405 1.43392,-1.05559 2.29618,-0.91468 0.51027,0.79781 0.0548,1.84762 0.5841,2.65244 0.50017,0.97686 1.7314,1.52668 2.77051,1.09339 1.0378,-0.35178 1.53161,-1.67674 1.0195,-2.63799 C 11.07123,0.77410507 9.16303,-0.05833493 7.45119,0.00462507 z");o.attr({id:"path3001","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"50",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3001");var i=s.path("m 15.97079,8.1489251 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");i.attr({id:"path3807",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3807");var l=s.path("m 3.38842,11.049785 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");l.attr({id:"path3822",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3822");var h=s.path("M 15.69138,2.8164551 C 10.46092,7.2657851 5.23046,11.715125 0,16.164455 c 0.68845,-0.002 1.37691,-0.003 2.06536,-0.005 5.21598,-4.44988 10.43195,-8.8997599 15.64793,-13.3496399 -0.67397,0.002 -1.34794,0.004 -2.02191,0.007 z");h.attr({id:"path3803","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"49.9",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3803");var u=s.set();u.push(o,i,l,h);var p=u.getBBox().height;return null!==a.number&&u.push(n(e,u.getBBox().width,p+4,a.number,20,"lb")),null!==a.opt&&u.push(n(e,u.getBBox().width,p+3,"("+a.opt+")",16,"lb")),u.transform("t"+t+","+r),u}function ce(e,t,r,a,s){var o=e,i=o.path("m 7.36,1.9518304 c -3.1472,0 -5.51238,3.23098 -5.51238,6.97709 0,3.7461196 2.36518,6.9770896 5.51238,6.9770896 3.1472,0 5.51238,-3.23097 5.51238,-6.9770896 0,-3.74611 -2.36518,-6.97709 -5.51238,-6.97709 z m 0,0.84817 c 1.97338,0 3.75892,3.18901 3.75892,6.12892 0,2.9399196 -1.78554,6.1289296 -3.75892,6.1289296 -1.97338,0 -3.75892,-3.18901 -3.75892,-6.1289296 0,-2.93991 1.78554,-6.12892 3.75892,-6.12892 z");i.attr({id:"path3878","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"72.4",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3878");var l=o.path("m 7.2,3.814697e-7 -3.6,0 0,0.7999999985303 3.2,0.40000002 0,7.6 1.2,0 0,-7.6 3.2,-0.40000002 0,-0.7999999985303 z");l.attr({id:"path4413",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4413");var h=o.path("m 7.6,17.6 3.6,0 0,-0.8 -3.2,-0.4 0,-7.5999996 -1.2,0 0,7.5999996 -3.2,0.4 0,0.8 z");h.attr({id:"path4415",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4415");var u=o.path("m 14.8,8.8000004 0,-3.6 -0.8,0 -0.4,3.2 -7.6,0 0,1.2 7.6,0 L 14,12.8 l 0.8,0 z");u.attr({id:"path4417",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4417");var p=o.path("M 0,9.2000004 0,12.8 l 0.8,0 0.4,-3.1999996 7.6,0 0,-1.2 -7.6,0 -0.4,-3.2 -0.8,0 z");p.attr({id:"path4419",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4419");var c=o.set();return c.push(i,l,h,u,p),null!==s.number&&c.push(n(e,c.getBBox().width,c.getBBox().height+4,s.number,20,"lb")),void 0!==a&&null!==a&&(t-=("l"==a[0]?0:"c"==a[0]?.5:1)*c.getBBox().width,r-=("t"==a[1]?0:"m"==a[1]?.5:1)*c.getBBox().height),c.transform("t"+t+","+(r-2)),c}var fe=new Array,de=(new Array,function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}),me=new l;l.prototype.enqueue=function(e){null!==e.task_type?(e.task_type in this.task_queue||(this.task_queue[e.task_type]=[]),this.task_queue[e.task_type].push(e),console.log("Enqueue task for queue '"+e.task_type+"'. Size = "+this.task_queue[e.task_type].length),1==this.task_queue[e.task_type].length&&setTimeout(e.run.bind(e),0)):setTimeout(e.run.bind(e),0)},l.prototype.finish=function(e){if(null!==e.task_type)if(e.task_type in this.task_queue&&0!=this.task_queue[e.task_type].length&&this.task_queue[e.task_type][0]==e){var t=this.task_queue[e.task_type];t.shift(),console.log("Dequeue task for queue '"+e.task_type+"'. Size = "+t.length),t.length>0&&t[0].run()}else alert("Invalid task execution state detected")},h.prototype.then=function(e){return this.promise.then(e)},h.prototype.run=function(){var e=this.worker(this.context);if(e instanceof h||e instanceof Promise){var t=this;e.then(function(e){null===t.resolve&&alert("Invalid state detected"),t.resolve(e),setTimeout(t.queue.finish.bind(t.queue,t),1)})}else null===this.resolve&&alert("Invalid state detected"),this.resolve(e),setTimeout(this.queue.finish.bind(this.queue,this),1)},h.enqueueFunctionCall=function(e,arguments,t){return new h({func:e,arguments:arguments,i:0,func_ret:void 0},function(e){return e.i>0||(ret=e.func.apply(null,e.arguments),e.func_ret=ret,void 0===ret&&(ret=!0),++e.i,ret)},t)},h._ForeachWorker=function(e){var t=new l;return new h(e,function(e){return e.worker(e.loopindex,e.looptarget.length,e.looptarget[e.loopindex],e.context)},0,t),new h(e,function(e){if(e.loopindex==e.looptarget.length-1)return e.context;var t=s(e);return t.loopindex++,new h(t,h._ForeachWorker,null)},0,t)},h.Foreach=function(e,t,r,n){var a={};return a.worker=t,a.context=r,a.looptarget=e,a.loopindex=0,new h(a,h._ForeachWorker,n)};var ge=17297280,_e=new RegExp;_e.compile(/^((sus4?)|(add(9|13))|(alt)|(dim)|(7|9|6|11|13)|((\+|\#)(5|9|13|11))|((\-|b)(5|9|13))|([Mm]([Aa][Jj]?|[Ii][Nn]?)?)|([\,\(\)]))/);var ve=2,be=0,ke=1,we=3,ye=4,xe=5,Ee=6,Re=9,Se=12,Te=[Se,xe,be,ye,14,Ee,Re,ke,we];g.getTranpsoedNote=function(e,t,r,n){var a=[["A"],["A#","Bb"],["B","Cb"],["C"],["C#","Db"],["D"],["D#","Eb"],["E","Fb"],["F"],["F#","Gb"],["G"],["G#","Ab"]],s=r;if(void 0!==n&&(s+=n),0==e)return s;var o=0;for(o=0;o<a.length&&!(a[o].indexOf(s)>=0);++o);for(var i=o+e;i<0;)i+=12;var l=a[i%12];if(1==l.length)return l[0];switch(t){case"GUESS":return n&&"#"==n?l[0]:l[1];case"SHARP":return l[0];case"FLAT":return l[1]}return null},g.prototype.getChordStrBase=function(e,t){if(!this.is_valid_chord)return[!1,this.chord_str];var r=null;void 0!==this.note_base&&(r=g.getTranpsoedNote(e,t,this.note_base,this.sharp_flat));var n=null;return void 0!==this.base_note_base&&(n=g.getTranpsoedNote(e,t,this.base_note_base,this.base_sharp_flat)),[r,n]},g.prototype.getChordStr=function(e,t){if(!this.is_valid_chord)return[!1,this.chord_str];var r=null;void 0!==this.note_base&&(r=g.getTranpsoedNote(e,t,this.note_base,this.sharp_flat));var n=null;void 0!==this.base_note_base&&(n=g.getTranpsoedNote(e,t,this.base_note_base,this.base_sharp_flat));var a="";if(null!==this.mid_elems)for(var s=0;s<this.mid_elems.length;++s)switch(this.mid_elems[s].cs){case Se:var o=this.mid_elems[s].s;a+="M"==o||"maj"==o.toLowerCase()||"ma"==o.toLowerCase()?"M":"m";break;case xe:var i={11:"%",13:"&"};this.mid_elems[s].s in i?a+=i[this.mid_elems[s].s]:a+=this.mid_elems[s].s;break;case be:a+="s"+this.mid_elems[s].s.substr(3);break;case ye:a+="d";break;case Re:a+="b"+this.mid_elems[s].s.substr(1);break;case Ee:a+="#"+this.mid_elems[s].s.substr(1);break;case ke:a+="a"+this.mid_elems[s].s.substr(3);break;case we:case 14:a+=this.mid_elems[s].s}return[!0,(r?r+a:"")+(n?"/"+n:"")]},(de=function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e})(w,k),de(y,k),de(E,k),de(R,k),de(S,k),T.prototype.toString=function(){return"D.C."},I.prototype.toString=function(){return"D.S."+(null===this.number?"":this.number)+(null===this.al?"":" al "+this.al.toString())},A.prototype.toString=function(){return"Coda"+(null===this.number?"":this.number)},P.prototype.toString=function(){return"Fine"};var Ie=/^(\w[\w\.\,\-\+\#\:]*)/,Be=/^[^\[\]]*/,Ae=/^[\w\.\,\-\+\#\/\(\)\:\~]*/;C.prototype.onParseError=function(e){var t="Parse error on Line "+this.context.line+" : "+e;throw console.log(t),console.trace(),this.error_msg_callback?this.error_msg_callback(t):alert(t),"Parse error"},C.prototype.nextToken=function(e,t){word_def=Ie;var r=0;if(!0!==t)for(;e.length>0&&O(e[0]," \t");)e=e.substr(1),++r;if(0==e.length)return{token:null,s:e,type:0,ss:r};if('"'==e[0]||"'"==e[0]){var n=e[0],a="";for(e=e.substr(1);e.length>0&&e[0]!=n;)a+=e[0],e=e.substr(1);return e.length>0&&e[0]==n||this.onParseError("ERROR_WHILE_PARSING_PLAIN_STRING"),e=e.substr(1),{token:a,s:e,type:25,ss:r}}var s=O(e[0],"[]<>(){},\n/%=");if(null!=s)return{token:e[0],s:e.substr(1),ss:r,type:[5,6,7,8,3,4,9,10,20,22,21,23,24][s.index]};if(null!=(s=F(e,["||:","||.","||","|"])))return{token:s.s,s:e.substr(s.s.length),ss:r,type:[16,19,15,14][s.index]};var o=null;if(null!=(o=e.match(/^(\:\|\|\:?)(x(\d+))?/))){var i=2;return null!=o[2]&&(i=Number(o[3])),{token:o[0],s:e.substr(o[0].length),ss:r,type:":||:"==o[1]?18:17,param:i}}if(null!=(o=e.match(word_def))){var l=o[0];return{token:l,s:e.substr(l.length),type:1,ss:r}}throw"INVALID_TOKEN_DETECTED"},C.prototype.parseGroup=function(e,t,r){for(var n=new Array,a=0;a<e.length;++a){for(var s=e[a][1],o=e[a][0],i=new Array,l=!0;l;){var h=this.nextToken(t);switch(s){case"":h.type!=o&&this.onParseError(r),i.push(h.token),t=h.s,l=!1;break;case"*":if(h.type!=o){l=!1;break}i.push(h.token),t=h.s;break;case"+":if(h.type!=o){if(0!=i.length){loop_flag=!1;break}this.onParseError(r)}i.push(h.token),t=h.s;break;case"?":if(h.type!=o)break;i.push(h.token),t=h.s;break;default:throw"ASSERTION ERROR"}}n.push(i)}return{tokens:n,s:t}},C.prototype.parseReharsalMark=function(e,t){if(m=t.match(Be),null!=m){reharsalMarkName=m[0];var r=this.nextToken(t.substr(m[0].length));if(6==r.type)return{reharsalMarkName:reharsalMarkName,s:r.s}}throw"Invalid reharsal mark"},C.prototype.parseLoopIndicator=function(e,t){for(var r=new Array;;){var n=this.nextToken(t);if(1!=n.type&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR"),r.push(n.token),t=n.s,n=this.nextToken(t),t=n.s,6==n.type)break;20!=n.type&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR")}return{loopIndicator:new _(r),s:t}},C.prototype.parseLongRestIndicator=function(e,t){var r=this.nextToken(t);return t=r.s,1!=r.type&&this.onParseError("ERROR_WHILE_PARSE_OMIT_INDICATOR"),longrestlen=r.token,r=this.nextToken(t),t=r.s,10!=r.type&&this.onParseError("ERROR_WHILE_PARSE_OMIT_INDICATOR"),{longRestIndicator:new v(longrestlen),s:t}},C.prototype.parseTime=function(e,t){var r=0,n=0,a=this.nextToken(t);return t=a.s,1!=a.type&&this.onParseError("ERROR_WHILE_PARSE_TIME"),r=a.token,a=this.nextToken(t),t=a.s,21!=a.type&&this.onParseError("ERROR_WHILE_PARSE_TIME"),a=this.nextToken(t),t=a.s,1!=a.type&&this.onParseError("ERROR_WHILE_PARSE_TIME"),n=a.token,a=this.nextToken(t),t=a.s,4!=a.type&&this.onParseError("ERROR_WHILE_PARSE_TIME"),{time:new b(r,n),s:t}},C.prototype.parseSign=function(e,t){var r=t.indexOf(">");if(r<0)throw"Parse error on Sign";var n=t.slice(0,r);t=t.slice(r+1);var a=this.nextToken(n,Ie);if(1!=a.type)throw"Error";regDS=/D\.S\.([0-9]+)?/,regCoda=/Coda([0-9]+)?/,regSegno=/S(egno)?([0-9]+)?$/;var s=null;if("Fine"==a.token)sign=new P;else if("D.C."==a.token)sign=new T;else if(null!==(s=a.token.match(regCoda)))sign=new A(void 0===s[1]?null:s[1]);else if(null!==(s=a.token.match(regSegno))){var o=a.s.match(/^\s*(straight|((with\s+)repeat))/);console.log(a.s+"/"+n+o),sign=new B(void 0===s[2]?null:s[2],o?o[1]:null)}else if("to"==a.token){if(1!=(a=this.nextToken(a.s,Ie)).type)throw"Error";if(null===(s=a.token.match(regCoda)))throw"Error";sign=new M(void 0===s[1]?null:s[1])}else{if(null===(s=a.token.match(regDS)))throw"Error";var i=void 0===s[1]?null:s[1],l=null;if(0==(a=this.nextToken(a.s,Ie)).type);else{if(1!=a.type)throw"Error";if("al"!=a.token)throw"Error";if(1!=(a=this.nextToken(a.s,Ie)).type)throw"Error";if("Fine"==a.token)l=new P;else{if(null===(s=a.token.match(regCoda)))throw"Error";l=new A(void 0===s[1]?null:s[1])}}sign=new I(i,l)}return{sign:sign,s:t}},C.prototype.parseChordSymbol=function(e,t,r){chord_symbol=e;var n=r.match(Ae);return n&&(chord_symbol+=n[0],r=r.substr(n[0].length)),{s:r,chord:new g(chord_symbol)}},C.prototype.parseRest=function(e,t,r){var n=/^r\:(1|2|4|8|16|32|64)(\.*)$/,a=e.match(n),s=null;return a&&(s=new f(parseInt(a[1]),a[2])),{s:r,rest:s}},C.prototype.parseMeasure=function(e,t){var r=new c;14==e.type?r.elements.push(new w(1)):15==e.type?r.elements.push(new w(2)):17==e.type?r.elements.push(new E(e.param)):16==e.type?r.elements.push(new y):18==e.type?r.elements.push(new R(e.param)):19==e.type&&r.elements.push(new S);for(var n=!0;n;)switch((s=this.nextToken(t)).type){case 25:r.elements.push(new g(s.token)),t=s.s;break;case 1:var a=this.parseRest(s.token,s.type,s.s);if(null!==a.rest){r.elements.push(a.rest),t=a.s;break}case 21:s=this.parseChordSymbol(s.token,s.type,s.s);r.elements.push(s.chord),t=s.s;break;case 7:s=this.parseSign(s.type,s.s);r.elements.push(s.sign),t=s.s;break;case 3:s=this.parseTime(s.type,s.s);r.elements.push(s.time),t=s.s;break;case 5:s=this.parseLoopIndicator(s.type,s.s);r.elements.push(s.loopIndicator),t=s.s;break;case 9:var s=this.parseLongRestIndicator(s.type,s.s);r.elements.push(s.longRestIndicator),t=s.s;break;case 14:r.elements.push(new w(1)),n=!1;break;case 15:r.elements.push(new w(2)),n=!1;break;case 17:r.elements.push(new E(s.param)),n=!1;break;case 16:r.elements.push(new y),n=!1;break;case 18:r.elements.push(new R(s.param)),n=!1;break;case 19:r.elements.push(new S),n=!1;break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURE")}return{measure:r,s:t}},C.prototype.parseMeasures=function(e,t){for(var r=new Array,n=!0;n;){var a=this.parseMeasure(e,t);switch(t=a.s,r.push(a.measure),a=this.nextToken(t),t=a.s,a.type){case 14:case 15:case 16:case 17:case 18:case 19:switch(this.nextToken(t).type){case 22:case 0:n=!1;break;default:e=a}break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURES")}}return{measures:r,s:t}},C.prototype.parseMacro=function(e){var t=null,r=null,n=this.nextToken(e);return 1!=n.type&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),t=n.token,e=n.s,24!=(n=this.nextToken(e)).type&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=n.s,25!=(n=this.nextToken(e)).type&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=n.s,r=n.token,{key:t,value:r,s:e}},C.prototype.glanceHeader=function(e){for(var t=["TITLE","ARTIST"],r={},n=e.split("\n"),a=0;a<n.length;++a)if(n[a].length>0&&"%"==n[a][0]){var s=this.parseMacro(n[a].substr(1));if(t.indexOf(s.key)>=0&&(r[s.key]=s.value),r.length==t.length)break}return r},C.prototype.parse=function(e){e.replace(/\r\n/g,"\n"),e.replace(/\r/g,"\n");for(var t=null,r=0,n=new u,a=null;;){if(0==(t=this.nextToken(e)).type)break;if(5==t.type?(t=this.parseReharsalMark(t.token,t.s),null!=a&&n.reharsal_groups.push(a),(a=new p).name=t.reharsalMarkName):[14,15,16,18,19].indexOf(t.type)>=0?(t=this.parseMeasures(t,t.s),a.measures=a.measures.concat(t.measures)):23==t.type?(t=this.parseMacro(t.s),a?a.macros[t.key]=t.value:n.macros[t.key]=t.value):22==t.type?this.context.line+=1:(console.log(t.token),this.onParseError("ERROR_WHILE_PARSE_MOST_OUTSIDER")),e=t.s,++r>=1e3)break}null!=a&&(n.reharsal_groups.push(a),a=null);for(var s={},o=0;o<n.reharsal_groups.length;++o){var i=n.reharsal_groups[o];i.name in s?n.reharsal_groups[o]=$.extend(!0,{},s[i.name]):s[i.name]=i}return n},H.prototype.auto_scroll=function(e){this.param.auto_scroll=e},H.prototype.play=function(e){if(!this.timerid){this.timerStart=Date.now(),this.tempo_bpm=e,this.cmi=0;var t=this;this.timerid=setInterval(function(){t.onClock()},100),this.onClock(),this.cb_play&&this.cb_play()}},H.prototype.stop=function(){this.timerid&&(clearInterval(this.timerid),this.timerid=null,this.lastindicator&&(this.lastindicator.remove(),this.lastindicator=null),this.cb_stop&&this.cb_stop())},H.prototype.onClock=function(){for(var e=Date.now()-this.timerStart,t=this.sequence,r=1/this.tempo_bpm*60*1e3*4;this.cmi<t.length&&!(e>=t[this.cmi][0].t*r&&e<(t[this.cmi][0].t+t[this.cmi][0].duration)*r);++this.cmi);if(this.cmi>=t.length)this.stop();else{var n=t[this.cmi][1],a=n.renderprop.sx,s=n.renderprop.ex,o=n.renderprop.y;this.lastindicator&&(this.lastindicator.remove(),this.lastindicator=null),this.lastindicator=n.renderprop.paper.rect(a,o,s-a,30).attr({fill:"red","fill-opacity":.3,stroke:0});n.renderprop.paper.canvas.offsetLeft;var i=n.renderprop.paper.canvas.offsetTop;this.param.auto_scroll&&window.scroll(0,i+o-$(window).height()/2)}},L.prototype.render=function(e,t,r){if(this.track=e,t)return h.enqueueFunctionCall(ue,[this.canvas,e,!0,this.param,t,r],"render"),h.enqueueFunctionCall(j,[e,this.param],"render"),h.enqueueFunctionCall(ue,[this.canvas,e,!1,this.param,t,r],"render");ue(this.canvas,e,!0,this.param,t,r),j(e,this.param),ue(this.canvas,e,!1,this.param,t,r)},L.prototype.clear=function(){for(var e=0;e<fe.length;++e)fe[e].clear();$(this.canvas).children().remove(),fe=new Array};var Me={},Pe=0,Ce={M:function(e){return[[16,-7,"M"]]},m:function(e){return[[16,-7,"m"]]}},Oe=0,Fe={dim:function(e){return[[16,-7,"d"]]},sus:function(e){return[[18,-9,"s"],[13,-2,e||""]]},M:function(e){return[[16,-7,"M"],[13,-2,e||""]]},m:function(e){return[[16,-7,"m"]]},add:function(e){return[[20,-10,"a"],[13,-2,e||""]]},dig:function(e){return e?"11"==e?e="%":"13"==e&&(e="&"):e="",[[13,-2,e]]}},Le=0,qe={"#":function(e){return[[13,-2,"+"],[13,-2,e]]},b:function(e){return[[13,-2,"-"],[13,-2,e]]},dig:function(e){return[[13,-2,e]]}},Ne=0,De={"#":function(e){return[[13,-2,"#"],[13,-2,e]]},b:function(e){return[[13,-2,"b"],[13,-2,e]]},alt:function(e){return[[13,-2,"alt"]]}},He=null,ze=!1,We=null,Ge=!1;return{Parser:C,Renderer:L,Sequencer:H,Initialize:function(){n(le(),100,100,"ABCDEFG#b123456789dsMm",16,"lt","icomoon");he()}}}();