function svgLine(e,r,t,a){return"M"+e+","+r+" L"+t+","+a}function svgPath(e,r){for(var t="M",a=0;a<e.length;++a)t+=e[a][0]+","+e[a][1],a<e.length-1&&(t+=" L");return r===!0&&(t+="Z"),t}function svgArcBezie(e){var r="M ";r+=e[0][0]+" "+e[0][1],r+=" C";for(var t=1;t<e.length;++t)r+=e[t][0]+" "+e[t][1]+" ";return r}function raphaelText(e,r,t,a,n,o,s){var i=e.text(r,t,a).attr("font-size",n);s&&i.attr("font-family",s);var h=i.getBBox().width,l=i.getBBox().height;return("l"==o[0]||"r"==o[0])&&i.attr("x",i.attr("x")+h/2*("l"==o[0]?1:-1)),("t"==o[1]||"b"==o[1])&&i.attr("y",i.attr("y")+l/2*("t"==o[1]?1:-1)),i}function raphaelTextWithBox(e,r,t,a,n){var o=e.set(),s=raphaelText(e,r,t,a,n,"lt"),i=s.getBBox().width,h=s.getBBox().height,l=0*h,_=.1*h,p=e.rect(r,t,i+2*_,h+2*l);return s.attr("x",s.attr("x")+_),s.attr("y",s.attr("y")+l),o.push(s,p),o}function raphaelDownloadSvg(e,r){var t=e.toSVG(),a=document.createElement("a");a.download=r,a.type="image/svg+xml";var n=new Blob([t],{type:"image/svg+xml"});a.href=(window.URL||webkitURL).createObjectURL(n),a.click()}function zeroPaddedInt(e,r){var t=String(e);if(0>e)return t;if(t.length>=r)return t;for(var a=r-t.length,e=0;a>e;++e)t="0"+t;return t}function shallowcopy(e){return jQuery.extend({},e)}function deepcopy(e){return jQuery.extend(!0,{},e)}function TaskQueue(){this.task_queue={}}function Task(e,r,t,a){void 0===t&&(t=null),this.task_type=t,this.context=e,this.worker=r,this.promise=null,this.resolve=null,this.reject=null;var n=this;this.promise=new Promise(function(e,r){n.resolve=e,n.reject=r}),a=void 0===a?null:a,this.queue=a?a:the_task_queue,this.queue.enqueue(this)}function Track(){this.reharsal_groups=new Array,this.macros={}}function ReharsalGroup(){this.name=null,this.measures=new Array,this.macros={}}function Measure(){this.elements=new Array,this.boundary_info=["n","n"],this.header_width=0,this.body_width=0,this.footer_width=0,this.body_scaling=1,this.new_line=!1,this.renderprop={}}function Rest(e,r){var t=WHOLE_NOTE_LENGTH/e;this.length_s=""+e+(r?r:""),this.length=WHOLE_NOTE_LENGTH/e;for(var a=r?r:"",n=0;n<a.length;++n)t/=2,this.length+=t;this.renderprop={}}function parseChordMids(e){for(var r=[],t=[];e.length>0;){if(m=e.match(cnrg),null===m)return console.log("Invalid code notation : "+e),null;for(var a=0;a<CS_LIST.length;++a)if(void 0!==m[CS_IDX_OFFSET+CS_LIST[a]]&&null!==m[CS_IDX_OFFSET+CS_LIST[a]]){r.push({cs:CS_LIST[a],s:m[0],g:m});break}e=e.substr(m[0].length)}for(var n=!1,a=0;a<r.length;++a)switch(r[a].cs){case CS_M:var e=r[a].s,o="M"==e||"maj"==e.toLowerCase()||"ma"==e.toLowerCase();0==o&&(n=!0),n&&1==o?r[a+1].cs==CS_DIG&&(t.push({type:"M",param:r[a+1].s}),++a):o?t.push({type:"M"}):t.push({type:"m"});break;case CS_DIG:t.push({type:"dig",param:r[a].s});break;case CS_SUS:t.push({type:"sus",param:r[a].s.substr(3)});break;case CS_DIM:t.push({type:"dim"});break;case CS_MNS:t.push({type:"b",param:r[a].s.substr(1)});break;case CS_PLS:t.push({type:"#",param:r[a].s.substr(1)});break;case CS_ADD:t.push({type:"add",param:r[a].s.substr(3)});break;case CS_ALT:t.push({type:"alt"})}return[r,t]}function Chord(e){this.chord_str=e,this.is_valid_chord=!0,this.length=WHOLE_NOTE_LENGTH,this.length_s=null,this.tie=!1,this.renderprop={};var r=/^(((A|B|C|D|E|F|G)(#|b)?([^\/\:]*))?(?:\/(A|B|C|D|E|F|G)(#|b)?)?)(:(\d+)(\.*))?(\~)?/,t=e.match(r);if(t&&""!=t[0]){if(this.chord_name_str=t[1],this.note_base=t[3],this.sharp_flat=t[4],this.mid_str=t[5],this.base_note_base=t[6],this.base_sharp_flat=t[7],this.mid_elems=null,void 0!==this.mid_str){var a=parseChordMids(this.mid_str);null!==a&&(this.mid_elems=a[0],this.mid_elem_objs=a[1]),this.is_valid_chord=null!==a}if(t[8]){var n=t[10]?t[10]:"";this.length_s=t[9]+(t[10]?t[10]:""),this.length=WHOLE_NOTE_LENGTH/parseInt(t[9]);for(var o=WHOLE_NOTE_LENGTH/parseInt(t[9]),s=0;s<n.length;++s)o/=2,this.length+=o}this.tie="~"==t[11]}else this.chord_name_str=this.chord_str,this.is_valid_chord=!1}function LoopIndicator(e){this.indicators=e}function Time(e,r){this.numer=e,this.denom=r}function MeasureBoundary(){}function MeasureBoundaryMark(e){this.nline=e}function LoopBeginMark(){}function LoopEndMark(e){this.times=e}function LoopBothMark(e){this.times=e}function MeasureBoundaryFinMark(){}function DaCapo(){}function DalSegno(e,r){this.number=e,this.al=r}function Segno(e,r){this.number=e,this.opt=r}function Coda(e){this.number=e}function ToCoda(e){this.number=e}function Fine(){}function Parser(e){this.context={line:0,"char":0},this.error_msg_callback=e}function charIsIn(e,r){for(var t=0;t<r.length;++t)if(r[t]==e)return{r:!0,index:t};return null}function charStartsWithAmong(e,r){for(var t=0;t<r.length;++t)if(0==e.indexOf(r[t]))return{index:t,s:r[t]};return null}function render(e,r,t,a,n,o){var s={row_interval:70,y_title_offset:50,y_author_offset:90,y_first_page_offset:120,y_offset:70,x_offset:70,min_measure_width:100,row_height:24,row_margin:25,rs_area_height:24,rm_area_height:30,mh_area_height:25,max_scaling:1.2,paper_width:r,paper_height:t,repeat_mark_font:{"font-family":"Times New Roman","font-style":"italic","font-weight":"bold"}};if(n){clearPapers(e),Task.enqueueFunctionCall(render_impl,[e,a,!0,s,n,o],"render"),Task.enqueueFunctionCall(identify_scaling,[a,s],"render");var i=Task.enqueueFunctionCall(render_impl,[e,a,!1,s,n,o],"render");return i}render_impl(e,a,!0,s,n,o),identify_scaling(a,s),render_impl(e,a,!1,s,n,o)}function classifyElements(e){for(var r=e,t=new Array,a=new Array,n=new Array,o=new Array,s=0;s<r.elements.length;++s){var i=r.elements[s];0==s?t.push(i):s==r.elements.length-1?n.push(i):i instanceof Chord?a.push(i):i instanceof Rest?a.push(i):i instanceof LoopIndicator?o.push(i):i instanceof Time?t.push(i):i instanceof DaCapo?n.push(i):i instanceof DalSegno?n.push(i):i instanceof Segno?t.push(i):i instanceof Coda?t.push(i):i instanceof ToCoda?n.push(i):i instanceof Fine&&n.push(i)}return{header:t,body:a,footer:n,measure_wide:o}}function maxtor(e,r,t){for(var a=0,n=null,o=null;null!==(n=r(a++))&&n<e.length;){var s=void 0!==t?t(e[n]):e[n];o=null===o?s:Math.max(s,o)}return o}function identify_scaling(e,r){console.log("Identify scaling called");for(var t=r.paper_width-2*r.x_offset,a=0;a<e.reharsal_groups.length;++a){var n=e.reharsal_groups[a],o=0,s=new Array,i=new Array,h=!0,l=!0;if(h){for(var _=0,p=0;p<n.measures.length;++p){_=p+1;var u=n.measures[p];if(o+=u.header_width+u.body_width+u.footer_width,o>t){_--;break}}for(var c=n.measures.length,d=_,f=new Array,g=0;d>0;--d){for(var m=0;d>m;++m){var v=maxtor(n.measures,function(e){return e*d+m},function(e){return e.header_width+e.body_width+e.footer_width});g+=v,f.push(v)}if(t>=g){if(!l)break;if(d%2==0||1==d||d==c)break}g=0,f=new Array}for(var k=t/g,p=0;p<n.measures.length;++p){var u=n.measures[p],y=Math.floor(p/d),T=p-y*d,E=f[T]*k-(u.header_width+u.footer_width);u.new_line=0==T&&y>0,u.body_scaling=E/u.body_width}}else{for(var p=0;p<n.measures.length;++p){var u=n.measures[p];i.push(u),o+=u.header_width+u.body_width+u.footer_width,o>t&&(s.push(i),i=new Array,o=0)}i.length>0&&s.push(i);for(var b=0;b<s.length;++b){for(var w=0,x=0,p=0;p<s[b].length;++p){var u=s[b][p];b>0&&0==p&&(u.new_line=!0),w+=u.header_width+u.body_width+u.footer_width,x+=u.header_width+u.footer_width}var O=t-x;if(0>=O)throw"ERROR";for(var N=O/(w-x),p=0;p<s[b].length;++p){var u=s[b][p];u.body_scaling=Math.min(r.max_scaling,N)}}}}}function clearPapers(e){for(var r=0;r<pages.length;++r)pages[r].clear();$(e).children().remove(),pages=new Array}function makeNewPaper(e,r){var t=pages.length;$(e).append("<div id='page"+t+"'></div>");var a=$(e).children("#page"+t)[0];return paper=Raphael(a,r.paper_width,r.paper_height),pages.push(paper),paper.canvas.style.backgroundColor="#FFFFFF",raphaelText(paper,r.paper_width/2,r.paper_height-40,"Generated by fumen ver 0.1",12,"ct"),ChordRenderBuffer={},paper}function incrementY(e,r,t,a,n,o){var s=!0;return s?e+2*n.row_interval<n.paper_height-n.y_offset?e+=n.row_interval:(a++,e=n.y_offset,o&&(t=makeNewPaper(r,n))):e-a*n.paper_height+2*n.row_interval<n.paper_height-n.y_offset?e+=n.row_interval:(a++,e=a*n.paper_height+n.y_offset),{y_base:e,page_count:a,paper:t}}function get_boundary_sign(e){if(null===e)return"n";if(e instanceof MeasureBoundaryMark){if(1==e.nline)return"s";if(2==e.nline)return"d"}else{if(e instanceof LoopBeginMark)return"b";if(e instanceof LoopEndMark)return"e";if(e instanceof LoopBothMark)return"B";if(e instanceof MeasureBoundaryFinMark)return"f"}throw"Invalid boundary object"}function boundary_type_without_line_break(e,r){var t={ss:"s",sd:"d",sb:"b",sn:"s",ds:"d",dd:"d",db:"b",dn:"d",es:"e",ed:"e",ee:"e",eb:"B",en:"e",bb:"b",BB:"B",fn:"f",ns:"s",nd:"d",nb:"b"},a=get_boundary_sign(e)+get_boundary_sign(r);if(a in t)return t[a];throw"Invalid boundary pair : "+a}function boundary_type_with_line_break(e,r,t){var a={ss:"ss",sd:"sd",sb:"sb",ds:"ds",dd:"dd",db:"db",es:"es",ed:"ed",ee:"es",eb:"eb",bb:"sb",BB:"eb"},n=get_boundary_sign(e)+get_boundary_sign(r);if(n in a)return a[n]["begin"==t?1:0];throw"Invalid boundary pair : "+n}function draw_boundary(e,r,t,a,n,o,s,i,h){var l=i.row_height,_=null,p=o;if("end"==e){var u=null===t||a;if(!u)return{x:o,bx:p}}switch(_=null===a||0==a?boundary_type_without_line_break(r,t):boundary_type_with_line_break(r,t,e)){case"s":case"d":for(var c="s"==_?1:2,d=0;c>d;++d)h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"1"}),c>=2&&c-1>d&&(o+=3);p=o;break;case"b":h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"2"}),o+=3,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"1"}),o+=4,h&&n.circle(o,s+l/4*1.5,1).attr({fill:"black"}),h&&n.circle(o,s+l/4*2.5,1).attr({fill:"black"});break;case"e":h&&n.circle(o,s+l/4*1.5,1).attr({fill:"black"}),h&&n.circle(o,s+l/4*2.5,1).attr({fill:"black"}),o+=4,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"1"}),o+=3,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"2"}),null!==r.times&&2!=r.times&&h&&(text=raphaelText(n,o,s+l+8,"(x"+r.times+")",13,"rc")),p=o;break;case"B":h&&n.circle(o,s+l/4*1.5,1).attr({fill:"black"}),h&&n.circle(o,s+l/4*2.5,1).attr({fill:"black"}),o+=4,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"1"}),o+=3,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"2"}),p=o,o+=3,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"1"}),null!==r.times&&2!=r.times&&h&&(text=raphaelText(n,o,s+l+8,"(x"+r.times+")",13,"rc")),o+=4,h&&n.circle(o,s+l/4*1.5,1).attr({fill:"black"}),h&&n.circle(o,s+l/4*2.5,1).attr({fill:"black"});break;case"f":h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"1"}),o+=3,h&&n.path(svgLine(o,s,o,s+l)).attr({"stroke-width":"2"});break;default:throw"Internal error"}return{x:o,bx:p}}function render_chord_as_string(e,r,t,a,n,o,s,i,h,l,_){var p=s.row_height,u=e.getChordStr(r,t),c=raphaelText(a,n,o+p/2,u[1],16,"lc",u[0]?"icomoon":null);return n+=c.getBBox().width*l*_,n+=h*_,i||c.remove(),{x:n}}function render_chord(e,r,t,a,n,o,s,i,h,l,_){var p="icomoon",u=s.row_height;if(e.renderprop.x=n,!e.is_valid_chord)return render_chord_as_string(e,r,t,a,n,o,s,i,h,l,_);var c=[n,o];if(i&&e.chord_name_str in ChordRenderBuffer){var d=ChordRenderBuffer[e.chord_name_str],f=d[0].clone();f.attr({opacity:1});var g=d[1];return f.transform("T "+(c[0]-g[0])+" "+(c[1]-g[1])),n+=f.getBBox().width*l*_,n+=h*_,isFinite(n)||console.error("Illegal calculation of x detected"),{group:f,x:n}}var m=e.getChordStrBase(r,t),v=e.mid_elem_objs,f=a.set(),k=[],y=[],T=[],E=[];if(v){for(var b=!1,w=!1,x=0;x<v.length;++x){var O=v[x];switch(O.type){case"M":void 0!==O.param?T.push(O):k.push(O);break;case"m":k.push(O);break;case"add":T.push(O);break;case"sus":T.push(O);break;case"dig":T.push(O),b|="6"==O.param,w|="9"==O.param;break;case"b":case"#":"5"==O.param?y.push(O):E.push(O);break;case"dim":T.push(O);break;case"alt":E.push(O)}}if(b&&w)for(var x=0;x<T.length;++x)if("dig"==T[x].type&&"6"==T[x].param){y.push(T[x]),T.splice(x,1);break}}var N=null,S=n;m[0]&&(N=raphaelText(a,S,o+u/2,m[0],18,"lc",p),f.push(N),S+=N.getBBox().width);var B=0;if(k.length>0){for(var R=_3rd_font_profile[k[0].type](k[0].param),L=0,x=0;x<R.length;++x)N=raphaelText(a,S+L,o+u/2+R[x][1]+_3rd_global_dy,R[x][2],R[x][0],"lt",p),f.push(N),L+=N.getBBox().width;B=L}var M=0;if(y.length>0){for(var R=_5th_font_profile[y[0].type](y[0].param),L=0,x=0;x<R.length;++x)N=raphaelText(a,S+L,o+u/2+R[x][1]+_5th_global_dy,R[x][2],R[x][0],"lb",p),f.push(N),L+=N.getBBox().width;M=L}var C=B;if(T.length>0){for(var L=0,I=0;I<T.length;++I)for(var R=_6791113_font_profile[T[I].type](T[I].param),x=0;x<R.length;++x)""!=R[x][2]&&(N=raphaelText(a,S+B+L,o+u/2+R[x][1]+_6791113_global_dy,R[x][2],R[x][0],"lt",p),L+=N.getBBox().width,f.push(N));C+=L}S+=Math.max(M,C);for(var A=0,K=0,D=1e4,P=5,x=0;x<E.length;++x){for(var O=E[x],R=_altered_font_profile[O.type](O.param),F=0,G=0,H=0;H<R.length;++H)D=Math.min(D,o+K+R[H][1]+_altered_global_dy),N=raphaelText(a,S+P+F,o+K+R[H][1]+_altered_global_dy,R[H][2],R[H][0],"lt",p),f.push(N),F+=N.getBBox().width,G=Math.max(G,N.getBBox().height);K+=G+1,A=Math.max(A,F)}if(E.length>0){var W=[[S+P,D],[S,D],[S,D+K],[S+P,D+K]],q=a.path(svgArcBezie(W)).attr("stroke-width","1px"),z=[[S+P+A,D],[S+P+A+5,D],[S+P+A+5,D+K],[S+P+A,D+K]],U=a.path(svgArcBezie(z)).attr("stroke-width","1px");f.push(q),f.push(U),A+=2*P}if(S+=A,m[1]&&(N=raphaelText(a,S,o+u/2,"/",26,"lc"),f.push(N),S+=N.getBBox().width,N=raphaelText(a,S,o+u/2,m[1],18,"lc",p),f.push(N),S+=N.getBBox().width),n+=f.getBBox().width*l*_,n+=h*_,i||N.remove(),i){var j=f.clone();j.attr({opacity:0}),ChordRenderBuffer[e.chord_name_str]=[j,c]}return isFinite(n)||console.error("Illegal calculation of x detected"),{group:f,x:n}}function raphaelSlash(e,r,t,a,n,o){var s=10,i=10,h=4,l=svgPath([[t,a],[t+s,a-i],[t+s,a-i+h],[t,a+h]],!0),_=null;_="1"==n||"2"==n?e.path(l).attr({"stroke-width":"1px"}):e.path(l).attr({fill:"#000000"}),r.push(_);for(var p=0;o>p;++p)r.push(e.circle(t+s+5+5*p,a-6,1).attr({fill:"black"}));return r}function to_same_value_group(e,r){for(var t=[],a=[],n=null,o=0;o<e.length;++o)null!=n&&n!=r(e[o])&&(t.push(a),a=[]),n=r(e[o]),a.push(e[o]);return t.push(a),t}function render_empty_rythm_slash(e,r,t,a,n,o,s){for(var i=t+o.row_height+10,h=e.set(),l=0;n>l;++l){var _=r+a/4*l;raphaelSlash(e,h,_,i,"0",0)}}function myLog2(e){var r={1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7};return r[e]}function draw_balken(e,r,t,a,n,s,i){if(t.groups.length>=2){var h=t.groups[0].coord,l=t.groups[t.groups.length-1].coord,_=e.path(svgLine(h[0],h[1],l[0],l[1])).attr({"stroke-width":i});r.push(_);for(var p=to_same_value_group(t.groups,function(e){return e.onka}),u=0;u<p.length;++u){var c=p[u],d=c[0].onka,f=myLog2(parseInt(d))-2;if(1==c.length){var g=c[0].coord,m=1;u==p.length-1&&(m=-1);for(var v=p[u+m][p[u+m].length-1].coord[0],k=.3*Math.abs(v-g[0]),y=0;f>y;++y)o=e.path(svgLine(g[0],a+n-y*s,g[0]+m*k,a+n-y*s)).attr({"stroke-width":i}),r.push(o)}else if(c.length>=2)for(var g=c[0].coord,T=c[c.length-1].coord,y=0;f>y;++y)o=e.path(svgLine(g[0],g[1]-y*s,T[0],T[1]-y*s)).attr({"stroke-width":i}),r.push(o)}}else if(1==t.groups.length)for(var h=t.groups[0].coord,d=t.groups[0].onka,f=myLog2(parseInt(d))-2,y=0;f>y;++y)o=e.path("M"+(h[0]+10)+","+(a+n-10-y*s)+"L"+h[0]+","+(a+n-y*s)).attr({"stroke-width":"1px"}),r.push(o)}function render_rhythm_slash(e,r,t,a,n,o,s,i,h,l){var _=t+o.row_height+10,p="4px";balken={groups:[],sum_len:0};for(var u=!1,c=r.set(),d=0;d<e.length;++d){var f=e[d],g=f.renderprop.x,m=20,v=5;if(null!==f.length_s&&void 0!==f.length_s){var k=f.length_s.match(/[0-9]+/)[0],y=f.length_s.substr(k.length);if(f instanceof Chord)if(u=!0,"0"==k||"1"==k)raphaelSlash(r,c,g,_,k,y.length);else{raphaelSlash(r,c,g,_,k,y.length);var T=r.path("M"+g+","+_+"L"+g+","+(_+m)).attr({"stroke-width":"1px"});c.push(T)}if(l){var E=f.length>=WHOLE_NOTE_LENGTH/4||balken.sum_len%(WHOLE_NOTE_LENGTH/4)==0;E&&(draw_balken(r,c,balken,_,m,v,p),balken.groups=[]),balken.sum_len+=f.length,f.length<WHOLE_NOTE_LENGTH/4&&f instanceof Chord&&balken.groups.push({coord:[f.renderprop.x,_+m],onka:k}),d==e.length-1&&draw_balken(r,c,balken,_,m,v,p)}if(f instanceof Chord){if(rs_prev_has_tie){var b=-10,w=12,x=8,O=rs_prev_coord,N=[g,_,a,n];if(O[1]!=N[1]){var S=[[O[0]+w,O[1]+b],[O[0]+w,O[1]-x+b],[O[3]+20,O[1]-x+b],[O[3]+20,O[1]+b]];clip=O[0]+w+","+(O[1]-50)+","+(O[3]-(O[0]+w)+5)+",100",console.log("clip:"+clip);var B=rs_prev_tie_paper.path(svgArcBezie(S)).attr("stroke-width","2px").attr({"clip-rect":clip});rs_prev_tie_paper.set().push(B),S=[[N[2]-20,N[1]+b],[N[2]-20,N[1]-x+b],[N[0],N[1]-x+b],[N[0],N[1]+b]],clip=N[2]-5+","+(N[1]-50)+","+(N[0]-(N[2]-5))+",100",console.log("clip:"+clip),B=r.path(svgArcBezie(S)).attr("stroke-width","2px").attr({"clip-rect":clip}),c.push(B)}else{var S=[[O[0]+w,O[1]+b],[O[0]+w,O[1]-x+b],[N[0],N[1]-x+b],[N[0],N[1]+b]],B=r.path(svgArcBezie(S)).attr("stroke-width","2px");c.push(B)}}rs_prev_has_tie=f.tie,rs_prev_coord=[g,_,a,n],rs_prev_tie_paper=r}}}return u?c:null}function init_render_global(){g_prev_chord_has_tie=!1}function new_row_yinfo(){var e={maxheaerheight:0,maxbodyheight:0,maxfooterheight:0,maxheight:0};return e}function render_measure_row(e,r,t,a,n,o,s,i,h,l,_){var p=raphaelText(e,0,0,"C7",16,"lc","icomoon"),u=p.getBBox().width;p.remove();var c=!1,d=!1;"ON"==_&&(c=!0);for(var f=0;f<n.length;++f)for(var g=n[f],m=0;m<g.elements.length;++m){var v=g.elements[m];v instanceof Coda||v instanceof Segno?d=!0:v instanceof Chord&&(c|=null!==v.length_s)}"OFF"==_&&(c=!1);for(var k=c?h.row_height+5:0,y=d?h.mh_area_height:0,T=i+y,E=[],b=x,w=x,f=0;f<n.length;++f){for(var g=n[f],O=x,N=x,S=x,B=classifyElements(g),R=0,L=!1,m=0;m<B.header.length;++m){var v=B.header[m];v instanceof Coda?(L=!0,l&&draw_coda(e,O,i,"lt",v)):v instanceof Segno&&(L=!0,l&&draw_segno(e,O,i+3,v))}L&&(R+=h.mh_area_height);for(var m=0;m<B.header.length;++m){var v=B.header[m];if(v instanceof MeasureBoundary){var M=0==f?o:n[f-1],C=M?M.elements[M.elements.length-1]:null,I=draw_boundary("begin",C,v,g.new_line,e,x,T+k,h,l);x=I.x,N=I.bx}else if(v instanceof Time){x+=4;var A=0,K=x,D=raphaelText(e,K,T+k,v.numer,12,"lt","icomoon");A=D.getBBox().width;var P=raphaelText(e,K,T+h.row_height/2+k,v.denom,12,"lt","icomoon");A=Math.max(A,P.getBBox().width),D.attr({x:D.attr("x")+(A-D.getBBox().width)/2}),P.attr({x:P.attr("x")+(A-P.getBBox().width)/2});var F=T+h.row_height/2;l&&!c&&e.path(svgLine(K,F,K+A,F)).attr({"stroke-width":"1"}),x+=A}}x+=10,g.header_width=x-O;for(var G=x,H=0,W=!0,q=0,z=[],m=0;m<B.body.length;++m){var v=B.body[m];(v instanceof Chord||v instanceof Rest)&&(++H,W&=null!==v.length,W&&(q+=v.length),z.push(v))}for(var U=null,m=0;m<B.body.length;++m){var v=B.body[m],j=0;if(j=W?Math.floor(40*r/q*v.length):Math.floor(40*r/H),v instanceof Chord){var p,$=render_chord(v,t,a,e,x,T,h,l,j,r,g.body_scaling);x=$.x,isFinite(x)||console.log("Illegal calculation of x is detected"),(g_prev_chord_has_tie||U==v.chord_name_str)&&$.group.remove(),g_prev_chord_has_tie=v.tie,U=v.chord_name_str}else{if(!(v instanceof Rest))throw"ERROR";var Q={1:"",2:"",4:"",8:"",16:"",32:""},Y={1:0,2:0,4:0,8:0,16:7,32:7,64:14,128:14},X=parseInt(v.length_s),V=e.set(),J=Y[X],Z=14;if(4>=X){var p=raphaelText(e,x,T+h.row_height/2+k,Q[X],Z,"lc","icomoon");V.push(p)}else for(var ee=myLog2(X)-2,re=2,te=-7,ae=0;ee>ae;++ae){var p=raphaelText(e,x+ae*re,T+h.row_height/2+k+ae*te+J,"",Z,"lc","icomoon");V.push(p)}x+=u*r*g.body_scaling,x+=j*g.body_scaling,v.renderprop.x=x,l||V.remove()}}0==B.body.length&&(x+=u*r*g.body_scaling,x+=40*r*g.body_scaling),g.body_width=x-G;for(var ne=x,m=0;m<B.footer.length;++m){var oe=c?"l":"r",v=B.footer[m];if(v instanceof MeasureBoundary){var se=f==n.length-1?s:n[f+1],C=se?se.elements[0]:null,I=draw_boundary("end",v,C,se?se.new_line:!1,e,x,T+k,h,l);x=I.x}else if(v instanceof DaCapo)p=raphaelText(e,x,T-8+k,v.toString(),15,oe+"c").attr(h.repeat_mark_font),c&&(x+=p.getBBox().width);else if(v instanceof DalSegno)p=raphaelText(e,x,T-8+k,v.toString(),15,oe+"c").attr(h.repeat_mark_font),c&&(x+=p.getBBox().width);else if(v instanceof ToCoda)if(c){var p=raphaelText(e,x,T+k,"To",15,"lb").attr(h.repeat_mark_font);x+=p.getBBox().width+5;var ie=draw_coda(e,x,T+k,"lb",v);x+=ie.getBBox().width}else{var ie=draw_coda(e,x,T+k,"rb",v);p=raphaelText(e,x-1.5*ie.getBBox().width,T+k,"To",15,"rb").attr(h.repeat_mark_font)}else{if(!(v instanceof Fine))throw"ERROR";p=raphaelText(e,x,T-8+k,v.toString(),15,oe+"c").attr(h.repeat_mark_font),c&&(x+=p.getBBox().width)}}g.footer_width=x-ne,S=x,w=S;for(var m=0;m<B.measure_wide.length;++m){var v=B.measure_wide[m];if(!(v instanceof LoopIndicator))throw"ERROR";var J=10,F=T-2-J,he=N,le=S;l&&e.path(svgLine(he,F,he,F+J)).attr({"stroke-width":"1"}),l&&e.path(svgLine(he,F,le,F)).attr({"stroke-width":"1"});var _e=v.indicators.join(",");l&&raphaelText(e,he+2,F,_e,10,"lt")}if(R+=h.row_height,c){var te=10,pe=render_rhythm_slash(z,e,T+te,N,S,h,l,0,g.body_scaling,W);R+=h.rs_area_height,pe||render_empty_rythm_slash(e,G,T+te,g.body_width,4,h,g.body_scaling)}R+=h.row_margin,g.renderprop.meas_height=R,E.push(R)}if(c)for(var ue=0;5>ue;++ue){var ce=6,de=5;l&&e.path(svgLine([[b,T+h.row_height+ue*ce+de],[w,T+h.row_height+ue*ce+de]])).attr({"stroke-width":"1px"})}return i+=Math.max.apply(null,E),{y_base:i}}function getGlobalMacros(e){var r={};if(r.x_global_scale=1,"XSCALE"in e.macros&&(r.x_global_scale=parseFloat(e.macros.XSCALE)),r.transpose=0,"TRANSPOSE"in e.macros){var t=parseInt(e.macros.TRANSPOSE);isNaN(t)||(r.transpose=t)}return r.half_type="GUESS","HALF_TYPE"in e.macros&&(r.half_type=e.macros.HALF_TYPE),r.staff="AUTO","STAFF"in e.macros&&(r.staff=e.macros.STAFF),r}function getMacros(e,r){var t=$.extend(!0,{},e);if("XSCALE"in r.macros&&(t.x_global_scale=parseFloat(r.macros.XSCALE)),"TRANSPOSE"in r.macros){var a=parseInt(r.macros.TRANSPOSE);isNaN(a)||(t.transpose=a)}return"HALF_TYPE"in r.macros&&(t.half_type=r.macros.HALF_TYPE),"STAFF"in r.macros&&(t.staff=r.macros.STAFF),t}function render_impl(e,r,t,a,n,o){var s=!t;console.log("render_impl called with "+s);var i=a.y_title_offset,h=a.x_offset,l=a.paper_width-2*h,_=null;_=s?makeNewPaper(e,a):Raphael($("#invisible_view")[0],a.paper_width,a.paper_height);var p=a.y_first_page_offset,u="No Name";"TITLE"in r.macros&&(s&&raphaelText(_,h+l/2,i,r.macros.TITLE,24,"ct"),u=r.macros.TITLE),"ARTIST"in r.macros&&(s&&raphaelText(_,h+l,a.y_author_offset,r.macros.ARTIST,14,"rt"),u+="/"+r.macros.ARTIST);var c=getGlobalMacros(r);console.log("render_impl called with "+s+" : Making pagination");var d=[];if(s){for(var f=[{type:"titles",height:a.y_first_page_offset}],g=0;g<r.reharsal_groups.length;++g){var m=getMacros(c,r.reharsal_groups[g]);console.group("Macro for "+r.reharsal_groups[g].name),console.log(m),console.groupEnd(),f.push({type:"reharsal",height:a.rm_area_height,cont:r.reharsal_groups[g]});for(var v=r.reharsal_groups[g],k=0,y=[],T=null,E=0;E<v.measures.length;++E){var b=v.measures[E];b.new_line&&(f.push({type:"meas",height:k,cont:y,nm:b,pm:T,rg:r.reharsal_groups[g],macros:m}),k=0,y=[],T=E>0?v.measures[E-1]:null),y.push(b),k=Math.max(k,b.renderprop.meas_height)}k>0&&f.push({type:"meas",height:k,cont:y,nm:null,pm:T,rg:r.reharsal_groups[g],macros:m})}for(var w=0,O=[],g=0;g<f.length;++g)w+f[g].height<=a.paper_height-a.y_offset?(w+=f[g].height,O.push(f[g])):(d.push(O),O=[f[g]],w=f[g].height);O.length>0&&d.push(O),console.log("////////"),console.log(d)}else{for(var f=[{type:"titles",height:h}],g=0;g<r.reharsal_groups.length;++g){var m=getMacros(c,r.reharsal_groups[g]);f.push({type:"reharsal",height:a.rm_area_height,cont:r.reharsal_groups[g]});var v=r.reharsal_groups[g];f.push({type:"meas",height:0,cont:v.measures,nm:null,pm:null,rg:r.reharsal_groups[g],macros:m})}d.push(f)}if(console.log("render_impl called with "+s+" : Invoke async loop execution"),n){Task.Foreach(d,function(r,t,a,n){Task.Foreach(a,function(e,t,a,n){if(o&&o((n.draw?"":"Pre-")+"Rendering block "+e+" in page "+(r+1)+" of "+u),"titles"==a.type);else if("reharsal"==a.type){x=h;var s=a.cont;if(n.draw){raphaelTextWithBox(n.paper,x,n.y_base,s.name,18)}n.y_base+=n.param.rm_area_height}else if("meas"==a.type){x=h;var i=a.cont,l=render_measure_row(n.paper,a.macros.x_global_scale,a.macros.transpose,a.macros.half_type,i,a.pm,a.nm,n.y_base,n.param,n.draw,a.macros.staff);n.y_base=l.y_base}},n,"renderpageelemloop");var s=Task.enqueueFunctionCall(function(){n.draw&&r!=d.length-1&&(n.paper=makeNewPaper(e,n.param),n.y_base=n.param.y_offset)},[],"renderpageelemloop");return s},{param:a,draw:s,paper:_,y_base:p},"renderpageloop");var N=Task.enqueueFunctionCall(function(){s||$("#invisible_view").children().remove()},[],"renderpageloop");return N}for(var S=0;S<d.length;++S){for(var B=d[S],R=0;R<B.length;++R)if("titles"==B[R].type);else if("reharsal"==B[R].type){x=h;var v=B[R].cont;if(s){raphaelTextWithBox(_,x,p,v.name,18)}p+=a.rm_area_height}else if("meas"==B[R].type){x=h;var L=B[R].cont,M=render_measure_row(_,B[R].macros.x_global_scale,B[R].macros.transpose,B[R].macros.half_type,L,B[R].pm,B[R].nm,p,a,s,B[R].macros.staff);p=M.y_base}s&&S!=d.length-1&&(_=makeNewPaper(e,a),p=a.y_offset)}s||$("#invisible_view").children().remove()}function draw_segno(e,r,t,a){var n=e,o=n.path("m 7.45119,0.00462507 c -2.62006,-0.12965 -4.89531,2.48917003 -4.5203,5.06077003 0.30852,2.3265 2.16735,4.12974 4.20376,5.1011599 1.65879,0.86938 3.71404,0.71264 5.22694,1.90481 1.39044,1.02552 1.92776,3.15917 0.89399,4.61515 -0.59006,0.8633 -1.60565,1.57525 -2.69669,1.40546 -0.51026,-0.79781 -0.0548,-1.84761 -0.5841,-2.65244 -0.50017,-0.97685 -1.7314,-1.52668 -2.77051,-1.09339 -1.09273,0.36861 -1.55201,1.78786 -0.96315,2.76184 0.95747,1.95409 3.44952,2.65453 5.45383,2.15374 2.52866,-0.60348 4.08162,-3.66205 3.0424,-6.05383 -0.87324,-2.27646 -3.05164,-3.8349199 -5.33435,-4.4943599 -1.63211,-0.39445 -3.53265,-0.67749 -4.56541,-2.16526 -0.96216,-1.25884 -0.91035,-3.20529 0.26205,-4.31632 0.58015,-0.61405 1.43392,-1.05559 2.29618,-0.91468 0.51027,0.79781 0.0548,1.84762 0.5841,2.65244 0.50017,0.97686 1.7314,1.52668 2.77051,1.09339 1.0378,-0.35178 1.53161,-1.67674 1.0195,-2.63799 C 11.07123,0.77410507 9.16303,-0.05833493 7.45119,0.00462507 z");o.attr({id:"path3001","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"50",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3001");var s=n.path("m 15.97079,8.1489251 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");s.attr({id:"path3807",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3807");var i=n.path("m 3.38842,11.049785 c 0.005,0.3706 -0.23305,0.72802 -0.57561,0.8684 -0.33653,0.14657 -0.75456,0.0707 -1.01709,-0.18618 -0.26603,-0.24718 -0.3631,-0.65442 -0.23893,-0.99541 0.12006,-0.35345 0.46727,-0.61404 0.84067,-0.62804 0.36299,-0.0235 0.72582,0.18693 0.88786,0.51217 0.0679,0.13213 0.10333,0.28054 0.1031,0.42906 z");i.attr({id:"path3822",fill:"#000000",stroke:"#000000","stroke-width":"0","stroke-linecap":"round","stroke-miterlimit":"4","stroke-opacity":"1","stroke-dasharray":"none"}).data("id","path3822");var h=n.path("M 15.69138,2.8164551 C 10.46092,7.2657851 5.23046,11.715125 0,16.164455 c 0.68845,-0.002 1.37691,-0.003 2.06536,-0.005 5.21598,-4.44988 10.43195,-8.8997599 15.64793,-13.3496399 -0.67397,0.002 -1.34794,0.004 -2.02191,0.007 z");h.attr({id:"path3803","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"49.9",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3803");var l=n.set();l.push(o,s,i,h);var _=l.getBBox().height;return null!==a.number&&l.push(raphaelText(e,l.getBBox().width,_+4,a.number,20,"lb")),null!==a.opt&&l.push(raphaelText(e,l.getBBox().width,_+3,"("+a.opt+")",16,"lb")),l.transform("t"+r+","+t),l}function draw_coda(e,r,t,a,n){var o=e,s=o.path("m 7.36,1.9518304 c -3.1472,0 -5.51238,3.23098 -5.51238,6.97709 0,3.7461196 2.36518,6.9770896 5.51238,6.9770896 3.1472,0 5.51238,-3.23097 5.51238,-6.9770896 0,-3.74611 -2.36518,-6.97709 -5.51238,-6.97709 z m 0,0.84817 c 1.97338,0 3.75892,3.18901 3.75892,6.12892 0,2.9399196 -1.78554,6.1289296 -3.75892,6.1289296 -1.97338,0 -3.75892,-3.18901 -3.75892,-6.1289296 0,-2.93991 1.78554,-6.12892 3.75892,-6.12892 z");s.attr({id:"path3878","font-size":"medium","font-style":"normal","font-variant":"normal","font-weight":"normal","font-stretch":"normal","text-indent":"0","text-align":"start","text-decoration":"none","line-height":"normal","letter-spacing":"normal","word-spacing":"normal","text-transform":"none",direction:"ltr","block-progression":"tb","writing-mode":"lr-tb","text-anchor":"start","baseline-shift":"baseline",color:"#000000",fill:"#000000","fill-opacity":"1",stroke:"none","stroke-width":"1","stroke-opacity":"1","stroke-width":"72.4",marker:"none",visibility:"visible",display:"inline",overflow:"visible","enable-background":"accumulate","font-family":"Sans","-inkscape-font-specification":"Sans"}).data("id","path3878");var i=o.path("m 7.2,3.814697e-7 -3.6,0 0,0.7999999985303 3.2,0.40000002 0,7.6 1.2,0 0,-7.6 3.2,-0.40000002 0,-0.7999999985303 z");i.attr({id:"path4413",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4413");var h=o.path("m 7.6,17.6 3.6,0 0,-0.8 -3.2,-0.4 0,-7.5999996 -1.2,0 0,7.5999996 -3.2,0.4 0,0.8 z");h.attr({id:"path4415",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4415");var l=o.path("m 14.8,8.8000004 0,-3.6 -0.8,0 -0.4,3.2 -7.6,0 0,1.2 7.6,0 L 14,12.8 l 0.8,0 z");l.attr({id:"path4417",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4417");var _=o.path("M 0,9.2000004 0,12.8 l 0.8,0 0.4,-3.1999996 7.6,0 0,-1.2 -7.6,0 -0.4,-3.2 -0.8,0 z");_.attr({id:"path4419",fill:"#000000",stroke:"none","stroke-width":"1","stroke-opacity":"1"}).data("id","path4419");var p=o.set();if(p.push(s,i,h,l,_),null!==n.number&&p.push(raphaelText(e,p.getBBox().width,p.getBBox().height+4,n.number,20,"lb")),void 0!==a&&null!==a){var u="l"==a[0]?0:"c"==a[0]?.5:1;r-=u*p.getBBox().width;var c="t"==a[1]?0:"m"==a[1]?.5:1;t-=c*p.getBBox().height}return p.transform("t"+r+","+(t-2)),p}var pages=new Array,RENDERING_RULE_BOUNDARY=new Array,inherits=function(e,r){var t=function(){};t.prototype=r.prototype,e.prototype=new t,e.prototype.constructor=e},the_task_queue=new TaskQueue;TaskQueue.prototype.enqueue=function(e){null!==e.task_type?(e.task_type in this.task_queue||(this.task_queue[e.task_type]=[]),this.task_queue[e.task_type].push(e),console.log("Enqueue task for queue '"+e.task_type+"'. Size = "+this.task_queue[e.task_type].length),1==this.task_queue[e.task_type].length&&setTimeout(e.run.bind(e),0)):setTimeout(e.run.bind(e),0)},TaskQueue.prototype.finish=function(e){if(null!==e.task_type)if(e.task_type in this.task_queue&&0!=this.task_queue[e.task_type].length&&this.task_queue[e.task_type][0]==e){
var r=this.task_queue[e.task_type];r.shift(),console.log("Dequeue task for queue '"+e.task_type+"'. Size = "+r.length),r.length>0&&r[0].run()}else alert("Invalid task execution state detected")},Task.prototype.then=function(e){return this.promise.then(e)},Task.prototype.run=function(){var e=this.worker(this.context);if(e instanceof Task||e instanceof Promise){var r=this;e.then(function(e){null===r.resolve&&alert("Invalid state detected"),r.resolve(e),setTimeout(r.queue.finish.bind(r.queue,r),1)})}else null===this.resolve&&alert("Invalid state detected"),this.resolve(e),setTimeout(this.queue.finish.bind(this.queue,this),1)},Task.enqueueFunctionCall=function(e,r,t){return new Task({func:e,arguments:r,i:0,func_ret:void 0},function(e){return e.i>0?!0:(ret=e.func.apply(null,e.arguments),e.func_ret=ret,void 0===ret&&(ret=!0),++e.i,ret)},t)},Task._ForeachWorker=function(e){var r=new TaskQueue;new Task(e,function(e){return e.worker(e.loopindex,e.looptarget.length,e.looptarget[e.loopindex],e.context)},0,r);var t=new Task(e,function(e){if(e.loopindex==e.looptarget.length-1)return e.context;var r=shallowcopy(e);return r.loopindex++,new Task(r,Task._ForeachWorker,null)},0,r);return t},Task.Foreach=function(e,r,t,a){var n={};n.worker=r,n.context=t,n.looptarget=e,n.loopindex=0;var o=new Task(n,Task._ForeachWorker,a);return o};var WHOLE_NOTE_LENGTH=17297280,cnrg=new RegExp;cnrg.compile(/^((sus4?)|(add(9|13))|(alt)|(dim)|(7|9|6|11|13)|((\+|\#)(5|9|13|11))|((\-|b)(5|9|13))|([Mm]([Aa][Jj]?|[Ii][Nn]?)?)|([\,\(\)]))/);var CS_IDX_OFFSET=2,CS_SUS=0,CS_ADD=1,CS_ADD_DIG=2,CS_ALT=3,CS_DIM=4,CS_DIG=5,CS_PLS=6,CS_PLS_SYM=7,CS_PLS_DIG=8,CS_MNS=9,CS_MNS_SYM=10,CS_MNS_DIG=11,CS_M=12,CS_M_TAIL=13,CS_SEP=14,NUM_CS=15,CS_LIST=[CS_M,CS_DIG,CS_SUS,CS_DIM,CS_SEP,CS_PLS,CS_MNS,CS_ADD,CS_ALT];Chord.getTranpsoedNote=function(e,r,t,a){var n=[["A"],["A#","Bb"],["B","Cb"],["C"],["C#","Db"],["D"],["D#","Eb"],["E","Fb"],["F"],["F#","Gb"],["G"],["G#","Ab"]],o=t;if(void 0!==a&&(o+=a),0==e)return o;var s=0;for(s=0;s<n.length&&!(n[s].indexOf(o)>=0);++s);for(var i=s+e;0>i;)i+=12;var h=n[i%12];if(1==h.length)return h[0];switch(r){case"GUESS":return a&&"#"==a?h[0]:h[1];case"SHARP":return h[0];case"FLAT":return h[1]}return null},Chord.prototype.getChordStrBase=function(e,r){if(!this.is_valid_chord)return[!1,this.chord_str];var t=null;void 0!==this.note_base&&(t=Chord.getTranpsoedNote(e,r,this.note_base,this.sharp_flat));var a=null;return void 0!==this.base_note_base&&(a=Chord.getTranpsoedNote(e,r,this.base_note_base,this.base_sharp_flat)),[t,a]},Chord.prototype.getChordStr=function(e,r){if(!this.is_valid_chord)return[!1,this.chord_str];var t=null;void 0!==this.note_base&&(t=Chord.getTranpsoedNote(e,r,this.note_base,this.sharp_flat));var a=null;void 0!==this.base_note_base&&(a=Chord.getTranpsoedNote(e,r,this.base_note_base,this.base_sharp_flat));var n="";if(null!==this.mid_elems)for(var o=0;o<this.mid_elems.length;++o)switch(this.mid_elems[o].cs){case CS_M:var s=this.mid_elems[o].s,i="M"==s||"maj"==s.toLowerCase()||"ma"==s.toLowerCase();n+=i?"M":"m";break;case CS_DIG:var h={11:"%",13:"&"};n+=this.mid_elems[o].s in h?h[this.mid_elems[o].s]:this.mid_elems[o].s;break;case CS_SUS:n+="s"+this.mid_elems[o].s.substr(3);break;case CS_DIM:n+="d";break;case CS_MNS:n+="b"+this.mid_elems[o].s.substr(1);break;case CS_PLS:n+="#"+this.mid_elems[o].s.substr(1);break;case CS_ADD:n+="a"+this.mid_elems[o].s.substr(3);break;case CS_ALT:n+=this.mid_elems[o].s;break;case CS_SEP:n+=this.mid_elems[o].s}var l=(t?t+n:"")+(a?"/"+a:"");return[!0,l]};var inherits=function(e,r){var t=function(){};t.prototype=r.prototype,e.prototype=new t,e.prototype.constructor=e};inherits(MeasureBoundaryMark,MeasureBoundary),inherits(LoopBeginMark,MeasureBoundary),inherits(LoopEndMark,MeasureBoundary),inherits(LoopBothMark,MeasureBoundary),inherits(MeasureBoundaryFinMark,MeasureBoundary),DaCapo.prototype.toString=function(){return"D.C."},DalSegno.prototype.toString=function(){var e="D.S."+(null===this.number?"":this.number),r=null===this.al?"":" al "+this.al.toString();return e+r},Coda.prototype.toString=function(){return"Coda"+(null===this.number?"":this.number)},Fine.prototype.toString=function(){return"Fine"};var TOKEN_INVALID=-1,TOKEN_END=0,TOKEN_WORD=1,TOKEN_ASIS=2,TOKEN_BRACKET_LR=3,TOKEN_BRACKET_RR=4,TOKEN_BRACKET_LS=5,TOKEN_BRACKET_RS=6,TOKEN_BRACKET_LA=7,TOKEN_BRACKET_RA=8,TOKEN_MB=14,TOKEN_MB_DBL=15,TOKEN_MB_LOOP_BEGIN=16,TOKEN_MB_LOOP_END=17,TOKEN_MB_LOOP_BOTH=18,TOKEN_MB_FIN=19,TOKEN_COMMA=20,TOKEN_SLASH=21,TOKEN_NL=22,TOKEN_PERCENT=23,TOKEN_EQUAL=24,TOKEN_STRING=25,WORD_DEFINIITON_GENERAL=/^(\w[\w\.\,\-\+\#\:]*)/,WORD_DEFINITION_IN_REHARSAL_MARK=/^[^\[\]]*/,WORD_DEFINITION_CHORD_SYMBOL=/^[\w\.\,\-\+\#\/\(\)\:\~]*/;Parser.prototype.onParseError=function(e){var r="Parse error on Line "+this.context.line+" : "+e;throw console.log(r),console.trace(),this.error_msg_callback?this.error_msg_callback(r):alert(r),"Parse error"},Parser.prototype.nextToken=function(e,r){word_def=WORD_DEFINIITON_GENERAL;var t=0;if(r!==!0)for(;e.length>0&&charIsIn(e[0]," 	");)e=e.substr(1),++t;if(0==e.length)return{token:null,s:e,type:TOKEN_END,ss:t};if('"'==e[0]||"'"==e[0]){var a=e[0],n="";for(e=e.substr(1);e.length>0&&e[0]!=a;)n+=e[0],e=e.substr(1);var o=e.length>0&&e[0]==a;return o||this.onParseError("ERROR_WHILE_PARSING_PLAIN_STRING"),e=e.substr(1),{token:n,s:e,type:TOKEN_STRING,ss:t}}var s=charIsIn(e[0],"[]<>(),\n/%=");if(null!=s)return{token:e[0],s:e.substr(1),ss:t,type:[TOKEN_BRACKET_LS,TOKEN_BRACKET_RS,TOKEN_BRACKET_LA,TOKEN_BRACKET_RA,TOKEN_BRACKET_LR,TOKEN_BRACKET_RR,TOKEN_COMMA,TOKEN_NL,TOKEN_SLASH,TOKEN_PERCENT,TOKEN_EQUAL][s.index]};var s=charStartsWithAmong(e,["||:","||.","||","|"]);if(null!=s)return{token:s.s,s:e.substr(s.s.length),ss:t,type:[TOKEN_MB_LOOP_BEGIN,TOKEN_MB_FIN,TOKEN_MB_DBL,TOKEN_MB][s.index]};var i=null;if(i=e.match(/^(\:\|\|\:?)(x(\d+))?/),null!=i){var h=2;return null!=i[2]&&(h=Number(i[3])),{token:i[0],s:e.substr(i[0].length),ss:t,type:":||:"==i[1]?TOKEN_MB_LOOP_BOTH:TOKEN_MB_LOOP_END,param:h}}if(i=e.match(word_def),null!=i){var l=i[0];return{token:l,s:e.substr(l.length),type:TOKEN_WORD,ss:t}}throw"INVALID_TOKEN_DETECTED"},Parser.prototype.parseGroup=function(e,r,t){for(var a=new Array,n=0;n<e.length;++n){for(var o=e[n][1],s=e[n][0],i=new Array,h=!0;h;){var l=this.nextToken(r);switch(o){case"":l.type!=s&&this.onParseError(t),i.push(l.token),r=l.s,h=!1;break;case"*":if(l.type!=s){h=!1;break}i.push(l.token),r=l.s;break;case"+":if(l.type!=s){if(0!=i.length){loop_flag=!1;break}this.onParseError(t)}i.push(l.token),r=l.s;break;case"?":if(l.type!=s)break;i.push(l.token),r=l.s;break;default:throw"ASSERTION ERROR"}}a.push(i)}return{tokens:a,s:r}},Parser.prototype.parseReharsalMark=function(e,r){if(m=r.match(WORD_DEFINITION_IN_REHARSAL_MARK),null!=m){reharsalMarkName=m[0];var t=this.nextToken(r.substr(m[0].length));if(t.type==TOKEN_BRACKET_RS)return{reharsalMarkName:reharsalMarkName,s:t.s}}throw"Invalid reharsal mark"},Parser.prototype.parseLoopIndicator=function(e,r){for(var t=!0,a=new Array;t;){var n=this.nextToken(r);if(n.type!=TOKEN_WORD&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR"),a.push(n.token),r=n.s,n=this.nextToken(r),r=n.s,n.type==TOKEN_BRACKET_RS)break;n.type!=TOKEN_COMMA&&this.onParseError("ERROR_WHILE_PARSE_LOOP_INDICATOR")}return{loopIndicator:new LoopIndicator(a),s:r}},Parser.prototype.parseTime=function(e,r){var t=0,a=0,n=this.nextToken(r);return r=n.s,n.type!=TOKEN_WORD&&this.onParseError("ERROR_WHILE_PARSE_TIME"),t=n.token,n=this.nextToken(r),r=n.s,n.type!=TOKEN_SLASH&&this.onParseError("ERROR_WHILE_PARSE_TIME"),n=this.nextToken(r),r=n.s,n.type!=TOKEN_WORD&&this.onParseError("ERROR_WHILE_PARSE_TIME"),a=n.token,n=this.nextToken(r),r=n.s,n.type!=TOKEN_BRACKET_RR&&this.onParseError("ERROR_WHILE_PARSE_TIME"),{time:new Time(t,a),s:r}},Parser.prototype.parseSign=function(e,r){var t=r.indexOf(">");if(0>t)throw"Parse error on Sign";var a=r.slice(0,t);r=r.slice(t+1);var n=this.nextToken(a,WORD_DEFINIITON_GENERAL);if(n.type!=TOKEN_WORD)throw"Error";regDS=/D\.S\.([0-9]+)?/,regCoda=/Coda([0-9]+)?/,regSegno=/S(egno)?([0-9]+)?$/;var o=null;if("Fine"==n.token)sign=new Fine;else if("D.C."==n.token)sign=new DaCapo;else if(null!==(o=n.token.match(regCoda)))sign=new Coda(void 0===o[1]?null:o[1]);else if(null!==(o=n.token.match(regSegno))){var s=n.s.match(/^\s*(straight|((with\s+)repeat))/);console.log(n.s+"/"+a+s),sign=new Segno(void 0===o[2]?null:o[2],s?s[1]:null)}else if("to"==n.token){if(n=this.nextToken(n.s,WORD_DEFINIITON_GENERAL),n.type!=TOKEN_WORD)throw"Error";if(o=n.token.match(regCoda),null===o)throw"Error";sign=new ToCoda(void 0===o[1]?null:o[1])}else{if(null===(o=n.token.match(regDS)))throw"Error";var i=void 0===o[1]?null:o[1],h=null;if(n=this.nextToken(n.s,WORD_DEFINIITON_GENERAL),n.type==TOKEN_END);else{if(n.type!=TOKEN_WORD)throw"Error";if("al"!=n.token)throw"Error";if(n=this.nextToken(n.s,WORD_DEFINIITON_GENERAL),n.type!=TOKEN_WORD)throw"Error";if("Fine"==n.token)h=new Fine;else{if(null===(o=n.token.match(regCoda)))throw"Error";h=new Coda(void 0===o[1]?null:o[1])}}sign=new DalSegno(i,h)}return{sign:sign,s:r}},Parser.prototype.parseChordSymbol=function(e,r,t){chord_symbol=e;var a=t.match(WORD_DEFINITION_CHORD_SYMBOL);a&&(chord_symbol+=a[0],t=t.substr(a[0].length));var n=new Chord(chord_symbol);return{s:t,chord:n}},Parser.prototype.parseRest=function(e,r,t){var a=/^r\:(1|2|4|8|16|32|64)(\.*)$/,n=e.match(a),o=null;return n&&(o=new Rest(parseInt(n[1]),n[2])),{s:t,rest:o}},Parser.prototype.parseMeasure=function(e,r){var t=new Measure;e.type==TOKEN_MB?t.elements.push(new MeasureBoundaryMark(1)):e.type==TOKEN_MB_DBL?t.elements.push(new MeasureBoundaryMark(2)):e.type==TOKEN_MB_LOOP_END?t.elements.push(new LoopEndMark(e.param)):e.type==TOKEN_MB_LOOP_BEGIN?t.elements.push(new LoopBeginMark):e.type==TOKEN_MB_LOOP_BOTH?t.elements.push(new LoopBothMark(e.param)):e.type==TOKEN_MB_FIN&&t.elements.push(new MeasureBoundaryFinMark);for(var a=!0;a;){var n=this.nextToken(r);switch(n.type){case TOKEN_STRING:t.elements.push(new Chord(n.token)),r=n.s;break;case TOKEN_WORD:var o=this.parseRest(n.token,n.type,n.s);if(null!==o.rest){t.elements.push(o.rest),r=o.s;break}case TOKEN_SLASH:var n=this.parseChordSymbol(n.token,n.type,n.s);t.elements.push(n.chord),r=n.s;break;case TOKEN_BRACKET_LA:var n=this.parseSign(n.type,n.s);t.elements.push(n.sign),r=n.s;break;case TOKEN_BRACKET_LR:var n=this.parseTime(n.type,n.s);t.elements.push(n.time),r=n.s;break;case TOKEN_BRACKET_LS:var n=this.parseLoopIndicator(n.type,n.s);t.elements.push(n.loopIndicator),r=n.s;break;case TOKEN_MB:t.elements.push(new MeasureBoundaryMark(1)),a=!1;break;case TOKEN_MB_DBL:t.elements.push(new MeasureBoundaryMark(2)),a=!1;break;case TOKEN_MB_LOOP_END:t.elements.push(new LoopEndMark(n.param)),a=!1;break;case TOKEN_MB_LOOP_BEGIN:t.elements.push(new LoopBeginMark),a=!1;break;case TOKEN_MB_LOOP_BOTH:t.elements.push(new LoopBothMark(n.param)),a=!1;break;case TOKEN_MB_FIN:t.elements.push(new MeasureBoundaryFinMark),a=!1;break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURE")}}return{measure:t,s:r}},Parser.prototype.parseMeasures=function(e,r){for(var t=new Array,a=!0;a;){var n=this.parseMeasure(e,r);switch(r=n.s,t.push(n.measure),n=this.nextToken(r),r=n.s,n.type){case TOKEN_MB:case TOKEN_MB_DBL:case TOKEN_MB_LOOP_BEGIN:case TOKEN_MB_LOOP_END:case TOKEN_MB_LOOP_BOTH:case TOKEN_MB_FIN:var o=this.nextToken(r);switch(o.type){case TOKEN_NL:a=!1;break;case TOKEN_END:a=!1;break;default:e=n}break;default:this.onParseError("ERROR_WHILE_PARSE_MEASURES")}}return{measures:t,s:r}},Parser.prototype.parseMacro=function(e){var r=null,t=null,a=this.nextToken(e);a.type!=TOKEN_WORD&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),r=a.token,e=a.s;var a=this.nextToken(e);a.type!=TOKEN_EQUAL&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=a.s;var a=this.nextToken(e);return a.type!=TOKEN_STRING&&this.onParseError("ERROR_WHILE_PARSE_MACRO"),e=a.s,t=a.token,{key:r,value:t,s:e}},Parser.prototype.glanceHeader=function(e){for(var r=["TITLE","ARTIST"],t={},a=e.split("\n"),n=0;n<a.length;++n)if(a[n].length>0&&"%"==a[n][0]){var o=this.parseMacro(a[n].substr(1));if(r.indexOf(o.key)>=0&&(t[o.key]=o.value),t.length==r.length)break}return t},Parser.prototype.parse=function(e){e.replace(/\r\n/g,"\n"),e.replace(/\r/g,"\n");for(var r=null,t=0,a=new Track,n=null;;){if(r=this.nextToken(e),r.type==TOKEN_END)break;if(r.type==TOKEN_BRACKET_LS?(r=this.parseReharsalMark(r.token,r.s),null!=n&&a.reharsal_groups.push(n),n=new ReharsalGroup,n.name=r.reharsalMarkName):[TOKEN_MB,TOKEN_MB_DBL,TOKEN_MB_LOOP_BEGIN,TOKEN_MB_LOOP_BOTH,TOKEN_MB_FIN].indexOf(r.type)>=0?(r=this.parseMeasures(r,r.s),n.measures=n.measures.concat(r.measures)):r.type==TOKEN_PERCENT?(r=this.parseMacro(r.s),n?n.macros[r.key]=r.value:a.macros[r.key]=r.value):r.type==TOKEN_NL?this.context.line+=1:(console.log(r.token),this.onParseError("ERROR_WHILE_PARSE_MOST_OUTSIDER")),e=r.s,t++,t>=1e3)break}null!=n&&(a.reharsal_groups.push(n),n=null);for(var o={},s=0;s<a.reharsal_groups.length;++s){var i=a.reharsal_groups[s];i.name in o?a.reharsal_groups[s]=$.extend(!0,{},o[i.name]):o[i.name]=i}return a};var ChordRenderBuffer={},_3rd_global_dy=0,_3rd_font_profile={M:function(e){return[[16,-7,"M"]]},m:function(e){return[[16,-7,"m"]]}},_6791113_global_dy=0,_6791113_font_profile={dim:function(e){return[[16,-7,"d"]]},sus:function(e){return[[18,-9,"s"],[13,-2,e?e:""]]},M:function(e){return[[16,-7,"M"],[13,-2,e?e:""]]},m:function(e){return[[16,-7,"m"]]},add:function(e){return[[20,-10,"a"],[13,-2,e?e:""]]},dig:function(e){return[[13,-2,e?e:""]]}},_5th_global_dy=0,_5th_font_profile={"#":function(e){return[[13,-2,"+"],[13,-2,e]]},b:function(e){return[[13,-2,"-"],[13,-2,e]]},dig:function(e){return[[13,-2,e]]}},_altered_global_dy=0,_altered_font_profile={"#":function(e){return[[13,-2,"#"],[13,-2,e]]},b:function(e){return[[13,-2,"b"],[13,-2,e]]},alt:function(e){return[[13,-2,"alt"]]}},rs_prev_coord=null,rs_prev_has_tie=!1,rs_prev_tie_paper=null,g_prev_chord_has_tie=!1;$(document).ready(function(){paper=Raphael($("#invisible_view")[0],500,500);raphaelText(paper,100,100,"ABCDEFG#b123456789dsMm",16,"lt","icomoon")});