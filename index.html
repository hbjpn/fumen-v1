<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<script type="text/javascript"
	src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
<script type="text/javascript" src="fumen.js"></script>
<link rel="stylesheet" href="fumen_font.css">
<style type="text/css">
@media print{
	#form {
		display: none;
	}
}

#score_code {
	font-family: "Courier New", Courier, "Lucida Console", Monaco, monospace;
	font-size: 13px;
	padding: 10px;
}
</style>
<script type="text/javascript">
var dpi = 96; // dot/inch
var A4_width_mm = 210; 
var A4_height_mm = 297;
var mm_inch = 25.4; // mm/inch
var paper_width = dpi * A4_width_mm / mm_inch;
var paper_height = dpi * A4_height_mm / mm_inch;

var timerStart = null;
var tempo_bpm = 60;
var lastindicator = null;

var sequencer = null;
var timerid = null;

function Play()
{
	OnClockStart(sequencer.sequence, 480);
}
function Stop()
{
	if(timerid){
		clearInterval(timerid);
		timerid = null;
		if(lastindicator){ lastindicator.remove(); lastindicator = null; }
	}
}
function OnClockStart(seq, tempo)
{
	timerStart = Date.now();
	tempo_bpm = tempo;
	timerid = setInterval(function(){OnClock(seq);}, 100);
}
function OnClock(seq)
{
	var now = Date.now();
	var diff = now - timerStart; // ms
	var timemark = 4;
	var measure_length = (1.0 / tempo_bpm ) * 60 * 1000 * timemark; // ms
	var cmi = Math.floor(diff / measure_length);
	//console.log("cmi = " + cmi);
	
	if(cmi >= seq.length){
		Stop();
		return;
	}
	
	var m = seq[cmi];
	var sx = m.renderprop.sx;
	var ex = m.renderprop.ex;
	var y = m.renderprop.y;
	console.log([sx,y,ex-sx,30]);
	if(lastindicator){ lastindicator.remove(); lastindicator = null; }
	lastindicator = m.renderprop.paper.rect(sx, y, ex-sx, 30).attr({fill:'red','fill-opacity':0.3,stroke:0});
	var offsetx = m.renderprop.paper.canvas.offsetLeft;
	var offsety = m.renderprop.paper.canvas.offsetTop;
	//console.log("Offset");
	//console.log([offsetx, offsety, offsety+y]);
	//console.log("height = " + $(window).height());
	window.scroll(0, offsety + y - $(window).height()/2);
}

function Generate()
{
	Stop();
	
	var code = $("#score_code").val();
	var async_mode = $('input[name="blocking"]:checked').val() == "non-blocking";
	var showProgress = false;
	
	var p = new Fumen.Parser(function(msg){ console.log(msg); });
	if(async_mode){
		try{
			var track = p.parse(code);
			var renderer = new Fumen.Renderer($("#scorecanvas"), paper_width, paper_height);
			renderer.clear();
			var task = renderer.render(track, async_mode, showProgress);
		}catch(e){
			console.log("Exception catched : " + e);
			alert(e);
			throw e;
			return;
		}

		task.then(function(r){
			
		});
	}else{
		console.log("Rendering ... ");
		setTimeout(function(){
			try{
				var track = p.parse(code);
				var renderer = new Fumen.Renderer($("#scorecanvas"), paper_width, paper_height);
				renderer.clear();
				var task = renderer.render(track, async_mode, showProgress);
				sequencer = new Fumen.Sequencer(track);
			}catch(e){
				console.log("Exception catched : " + e);
				alert(e);
				throw e;
				return;
			}
		}, 100); // Invoke later
	}
}

</script>
<body>
<div id="form">
<div style="font-size:34px; text-align:center;">fumen hosting</div>
<div style="text-align:center;">This is fumen hosting site ! Please see <a href="http://hbjpn.github.io/fumen/" target="_blank">here</a> for fumen markdown.</div>
<textarea id="score_code" style="width:100%; height:400px; ">
%TITLE="Sample Piece"
%ARTIST="Some artists"

[Intro]

| (4/4) <S> C  | CM7 | C7 | Csus | Cm | Cm7 | CmM7 | Cdim | Cm9 | C7+5-9 |

[A]
||: A | B | C | D |
|   F | G | [1.] A | C  :|| [2.] C | D <to Coda>|

[B]
||: C | G :||x4
| (2/4) C | (4/4) G | C | G <D.S. al Coda> |

[C]
| <Coda> F | Fm | F/G | Fm/Ab |

[D]
| A A7 | F#m:2. F7:4~  | F7:2 Bb:8 Bb:8 Bb:4 <Fine> ||.

</textarea>
<hr/>
<input type="radio" name="blocking" value="blocking" checked="checked">Blocking</input>
<input type="radio" name="blocking" value="non-blocking">Non-Blocking</input>
<button onClick="Generate()">Render</button>
<button onClick="Play()">Play</button>
<button onClick="Stop()">Stop</button>
<p>To generate PDF file, please use print feature of your web browser. ( Select "save as pdf" )
<hr/>
</div>
<div style="background-color:gray; padding:10px;">
<div id="scorecanvas"></div>
</div>
<div id="invisible_view" style="opacity: 0;"></div>
</body>
</html>
