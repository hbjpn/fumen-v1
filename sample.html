<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<script type="text/javascript"
	src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
<script type="text/javascript" src="fumen.js"></script>
<link rel="stylesheet" href="fumen_font.css">
<script type="text/javascript">
var dpi = 96; // dot/inch
var A4_width_mm = 210; 
var A4_height_mm = 297;
var mm_inch = 25.4; // mm/inch
var paper_width = dpi * A4_width_mm / mm_inch;
var paper_height = dpi * A4_height_mm / mm_inch;

function Generate()
{
	var code = $("#score_code").val();
	var async_mode = $('input[name="blocking"]:checked').val() == "non-blocking";
	var showProgress = false;
	
	var p = new Parser(function(msg){ console.log(msg); });
	if(async_mode){
		try{
			var track = p.parse(code);
			clearPapers(canvas);
			var task = render(canvas, paper_width, paper_height, track, async_mode, showProgress);
		}catch(e){
			console.log("Exception catched : " + e);
			alert(e);
			throw e;
			return;
		}

		task.then(function(r){
			
		});
	}else{
		console.log("Rendering ... ");
		setTimeout(function(){
			try{
				var track = p.parse(code);
				clearPapers(canvas);
				var task = render(canvas, paper_width, paper_height, track, async_mode, showProgress);
			}catch(e){
				console.log("Exception catched : " + e);
				alert(e);
				throw e;
				return;
			}
		}, 100); // Invoke later
	}
}

function GenerateSetList()
{
	$("#canvas").css({"display":"table-cell", "text-align":"center", "opacity":0.0}); // display it
	$("#canvas").click(function(){
		$(this).css({"display":"none"});
	});
	
	$("#loading").css({"display":"table-cell"});
	showProgress("Rendering setlist ...");
	
	var scores = [];
	var ch = $("#setlist_scores").children("div");
	console.log(ch);
	for(var i = 0; i < ch.length; ++i){
		scores.push($(ch[i]).attr("sid"));
	}
	
	load_multiple_codes(scores, function(codes){
		
		var task = null; 
		clearPapers(canvas);
		for(var i = 0; i < codes.length; ++i){
			var p = new Parser();
			var track = p.parse(codes[i][1]);
			task = render(canvas, paper_width, paper_height, track, showProgress);
		}
		if(g_async_mode){
			task.then(function(r){ // Wait for last task done
				$("#loading").css({"display":"none"});
			});
		}else{
			$("#loading").css({"display":"none"});
		}
		$("#canvas").css({"opacity":1.0});
		
	});
}

</script>
<body>
<div>
<textarea id="score_code" style="width:100%; height: 600px; ">
%TITLE="Sample Piece"
%ARTIST="Some artists"

[Intro]
| F#    |      |       |       |

[A]
||: <S> F#   | B/F#  Bm/F#  | F#   | Bb7   |
| Ebm F#/C#  | Cdim  | G#m  | C#7  :||

[B]
| F#   | Bbm  | B    | Bm   |
| F#   | Bbm  | B    | Bm   |
| D C# B <to Coda> |

[C]
||: F#   |     | G#7    |       |
| Bm   | C#7   |
|[1] B  F#  | D  E  :||
|[2] B F#/A# | C#/G#  | C#/F   | C#     |

[M]
| F#    | F#   <D.S. al Coda> |

[C2]
||: <Coda> F#   |     | G#    |       |
| Bm   | C#7   |
|[1] B  F#  | D  E  :||
|[2] F#  | G#7  | Bm  | C#7,13     |
| F#  | G#7  | Bm  | 
| C#7,13    | Bbm  | C#/G#  |
| D    | E/B   |       | F#   |      | DM7   |
</textarea>
</div>
<hr/>
<input type="radio" name="blocking" value="blocking" checked="checked">Blocking</input>
<input type="radio" name="blocking" value="non-blocking">Non-Blocking</input>
<button onClick="Generate()">Render</button>
<hr/>
<div style="background-color:gray; padding:10px;">
<div id="canvas"></div>
</div>
<div id="invisible_view" style="opacity: 0;"></div>
</body>
</html>
